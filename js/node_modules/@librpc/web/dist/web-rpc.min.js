!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.WebRPC=e()}(this,function(){"use strict";var t=function(){this.events=Object.create(null)};function a(t,e){if(void 0===e&&(e=[]),t instanceof ArrayBuffer)e.push(t);else if(i=t,Object(i)===i)for(var r in t)a(t[r],e);var i;return e}t.prototype.on=function(t,e){var r=this.events[t];return r||(r=[],this.events[t]=r),r.push(e),this},t.prototype.off=function(t,e){var r=this.events[t];if(r){var i=r.indexOf(e);-1!==i&&r.splice(i,1)}return this},t.prototype.emit=function(t,e){var r=this.events[t];if(r)for(var i=0;i<r.length;i++)r[i](e);return this};var e=function(r){function t(t){var e=t.workers;r.call(this),this.workers=[].concat(e),this.idx=0,this.calls={},this.timeouts={},this.errors={},this.handler=this.handler.bind(this),this.catch=this.catch.bind(this),this.init()}return r&&(t.__proto__=r),((t.prototype=Object.create(r&&r.prototype)).constructor=t).prototype.init=function(){this.workers.forEach(this.listen,this)},t.prototype.listen=function(t){t.addEventListener("message",this.handler),t.addEventListener("error",this.catch)},t.prototype.handler=function(t){var e=t.data,r=e.uid,i=e.error,o=e.method,n=e.eventName,s=e.data;i?this.reject(r,i):o?this.resolve(r,s):n&&this.emit(n,s)},t.prototype.catch=function(t){var e=t.message,r=t.lineno,i=t.filename;this.emit("error",{message:e,lineno:r,filename:i})},t.prototype.reject=function(t,e){this.errors[t]&&(this.errors[t](new Error(e)),this.clear(t))},t.prototype.resolve=function(t,e){this.calls[t]&&(this.calls[t](e),this.clear(t))},t.prototype.clear=function(t){clearTimeout(this.timeouts[t]),delete this.timeouts[t],delete this.calls[t],delete this.errors[t]},t.prototype.call=function(r,i,t){var o=this;void 0===t&&(t={});var n=t.timeout;void 0===n&&(n=2e3);var s=Math.floor(1e10*(1+Math.random())).toString(16),h=a(i);return new Promise(function(t,e){o.timeouts[s]=setTimeout(function(){return o.reject(s,'Timeout exceeded for RPC method "'+r+'"')},n),o.calls[s]=t,o.errors[s]=e,o.workers[o.idx].postMessage({method:r,uid:s,data:i},h),o.idx=++o.idx%o.workers.length})},t}(t),r=function(t){this.methods=t,this.listen()};return r.prototype.listen=function(){self.addEventListener("message",this.handler.bind(this))},r.prototype.handler=function(t){var e=this,r=t.data,i=r.method,o=r.uid,n=r.data;this.methods[i]?Promise.resolve(n).then(this.methods[i]).then(function(t){return e.reply(o,i,t)},function(t){return e.throw(o,String(t))}):this.throw(o,'Unknown RPC method "'+i+'"')},r.prototype.reply=function(t,e,r){var i=a(r);self.postMessage({uid:t,method:e,data:r},i)},r.prototype.throw=function(t,e){self.postMessage({uid:t,error:e})},r.prototype.emit=function(t,e){var r=a(e);self.postMessage({eventName:t,data:e},r)},{Client:e,Server:r}});
