"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=require("react"),r=e(t),n=require("@jbrowse/core/configuration"),a=e(require("@jbrowse/core/pluggableElementTypes/AdapterType")),o=e(require("@jbrowse/core/pluggableElementTypes/DisplayType")),i=require("@jbrowse/core/pluggableElementTypes/models"),l=e(require("@jbrowse/core/pluggableElementTypes/TrackType")),s=e(require("@jbrowse/core/pluggableElementTypes/WidgetType")),c=e(require("@jbrowse/core/Plugin")),u=require("@jbrowse/plugin-linear-genome-view"),p=require("@jbrowse/plugin-wiggle"),f=require("@jbrowse/core/util/types/mst"),d=require("mobx-state-tree"),g=e(require("fast-deep-equal")),h=require("mobx"),m=require("@jbrowse/core/util"),y=require("mobx-react"),v=require("@jbrowse/core/ui"),b=require("@jbrowse/core/util/tracks"),C=e(require("@material-ui/icons/Visibility")),w=require("@jbrowse/core/ui/Icons"),S=e(require("copy-to-clipboard")),k=e(require("@material-ui/icons/MenuOpen")),x=e(require("@material-ui/icons/Sort")),_=e(require("@material-ui/icons/Palette")),E=e(require("@material-ui/icons/ClearAll")),P=e(require("@jbrowse/core/pluggableElementTypes/renderers/util/serializableFilterChain")),T=e(require("@material-ui/core/Typography")),M=e(require("@material-ui/core/Tooltip")),R=require("@material-ui/core/styles"),N=require("rxjs/operators"),B=require("@jbrowse/core/pluggableElementTypes/renderers/BoxRendererType"),A=e(B),D=e(require("color")),I=require("@jbrowse/core/util/offscreenCanvasUtils"),L=require("@jbrowse/core/data_adapters/dataAdapterCache"),q=require("@jbrowse/core/util/range"),F=require("@jbrowse/core/data_adapters/BaseAdapter"),O=e(require("@jbrowse/core/util/simpleFeature")),j=require("@jbrowse/core/util/rxjs"),H=e(require("@jbrowse/core/pluggableElementTypes/RpcMethodType")),V=require("@gmod/bam"),z=require("@jbrowse/core/util/io"),G=require("@gmod/cram"),W=require("@material-ui/core"),U=e(require("@material-ui/icons/Close")),J=require("@jbrowse/core/BaseFeatureWidget/BaseFeatureDetail");function X(e,t,r,n,a,o,i){try{var l=e[o](i),s=l.value}catch(e){return void r(e)}l.done?t(s):Promise.resolve(s).then(n,a)}function Q(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){X(o,n,a,i,l,"next",e)}function l(e){X(o,n,a,i,l,"throw",e)}i(void 0)}))}}function Z(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Y(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function $(e,t,r){return t&&Y(e.prototype,t),r&&Y(e,r),e}function K(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ee(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function te(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ee(Object(r),!0).forEach((function(t){K(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ee(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function re(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ne(e){return(ne=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ae(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function oe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=ne(e);if(t){var a=ne(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return ae(this,r)}}function ie(e,t,r){return(ie="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ne(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(e,t,r||e)}function le(e,t){return ce(e)||function(e,t){var r=e&&("undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"]);if(null!=r){var n,a,o=[],i=!0,l=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);i=!0);}catch(e){l=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(l)throw a}}return o}}(e,t)||pe(e,t)||de()}function se(e){return function(e){if(Array.isArray(e))return fe(e)}(e)||ue(e)||pe(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ce(e){if(Array.isArray(e))return e}function ue(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function pe(e,t){if(e){if("string"==typeof e)return fe(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?fe(e,t):void 0}}function fe(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function de(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function ge(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=pe(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){l=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(l)throw o}}}}var he=n.ConfigurationSchema("AlignmentsFeatureWidget",{});function me(e){return d.types.model("AlignmentsFeatureWidget",{id:f.ElementId,type:d.types.literal("AlignmentsFeatureWidget"),featureData:d.types.frozen(),view:d.types.safeReference(e.pluggableMstType("view","stateModel"))}).actions((function(e){return{setFeatureData:function(t){e.featureData=t},clearFeatureData:function(){e.featureData=void 0}}}))}var ye=d.types.late((function(){return n.ConfigurationSchema("BamAdapter",{bamLocation:{type:"fileLocation",defaultValue:{uri:"/path/to/my.bam"}},index:n.ConfigurationSchema("BamIndex",{indexType:{model:d.types.enumeration("IndexType",["BAI","CSI"]),type:"stringEnum",defaultValue:"BAI"},location:{type:"fileLocation",defaultValue:{uri:"/path/to/my.bam.bai"}}}),chunkSizeLimit:{type:"number",defaultValue:1e8},fetchSizeLimit:{type:"number",defaultValue:5e8},sequenceAdapter:{type:"frozen",defaultValue:null}},{explicitlyTyped:!0})})),ve=function(){return{configSchema:ye,getAdapterClass:function(){return Promise.resolve().then((function(){return Rt})).then((function(e){return e.default}))}}};function be(e,t){return e(t={exports:{}},t.exports),t.exports}var Ce=be((function(e){var t=function(e){var t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function s(e,t,r,n){var a=Object.create((t&&t.prototype instanceof p?t:p).prototype),o=new k(n||[]);return a._invoke=function(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var l=C(i,r);if(l){if(l===u)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var s=c(e,t,r);if("normal"===s.type){if(n=r.done?"completed":"suspendedYield",s.arg===u)continue;return{value:s.arg,done:r.done}}"throw"===s.type&&(n="completed",r.method="throw",r.arg=s.arg)}}}(e,r,o),a}function c(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=s;var u={};function p(){}function f(){}function d(){}var g={};g[a]=function(){return this};var h=Object.getPrototypeOf,m=h&&h(h(x([])));m&&m!==t&&r.call(m,a)&&(g=m);var y=d.prototype=p.prototype=Object.create(g);function v(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){var n;this._invoke=function(a,o){function i(){return new t((function(n,i){!function n(a,o,i,l){var s=c(e[a],e,o);if("throw"!==s.type){var u=s.arg,p=u.value;return p&&"object"==typeof p&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,i,l)}),(function(e){n("throw",e,i,l)})):t.resolve(p).then((function(e){u.value=e,i(u)}),(function(e){return n("throw",e,i,l)}))}l(s.arg)}(a,o,n,i)}))}return n=n?n.then(i,i):i()}}function C(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,C(e,t),"throw"===t.method))return u;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return u}var n=c(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,u;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,u):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,u)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function S(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function k(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function x(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:_}}function _(){return{value:void 0,done:!0}}return f.prototype=y.constructor=d,d.constructor=f,f.displayName=l(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===f||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,l(e,i,"GeneratorFunction")),e.prototype=Object.create(y),e},e.awrap=function(e){return{__await:e}},v(b.prototype),b.prototype[o]=function(){return this},e.AsyncIterator=b,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new b(s(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},v(y),l(y,i,"Generator"),y[a]=function(){return this},y.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=x,k.prototype={constructor:k,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(S),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var l=r.call(o,"catchLoc"),s=r.call(o,"finallyLoc");if(l&&s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(l){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,u):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),u},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),S(r),u}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;S(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:x(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),u}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}})),we=Ce.mark(Ee);function Se(e){return(e||"").split(/([MIDNSHPX=])/)}function ke(e,t,r){for(var n=0,a=0,o=[],i=0;i<e.length-1;i+=2){var l=+e[i],s=e[i+1];if("M"!==s&&"="!==s&&"E"!==s||(a+=l),"I"===s)o.push({start:n,type:"insertion",base:"".concat(l),length:0}),a+=l;else if("D"===s)o.push({start:n,type:"deletion",base:"*",length:l});else if("N"===s)o.push({start:n,type:"skip",base:"N",length:l});else if("X"===s){for(var c=t.slice(a,a+l),u=(null==r?void 0:r.slice(a,a+l))||[],p=0;p<l;p++)o.push({start:n+p,type:"mismatch",base:c[p],qual:u[p],length:1});a+=l}else"H"===s?o.push({start:n,type:"hardclip",base:"H".concat(l),cliplen:l,length:1}):"S"===s&&(o.push({start:n,type:"softclip",base:"S".concat(l),cliplen:l,length:1}),a+=l);"I"!==s&&"S"!==s&&"H"!==s&&(n+=l)}return o}function xe(e,t,r,n,a){var o=[],i={start:0,base:"",length:0,type:"mismatch"},l=r.filter((function(e){return"skip"===e.type})),s=0,c=0,u=0,p=0;function f(){o.push(i),i={start:i.start+i.length,length:0,base:"",type:"mismatch"}}function d(e){for(var r=c,n=u,a=s;a<t.length&&n<=e;s=a+=2){var o=+t[a],i=t[a+1];"S"===i||"I"===i?r+=o:"D"===i||"P"===i||"N"===i?n+=o:"H"!==i&&(r+=o,n+=o)}return c=r,u=n,r-(n-e)}for(var g=e.match(/(\d+|\^[a-z]+|[a-z])/gi)||[],h=0;h<g.length;h++){var m=g[h];if(m.match(/^\d/))i.start+=parseInt(m,10);else if(m.match(/^\^/))i.length=m.length-1,i.base="*",i.type="deletion",i.seq=m.substring(1),f();else if(m.match(/^[a-z]/i))for(var y=0;y<m.length;y+=1){for(i.length=1;p<l.length;){var v=l[p];if(!(i.start>=v.start))break;i.start+=v.length,p++}var b=t?d(i.start):i.start;i.base=n?n.substr(b,1):"X";var C=null==a?void 0:a.slice(b,b+1)[0];C&&(i.qual=C),i.altbase=m,f()}}return o}function _e(e,t,r){var n=0,a=0,o=0;if(!e)return console.warn("no ref supplied to generateMD"),"";for(var i=Se(r),l="",s=0;s<i.length;s+=2){var c=+i[s],u=i[s+1];if("M"===u||"X"===u||"="===u){for(var p=0;p<c;p++)t[n+p].toLowerCase()!==e[a+p].toLowerCase()?(l+="".concat(o).concat(e[a+p].toUpperCase()),o=0):o++;n+=c,a+=c}else if("I"===u)n+=c;else if("D"===u){for(var f="",d=0;d<c;d++)f+=e[a+d].toUpperCase();l+="".concat(o,"^").concat(f),o=0,a+=c}else"N"===u?a+=c:"S"===u&&(n+=c)}return o>0&&(l+=o),l}function Ee(e,t){var r,n,a,o,i,l,s;return Ce.wrap((function(c){for(;;)switch(c.prev=c.next){case 0:r=0,n=0,a=0,o=0;case 4:if(!(o<t.length)){c.next=12;break}for(i=t[o];r<e.length&&n<i;r+=2)l=+e[r],"S"===(s=e[r+1])||"I"===s?n+=l:"D"===s||"N"===s?a+=l:"M"!==s&&"X"!==s&&"="!==s||(n+=l,a+=l);return c.next=9,t[o]-n+a;case 9:o++,c.next=4;break;case 12:case"end":return c.stop()}}),we)}function Pe(e,t){return e.split(";").filter((function(e){return!!e})).map((function(e){var r,n=ce(r=e.split(","))||ue(r)||pe(r)||de(),a=n[0],o=n.slice(1),i=a.match(/([A-Z])([-+])([^,]+)/);if(!i)throw new Error("bad format for MM tag");var l=le(i,4),s=l[1],c=l[2],u=l[3].split(/(\d+|.)/).filter((function(e){return!!e}));return"-"===c?(console.warn("unsupported negative strand modifications"),{type:"unsupported",positions:[]}):u.map((function(e){var r=0;return{type:e,positions:o.map((function(e){return+e})).map((function(e){r++;do{"N"!==s&&s!==t[r]||e--,r++}while(e>=0&&r<t.length);return--r}))}}))})).flat()}function Te(e){return e.split(";").filter((function(e){return!!e})).map((function(e){var t=le(e.split(","),1)[0].match(/([A-Z])([-+])([^,]+)/);if(!t)throw new Error("bad format for MM tag");return le(t,4)[3].split(/(\d+|.)/).filter((function(e){return!!e}))})).flat()}var Me={__proto__:null,parseCigar:Se,cigarToMismatches:ke,mdToMismatches:xe,getTemplateCoord:function(e,t){for(var r=0,n=0,a=0;a<t.length&&n<=e;a+=2){var o=+t[a],i=t[a+1];"S"===i||"I"===i?r+=o:"D"===i||"P"===i?n+=o:"H"!==i&&(r+=o,n+=o)}return r-(n-e)},getMismatches:function(e,t,r,n){var a=[],o=[];e&&(o=Se(e),a=a.concat(ke(o,r,n))),t&&(a=a.concat(xe(t,o,a,r,n)));var i={};return a.filter((function(e){var t="".concat(e.type,",").concat(e.start,",").concat(e.length),r=i[t];return i[t]=!0,!r}))},generateMD:_e,getNextRefPos:Ee,getModificationPositions:Pe,getModificationTypes:Te},Re=function(e){return e.lib["mobx-state-tree"].types.late((function(){return n.ConfigurationSchema("CramAdapter",{cramLocation:{type:"fileLocation",defaultValue:{uri:"/path/to/my.cram"}},craiLocation:{type:"fileLocation",defaultValue:{uri:"/path/to/my.cram.crai"}},sequenceAdapter:e.pluggableConfigSchemaType("adapter")},{explicitlyTyped:!0})}))},Ne=function(e){return{configSchema:e.load(Re),getAdapterClass:function(){return Promise.resolve().then((function(){return Bt})).then((function(e){return e.default}))}}},Be=d.types.late((function(){return n.ConfigurationSchema("HtsgetBamAdapter",{htsgetBase:{type:"string",defaultValue:""},htsgetTrackId:{type:"string",defaultValue:""},sequenceAdapter:{type:"frozen",defaultValue:null}},{explicitlyTyped:!0})})),Ae=function(){return{configSchema:Be,getAdapterClass:function(){return Promise.resolve().then((function(){return At})).then((function(e){return e.default}))}}},De=function(e,t){return d.types.compose("LinearAlignmentsDisplay",i.BaseDisplay,d.types.model({PileupDisplay:d.types.maybe(e.getDisplayType("LinearPileupDisplay").stateModel),SNPCoverageDisplay:d.types.maybe(e.getDisplayType("LinearSNPCoverageDisplay").stateModel),snpCovHeight:45,type:d.types.literal("LinearAlignmentsDisplay"),configuration:n.ConfigurationReference(t),height:250,showCoverage:!0,showPileup:!0})).volatile((function(){return{scrollTop:0}})).actions((function(e){return{toggleCoverage:function(){e.showCoverage=!e.showCoverage},togglePileup:function(){e.showPileup=!e.showPileup},setScrollTop:function(t){e.scrollTop=t},setSNPCoverageHeight:function(t){e.snpCovHeight=t}}})).views((function(e){var t=e.trackMenuItems;return{get pileupDisplayConfig(){var t=n.getConf(e,"pileupDisplay"),r=m.getContainingTrack(e);return te(te({},t),{},{type:"LinearPileupDisplay",name:"".concat(n.getConf(r,"name")," pileup"),displayId:"".concat(e.configuration.displayId,"_pileup_xyz")})},getFeatureByID:function(t){return e.PileupDisplay.getFeatureByID(t)},get features(){return e.PileupDisplay.features},get DisplayBlurb(){var t;return null===(t=e.PileupDisplay)||void 0===t?void 0:t.DisplayBlurb},get sortedBy(){return e.PileupDisplay.sortedBy},get sortedByPosition(){return e.PileupDisplay.sortedByPosition},get sortedByRefName(){return e.PileupDisplay.sortedByRefName},get snpCoverageDisplayConfig(){var t=n.getConf(e,"snpCoverageDisplay"),r=m.getContainingTrack(e);return te(te({},t),{},{type:"LinearSNPCoverageDisplay",name:"".concat(n.getConf(r,"name")," snp coverage"),displayId:"".concat(e.configuration.displayId,"_snpcoverage_xyz")})},get trackMenuItems(){return[].concat(se(t),[{type:"subMenu",label:"Pileup settings",subMenu:e.PileupDisplay.composedTrackMenuItems},{type:"subMenu",label:"SNPCoverage settings",subMenu:[].concat(se(e.SNPCoverageDisplay.composedTrackMenuItems),se(e.SNPCoverageDisplay.extraTrackMenuItems))}])}}})).actions((function(e){return{setSNPCoverageDisplay:function(t){e.SNPCoverageDisplay={type:"LinearSNPCoverageDisplay",configuration:t,height:e.snpCovHeight}},setUserBpPerPxLimit:function(t){e.PileupDisplay.setUserBpPerPxLimit(t),e.SNPCoverageDisplay.setUserBpPerPxLimit(t)},setPileupDisplay:function(t){e.PileupDisplay={type:"LinearPileupDisplay",configuration:t}},setHeight:function(t){return e.height=t>20?t:20,e.height},resizeHeight:function(t){var r=e.height;return this.setHeight(e.height+t)-r}}})).actions((function(e){return{afterAttach:function(){d.addDisposer(e,h.autorun((function(){e.SNPCoverageDisplay?g(e.snpCoverageDisplayConfig,d.getSnapshot(e.SNPCoverageDisplay.configuration))||(e.SNPCoverageDisplay.setHeight(e.snpCovHeight),e.SNPCoverageDisplay.setConfig(e.snpCoverageDisplayConfig)):e.setSNPCoverageDisplay(e.snpCoverageDisplayConfig),e.PileupDisplay?g(e.pileupDisplayConfig,d.getSnapshot(e.PileupDisplay.configuration))||e.PileupDisplay.setConfig(e.pileupDisplayConfig):e.setPileupDisplay(e.pileupDisplayConfig),e.PileupDisplay.filterBy&&!g(d.getSnapshot(e.PileupDisplay.filterBy),d.getSnapshot(e.SNPCoverageDisplay.filterBy))&&e.SNPCoverageDisplay.setFilterBy(d.getSnapshot(e.PileupDisplay.filterBy)),e.PileupDisplay.colorBy&&!g(d.getSnapshot(e.PileupDisplay.colorBy),e.SNPCoverageDisplay.colorBy?d.getSnapshot(e.SNPCoverageDisplay.colorBy):{})&&e.SNPCoverageDisplay.setColorBy(d.getSnapshot(e.PileupDisplay.colorBy))}))),d.addDisposer(e,h.autorun((function(){e.setSNPCoverageHeight(e.SNPCoverageDisplay.height)})))},renderSvg:function(t){return Q(Ce.mark((function n(){var a;return Ce.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return a=e.height-e.SNPCoverageDisplay.height,n.next=3,h.when((function(){return e.PileupDisplay.ready}));case 3:return n.t0=r,n.t1=r.Fragment,n.t2=r,n.next=8,e.SNPCoverageDisplay.renderSvg(t);case 8:return n.t3=n.sent,n.t4=n.t2.createElement.call(n.t2,"g",null,n.t3),n.t5=r,n.t6={transform:"translate(0 ".concat(e.SNPCoverageDisplay.height,")")},n.next=14,e.PileupDisplay.renderSvg(te(te({},t),{},{overrideHeight:a}));case 14:return n.t7=n.sent,n.t8=n.t5.createElement.call(n.t5,"g",n.t6,n.t7),n.abrupt("return",n.t0.createElement.call(n.t0,n.t1,null,n.t4,n.t8));case 17:case"end":return n.stop()}}),n)})))()}}}))};function Ie(e){var t=e.model,a=t.PileupDisplay,o=t.SNPCoverageDisplay,i=t.showPileup,l=t.showCoverage;return r.createElement("div",{"data-testid":"display-".concat(n.getConf(t,"displayId")),style:{position:"relative"}},r.createElement("div",{"data-testid":"Blockset-snpcoverage"},l?r.createElement(o.RenderingComponent,{model:o}):null),r.createElement(v.ResizeHandle,{onDrag:function(e){return o?(o.setHeight(o.height+e),e):0},style:{position:"absolute",top:l?o.height+2:0,height:3}}),r.createElement("div",{"data-testid":"Blockset-pileup",style:{position:"absolute",top:l?o.height+5:0,height:3}},i?r.createElement(a.RenderingComponent,{model:a}):null))}var Le=y.observer(Ie);function qe(e){var t=e.model,n=t.sortedBy;return n?r.createElement("div",{"data-testid":"blurb-".concat(t.sortedBy),style:{backgroundColor:"white"}},r.createElement(T,{color:"secondary",variant:"caption"},t.sortedBy?"Sorted by ".concat(n.type.toLowerCase()," at ").concat(n.refName,":").concat(n.pos):null)):null}var Fe=y.observer(qe);function Oe(e,t,r,n){return je.apply(this,arguments)}function je(){return(je=Q(Ce.mark((function e(t,r,n,a){var o,i,l,s;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=m.getSession(t),i=o.rpcManager,l=t.adapterConfig,s=b.getRpcSessionId(t),e.next=5,i.call(b.getRpcSessionId(t),"PileupGetGlobalValueForTag",te({adapterConfig:l,tag:r.tag,sessionId:s,regions:n.contentBlocks},a));case 5:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function He(e,t,r,n,a){return Ve.apply(this,arguments)}function Ve(){return(Ve=Q(Ce.mark((function e(t,r,n,a,o){var i,l,s;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=m.getSession(t),l=i.rpcManager,s=b.getRpcSessionId(t),e.next=4,l.call(s,"PileupGetVisibleModifications",te({adapterConfig:r,tag:n.tag,sessionId:s,regions:a.contentBlocks},o));case 4:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var ze=t.lazy((function(){return Promise.resolve().then((function(){return Lt}))})),Ge=t.lazy((function(){return Promise.resolve().then((function(){return Ht}))})),We=t.lazy((function(){return Promise.resolve().then((function(){return Gt}))})),Ue=t.lazy((function(){return Promise.resolve().then((function(){return Jt}))})),Je=t.lazy((function(){return Promise.resolve().then((function(){return Zt}))})),Xe=t.lazy((function(){return Promise.resolve().then((function(){return er}))})),Qe=new Map([["pileup","PileupRenderer"],["svg","SvgFeatureRenderer"]]),Ze=function(e,t){return d.types.compose("LinearPileupDisplay",u.BaseLinearDisplay,d.types.model({type:d.types.literal("LinearPileupDisplay"),configuration:n.ConfigurationReference(t),showSoftClipping:!1,featureHeight:d.types.maybe(d.types.number),noSpacing:d.types.maybe(d.types.boolean),fadeLikelihood:d.types.maybe(d.types.boolean),trackMaxHeight:d.types.maybe(d.types.number),mismatchAlpha:d.types.maybe(d.types.boolean),sortedBy:d.types.maybe(d.types.model({type:d.types.string,pos:d.types.number,tag:d.types.maybe(d.types.string),refName:d.types.string,assemblyName:d.types.string})),colorBy:d.types.maybe(d.types.model({type:d.types.string,tag:d.types.maybe(d.types.string),extra:d.types.frozen()})),filterBy:d.types.optional(d.types.model({flagInclude:d.types.optional(d.types.number,0),flagExclude:d.types.optional(d.types.number,1536),readName:d.types.maybe(d.types.string),tagFilter:d.types.maybe(d.types.model({tag:d.types.string,value:d.types.string}))}),{})})).volatile((function(){return{colorTagMap:h.observable.map({}),modificationTagMap:h.observable.map({}),ready:!1,currBpPerPx:0}})).actions((function(e){return{setReady:function(t){e.ready=t},setCurrBpPerPx:function(t){e.currBpPerPx=t},setMaxHeight:function(t){e.trackMaxHeight=t},setFeatureHeight:function(t){e.featureHeight=t},setNoSpacing:function(t){e.noSpacing=t},setColorScheme:function(t){e.colorTagMap=h.observable.map({}),e.colorBy=d.cast(t),e.ready=!1},updateModificationColorMap:function(t){var r=["red","blue","green","orange","purple"];t.forEach((function(t){if(!e.modificationTagMap.has(t)){var n=se(e.modificationTagMap.keys()).length;e.modificationTagMap.set(t,r[n])}}))},updateColorTagMap:function(t){var r=["#BBCCEE","pink","#CCDDAA","#EEEEBB","#FFCCCC","lightblue","lightgreen","tan","#CCEEFF","lightsalmon"];t.forEach((function(t){if(!e.colorTagMap.has(t)){var n=se(e.colorTagMap.keys()).length;e.colorTagMap.set(t,r[n])}}))}}})).actions((function(e){return{afterAttach:function(){d.addDisposer(e,h.autorun(Q(Ce.mark((function t(){var r,a,o,i,l,s,c,u,p;return Ce.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,r=m.getSession(e),a=r.rpcManager,o=e.sortedBy,i=e.colorBy,l=e.renderProps,s=m.getContainingView(e),null==i||!i.tag){t.next=9;break}return t.next=7,Oe(e,i,s.staticBlocks);case 7:e.updateColorTagMap(t.sent);case 9:if("modifications"!==(null==i?void 0:i.type)){t.next=14;break}return t.next=12,He(e,n.getConf(e.parentTrack,["adapter"]),i,s.staticBlocks);case 12:e.updateModificationColorMap(t.sent);case 14:if(!o){t.next=23;break}return p={start:c=o.pos,end:(c||0)+1,refName:o.refName,assemblyName:u=o.assemblyName},t.next=19,e.rendererType.renderInClient(a,te({assemblyName:u,regions:[p],adapterConfig:e.adapterConfig,rendererType:e.rendererType.name,sessionId:b.getRpcSessionId(e),timeout:1e6},l));case 19:e.setReady(!0),e.setCurrBpPerPx(s.bpPerPx),t.next=24;break;case 23:e.setReady(!0);case 24:t.next=30;break;case 26:t.prev=26,t.t0=t.catch(0),console.error(t.t0),e.setError(t.t0);case 30:case"end":return t.stop()}}),t,null,[[0,26]])}))),{delay:1e3}))},selectFeature:function(t){var r=m.getSession(e);if(m.isSessionModelWithWidgets(r)){var n=r.addWidget("AlignmentsFeatureWidget","alignmentFeature",{featureData:t.toJSON(),view:m.getContainingView(e)});r.showWidget(n)}r.setSelection(t)},clearSelected:function(){e.sortedBy=void 0},copyFeatureToClipboard:function(t){var r=t.toJSON();delete r.uniqueId;var n=m.getSession(e);S(JSON.stringify(r,null,4)),n.notify("Copied to clipboard","success")},toggleSoftClipping:function(){e.showSoftClipping=!e.showSoftClipping},toggleMismatchAlpha:function(){e.mismatchAlpha=!e.mismatchAlpha},setConfig:function(t){e.configuration=t},setSortedBy:function(t,r){var n=m.getContainingView(e).centerLineInfo;if(n){var a=n.refName,o=n.assemblyName,i=Math.round(n.offset)+1;i<0||(e.sortedBy={type:t,pos:i,refName:a,assemblyName:o,tag:r},e.ready=!1)}},setFilterBy:function(t){e.filterBy=d.cast(t)}}})).actions((function(e){var t=e.reload;return{reload:function(){e.clearSelected(),t()}}})).views((function(e){return{get maxHeight(){var t=n.getConf(e,["renderers",e.rendererTypeName])||{};return void 0!==e.trackMaxHeight?e.trackMaxHeight:t.maxHeight},get rendererConfig(){var t=n.getConf(e,["renderers",e.rendererTypeName])||{};return e.rendererType.configSchema.create(te(te({},t),{},{height:e.featureHeight,noSpacing:e.noSpacing,maxHeight:this.maxHeight,mismatchAlpha:e.mismatchAlpha}),d.getEnv(e))},get featureHeightSetting(){return e.featureHeight||n.readConfObject(this.rendererConfig,"height")},get mismatchAlphaSetting(){return void 0!==e.mismatchAlpha?e.mismatchAlpha:n.readConfObject(this.rendererConfig,"mismatchAlpha")}}})).views((function(t){var r=t.trackMenuItems;return{get rendererTypeName(){var e=n.getConf(t,"defaultRendering"),r=Qe.get(e);if(!r)throw new Error("unknown alignments view name ".concat(e));return r},get contextMenuItems(){var r=t.contextMenuFeature,n=r?[{label:"Open feature details",icon:k,onClick:function(){t.clearFeatureSelection(),r&&t.selectFeature(r)}},{label:"Copy info to clipboard",icon:w.ContentCopy,onClick:function(){r&&t.copyFeatureToClipboard(r)}}]:[];return t.additionalContextMenuItemCallbacks.forEach((function(a){var o=a(r,t,e);n.push.apply(n,se(o))})),n},get DisplayBlurb(){return Fe},get filters(){var e=[];if(t.filterBy){var r=t.filterBy,n=r.flagInclude,a=r.flagExclude;if(e=["jexl:((get(feature,'flags')&".concat(n,")==").concat(n,") && !(get(feature,'flags')&").concat(a,")")],t.filterBy.tagFilter){var o=t.filterBy.tagFilter,i=o.tag,l=o.value;e.push('jexl:"'.concat(l,"\" =='*' ? getTag(feature,\"").concat(i,'") != undefined : getTag(feature,"').concat(i,'") == "').concat(l,'"'))}t.filterBy.readName&&e.push("jexl:get(feature,'name') == \"".concat(t.filterBy.readName,'"'))}return new P({filters:e})},get renderProps(){var e=m.getContainingView(t);return te(te(te({},t.composedRenderProps),b.getParentRenderProps(t)),{},{notReady:!t.ready||t.sortedBy&&t.currBpPerPx!==e.bpPerPx,rpcDriverName:t.rpcDriverName,displayModel:t,sortedBy:t.sortedBy,colorBy:t.colorBy,colorTagMap:JSON.parse(JSON.stringify(t.colorTagMap)),modificationTagMap:JSON.parse(JSON.stringify(t.modificationTagMap)),filters:this.filters,showSoftClip:t.showSoftClipping,config:t.rendererConfig})},get composedTrackMenuItems(){return[{label:"Show soft clipping",icon:C,type:"checkbox",checked:t.showSoftClipping,onClick:function(){t.toggleSoftClipping(),t.showSoftClipping&&t.clearSelected()}},{label:"Sort by",icon:x,disabled:t.showSoftClipping,subMenu:[].concat(se(["Start location","Read strand","Base pair"].map((function(e){return{label:e,onClick:function(){return t.setSortedBy(e)}}}))),[{label:"Sort by tag...",onClick:function(){return m.getSession(t).setDialogComponent(We,{model:t})}},{label:"Clear sort",onClick:function(){return t.clearSelected()}}])},{label:"Color scheme",icon:_,subMenu:[{label:"Normal",onClick:function(){t.setColorScheme({type:"normal"})}},{label:"Mapping quality",onClick:function(){t.setColorScheme({type:"mappingQuality"})}},{label:"Strand",onClick:function(){t.setColorScheme({type:"strand"})}},{label:"Pair orientation",onClick:function(){t.setColorScheme({type:"pairOrientation"})}},{label:"Per-base quality",onClick:function(){t.setColorScheme({type:"perBaseQuality"})}},{label:"Modifications or methylation",onClick:function(){m.getSession(t).setDialogComponent(Xe,{model:t})}},{label:"Insert size",onClick:function(){t.setColorScheme({type:"insertSize"})}},{label:"Stranded paired-end",onClick:function(){t.setColorScheme({type:"reverseTemplate"})}},{label:"Color by tag...",onClick:function(){m.getSession(t).setDialogComponent(ze,{model:t})}}]},{label:"Filter by",icon:E,onClick:function(){m.getSession(t).setDialogComponent(Ge,{model:t})}},{label:"Set feature height",onClick:function(){m.getSession(t).setDialogComponent(Ue,{model:t})}},{label:"Set max height",onClick:function(){m.getSession(t).setDialogComponent(Je,{model:t})}},{label:"Fade mismatches by quality",type:"checkbox",checked:t.mismatchAlphaSetting,onClick:function(){t.toggleMismatchAlpha()}}]},get trackMenuItems(){return[].concat(se(r),se(this.composedTrackMenuItems))}}}))},Ye=R.makeStyles((function(e){return{popper:{fontSize:"0.8em",zIndex:e.zIndex.tooltip,pointerEvents:"none"},hoverVertical:{background:"#333",border:"none",width:1,height:"100%",top:0,cursor:"default",position:"absolute",pointerEvents:"none"}}}));function $e(e){var t=e.feature,n=t.get("refName"),a=(t.get("start")+1).toLocaleString("en-US"),o=t.get("end").toLocaleString("en-US"),i="".concat(n?"".concat(n,":"):"").concat(a===o?a:"".concat(a,"..").concat(o)),l=t.get("snpinfo"),s=l.total,c=l.ref,u=l.cov,p=l.noncov,f=l.lowqual,d=l.delskips;return r.createElement("div",null,r.createElement("table",null,r.createElement("caption",null,i),r.createElement("thead",null,r.createElement("tr",null,r.createElement("th",null,"Base"),r.createElement("th",null,"Count"),r.createElement("th",null,"% of Total"),r.createElement("th",null,"Strands"),r.createElement("th",null,"Source"))),r.createElement("tbody",null,r.createElement("tr",null,r.createElement("td",null,"Total"),r.createElement("td",null,s),r.createElement("td",null)),Object.entries({ref:c,cov:u,noncov:p,delskips:d,lowqual:f}).map((function(e){var t=le(e,2),n=t[0];return r.createElement(r.Fragment,{key:n},Object.entries(t[1]).map((function(e){var t=le(e,2),a=t[0],o=t[1],i=o.strands;return r.createElement("tr",{key:a},r.createElement("td",null,a.toUpperCase()),r.createElement("td",null,o.total),r.createElement("td",null,"total"===a?"---":"".concat(Math.floor(o.total/s*100),"%")),r.createElement("td",null,i[-1]?"".concat(i[-1],"(-)"):"",i[1]?"".concat(i[1],"(+)"):""),r.createElement("td",null,n))})))})))))}var Ke=y.observer((function(e){var t=e.height,n=e.mouseCoord,a=e.model.featureUnderMouse,o=Ye();return a?r.createElement(r.Fragment,null,r.createElement(M,{placement:"right-start",className:o.popper,open:!0,title:r.createElement($e,{feature:a})},r.createElement("div",{style:{position:"absolute",left:n[0],top:0}}," ")),r.createElement("div",{className:o.hoverVertical,style:{left:n[0],height:t}})):null})),et=new Map([["snpcoverage","SNPCoverageRenderer"]]),tt=function(e,t){return d.types.compose("LinearSNPCoverageDisplay",p.linearWiggleDisplayModelFactory(e,t),d.types.model({type:d.types.literal("LinearSNPCoverageDisplay"),drawInterbaseCounts:d.types.maybe(d.types.boolean),drawIndicators:d.types.maybe(d.types.boolean),filterBy:d.types.optional(d.types.model({flagInclude:d.types.optional(d.types.number,0),flagExclude:d.types.optional(d.types.number,1536),readName:d.types.maybe(d.types.string),tagFilter:d.types.maybe(d.types.model({tag:d.types.string,value:d.types.string}))}),{}),colorBy:d.types.maybe(d.types.model({type:d.types.string,tag:d.types.maybe(d.types.string)}))})).volatile((function(){return{modificationTagMap:h.observable.map({})}})).actions((function(e){return{setConfig:function(t){e.configuration=t},setFilterBy:function(t){e.filterBy=d.cast(t)},setColorBy:function(t){e.colorBy=d.cast(t)},updateModificationColorMap:function(t){var r=["red","blue","green","orange","purple"],n=0;t.forEach((function(t){if(!e.modificationTagMap.has(t)){var a=r[n++];e.modificationTagMap.set(t,a)}}))}}})).views((function(e){return{get rendererConfig(){var t=n.getConf(e,["renderers",e.rendererTypeName])||{};return e.rendererType.configSchema.create(te(te({},t),{},{drawInterbaseCounts:void 0===e.drawInterbaseCounts?t.drawInterbaseCounts:e.drawInterbaseCounts,drawIndicators:void 0===e.drawIndicators?t.drawIndicators:e.drawIndicators}),d.getEnv(e))},get drawInterbaseCountsSetting(){return void 0!==e.drawInterbaseCounts?e.drawInterbaseCounts:n.readConfObject(this.rendererConfig,"drawInterbaseCounts")},get drawIndicatorsSetting(){return void 0!==e.drawIndicators?e.drawIndicators:n.readConfObject(this.rendererConfig,"drawIndicators")},get modificationsReady(){var t;return"modifications"!==(null===(t=e.colorBy)||void 0===t?void 0:t.type)||Object.keys(JSON.parse(JSON.stringify(e.modificationTagMap))).length>0},get renderProps(){return te(te(te({},e.composedRenderProps),b.getParentRenderProps(e)),{},{notReady:!e.ready||!this.modificationsReady,rpcDriverName:e.rpcDriverName,displayModel:e,config:e.rendererConfig,scaleOpts:e.scaleOpts,resolution:e.resolution,height:e.height,ticks:e.ticks,displayCrossHatches:e.displayCrossHatches,filters:e.filters,modificationTagMap:JSON.parse(JSON.stringify(e.modificationTagMap)),colorBy:e.colorBy?d.getSnapshot(e.colorBy):void 0})}}})).actions((function(e){return{toggleDrawIndicators:function(){e.drawIndicators=!e.drawIndicatorsSetting},toggleDrawInterbaseCounts:function(){e.drawInterbaseCounts=!e.drawInterbaseCountsSetting},afterAttach:function(){d.addDisposer(e,h.autorun(Q(Ce.mark((function t(){var r,a,o;return Ce.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,r=e.colorBy,a=m.getContainingView(e),o=a.staticBlocks,"modifications"!==(null==r?void 0:r.type)){t.next=8;break}return t.next=6,He(e,n.getConf(e.parentTrack,"adapter"),r,o);case 6:e.updateModificationColorMap(t.sent);case 8:t.next=14;break;case 10:t.prev=10,t.t0=t.catch(0),console.error(t.t0),e.setError(t.t0);case 14:case"end":return t.stop()}}),t,null,[[0,10]])}))),{delay:1e3}))}}})).views((function(e){var t=e.trackMenuItems;return{get TooltipComponent(){return Ke},get adapterConfig(){return{type:"SNPCoverageAdapter",subadapter:n.getConf(e.parentTrack,"adapter")}},get rendererTypeName(){return et.get("snpcoverage")},get needsScalebar(){return!0},get contextMenuItems(){return[]},get extraTrackMenuItems(){return[{label:"Draw insertion/clipping indicators",type:"checkbox",checked:e.drawIndicatorsSetting,onClick:function(){e.toggleDrawIndicators()}},{label:"Draw insertion/clipping counts",type:"checkbox",checked:e.drawInterbaseCountsSetting,onClick:function(){e.toggleDrawInterbaseCounts()}}]},get trackMenuItems(){return[].concat(se(t),se(e.composedTrackMenuItems),se(this.extraTrackMenuItems))},get filters(){var t=[];if(e.filterBy){var r=e.filterBy,n=r.flagInclude,a=r.flagExclude;if(t=["jexl:get(feature,'snpinfo') != undefined ? true : "+"((get(feature,'flags')&".concat(n,")==").concat(n,") && ")+"!((get(feature,'flags')&".concat(a,"))")],e.filterBy.tagFilter){var o=e.filterBy.tagFilter,i=o.tag,l=o.value;t.push("jexl:get(feature,'snpinfo') != undefined ? true : "+'"'.concat(l,"\" =='*' ? getTag(feature,\"").concat(i,'") != undefined : ')+'getTag(feature,"'.concat(i,'") == "').concat(l,'"'))}e.filterBy.readName&&t.push("jexl:get(feature,'snpinfo') != undefined ? true : "+"get(feature,'name') == \"".concat(e.filterBy.readName,'"'))}return new P({filters:t})}}}))};function rt(e){var n=e.onMouseMove,a=e.blockKey,o=e.displayModel,i=e.width,l=e.height,s=e.bpPerPx,c=e.sortedBy,u=e.colorBy,p=o||{},f=p.selectedFeatureId,d=p.featureIdUnderMouse,g=p.contextMenuFeature,h=p.blockLayoutFeatures,y=le(e.regions,1)[0],b=t.useRef(null),C=le(t.useState(!1),2),w=C[0],S=C[1],k=le(t.useState(!1),2),x=k[0],_=k[1];function E(t,r){var n=e["onFeature".concat(t)],a=e["on".concat(t)];n&&d?n(r,d):a&&a(r,d)}t.useEffect((function(){var e=b.current;if(e){var t=e.getContext("2d");if(t){var r,n;if(t.clearRect(0,0,e.width,e.height),f&&(n=h.get(a))&&(r=n.get(f))){var o=le(r,4),i=o[1],l=o[3],c=le(m.bpSpanPx(o[0],o[2],y,s),2),u=c[0],p=c[1],v=Math.round(i),C=Math.round(l-i);t.shadowColor="#222266",t.shadowBlur=10,t.lineJoin="bevel",t.lineWidth=2,t.strokeStyle="#00b8ff",t.strokeRect(u-2,v-2,p-u+4,C+4),t.clearRect(u,v,p-u,C)}var w=d||(null==g?void 0:g.id());if(w&&(n=h.get(a))&&(r=n.get(w))){var S=le(r,4),k=S[1],x=S[3],_=le(m.bpSpanPx(S[0],S[2],y,s),2),E=_[0],P=_[1],T=Math.round(k),M=Math.round(x-k);t.fillStyle="#0003",t.fillRect(E,T,P-E,M)}}}}),[s,y,f,d,g,a,h]);var P=Math.ceil(i);return r.createElement("div",{className:"PileupRendering","data-testid":"pileup-".concat(c||u?"".concat((null==c?void 0:c.type)||"").concat((null==u?void 0:u.type)||"").concat((null==u?void 0:u.tag)||""):"normal"),style:{position:"relative",width:P,height:l}},r.createElement(v.PrerenderedCanvas,Object.assign({},e,{style:{position:"absolute",left:0,top:0}})),r.createElement("canvas",{"data-testid":"pileup_overlay_canvas",width:P,height:l,style:{position:"absolute",left:0,top:0},className:"highlightOverlayCanvas",ref:b,onMouseDown:function(e){return function(e){S(!0),_(!1),E("MouseDown",e)}(e)},onMouseEnter:function(e){return function(e){E("MouseEnter",e)}(e)},onMouseOut:function(e){return function(e){E("MouseOut",e),E("MouseLeave",e)}(e)},onMouseOver:function(e){return function(e){E("MouseOver",e)}(e)},onMouseUp:function(e){return function(e){S(!1),E("MouseUp",e)}(e)},onMouseLeave:function(e){return function(e){E("MouseOut",e),E("MouseLeave",e)}(e)},onMouseMove:function(e){return function(e){w&&_(!0);var t=0,r=0;b.current&&(t=b.current.getBoundingClientRect().left,r=b.current.getBoundingClientRect().top),t=e.clientX-t;var l=o.getFeatureOverlapping(a,y.start+s*(y.reversed?i-t:t),r=e.clientY-r);n&&n(e,l)}(e)},onClick:function(e){return function(e){x||E("Click",e)}(e)},onContextMenu:function(e){return function(e){E("ContextMenu",e)}(e)},onFocus:function(){},onBlur:function(){}}))}var nt=y.observer(rt),at=n.ConfigurationSchema("PileupRenderer",{color:{type:"color",description:"the color of each feature in a pileup alignment",defaultValue:"#c8c8c8",contextVariable:["feature"]},orientationType:{type:"stringEnum",model:d.types.enumeration("orientationType",["fr","rf","ff"]),defaultValue:"fr",description:'read sequencer orienation. fr is normal "reads pointing at each other ---\x3e <--- while some other sequencers can use other options'},displayMode:{type:"stringEnum",model:d.types.enumeration("displayMode",["normal","compact","collapse"]),description:"Alternative display modes",defaultValue:"normal"},minSubfeatureWidth:{type:"number",description:"the minimum width in px for a pileup mismatch feature. use for increasing mismatch marker widths when zoomed out to e.g. 1px or 0.5px",defaultValue:0},maxHeight:{type:"integer",description:"the maximum height to be used in a pileup rendering",defaultValue:1200},maxClippingSize:{type:"integer",description:"the max clip size to be used in a pileup rendering",defaultValue:1e4},height:{type:"number",description:"the height of each feature in a pileup alignment",defaultValue:7,contextVariable:["feature"]},noSpacing:{type:"boolean",description:"remove spacing between features",defaultValue:!1},largeInsertionIndicatorScale:{type:"number",description:"scale at which to draw the large insertion indicators (bp/pixel)",defaultValue:10},mismatchAlpha:{type:"boolean",defaultValue:!1,description:"Fade low quality mismatches"}},{explicitlyTyped:!0});function ot(e,t){var r=e.get("tags");return r?r[t]:e.get(t)}function it(e,t,r){return ot(e,t)||ot(e,r)}var lt={fr:{F1R2:"LR",F2R1:"LR",F1F2:"LL",F2F1:"LL",R1R2:"RR",R2R1:"RR",R1F2:"RL",R2F1:"RL"},rf:{R1F2:"LR",R2F1:"LR",R1R2:"LL",R2R1:"LL",F1F2:"RR",F2F1:"RR",F1R2:"RL",F2R1:"RL"},ff:{F2F1:"LR",R1R2:"LR",F2R1:"LL",R1F2:"LL",R2F1:"RR",F1R2:"RR",R2R1:"RL",F1F2:"RL"}},st=function(e){re(r,B.LayoutSession);var t=oe(r);function r(e){var n;return Z(this,r),(n=t.call(this,e)).showSoftClip=!1,n.config=e.config,n}return $(r,[{key:"cachedLayoutIsValid",value:function(e){return ie(ne(r.prototype),"cachedLayoutIsValid",this).call(this,e)&&this.showSoftClip===e.showSoftClip&&g(this.sortedBy,e.sortedBy)}},{key:"layout",get:function(){return this.cachedLayout&&this.cachedLayoutIsValid(this.cachedLayout)||(this.cachedLayout={layout:this.makeLayout(),config:n.readConfObject(this.config),filters:this.filters,sortedBy:this.sortedBy,showSoftClip:this.showSoftClip}),this.cachedLayout.layout}}]),r}();function ct(e){return{A:e.palette.bases.A.main,C:e.palette.bases.C.main,G:e.palette.bases.G.main,T:e.palette.bases.T.main,deletion:"#808080"}}var ut={color_fwd_strand_not_proper:"#ECC8C8",color_rev_strand_not_proper:"#BEBED8",color_fwd_strand:"#EC8B8B",color_rev_strand:"#8F8FD8",color_fwd_missing_mate:"#D11919",color_rev_missing_mate:"#1919D1",color_fwd_diff_chr:"#000",color_rev_diff_chr:"#969696",color_pair_lr:"#c8c8c8",color_pair_rr:"navy",color_pair_rl:"teal",color_pair_ll:"green",color_nostrand:"#999",color_interchrom:"orange",color_longinsert:"red",color_shortinsert:"pink"};function pt(e){return!["methylation","modifications"].includes(e||"")}var ft=function(e){re(o,A);var t,r,a=oe(o);function o(){var e;return Z(this,o),(e=a.apply(this,arguments)).supportsSVG=!0,e}return $(o,[{key:"getCharWidthHeight",value:function(e){return{charWidth:e.measureText("A").width,charHeight:e.measureText("M").width}}},{key:"layoutFeature",value:function(e,t,r,a,o,i){var l=0,s=0,c=e.get("mismatches"),u=e.get("seq");if(i&&u)for(var p=0;p<c.length;p+=1){var f=c[p],d=f.cliplen,g=void 0===d?0:d;"softclip"===f.type&&(0===f.start?l=g:s=g)}var h=le(m.bpSpanPx(e.get("start")-l,e.get("end")+s,o,a),2),y=h[0],v=h[1],b=n.readConfObject(r,"height",{feature:e}),C=n.readConfObject(r,"displayMode",{feature:e});if("compact"===C&&(b/=3),e.get("refName")!==o.refName)throw new Error("feature ".concat(e.id()," is not on the current region's reference sequence ").concat(o.refName));var w=t.addRect(e.id(),e.get("start")-l,e.get("end")+s,b);return null===w?null:{feature:e,leftPx:y,rightPx:v,topPx:"collapse"===C?0:w,heightPx:b}}},{key:"getExpandedRegion",value:function(e,t){var r=t.showSoftClip,a=n.readConfObject(t.config,"maxClippingSize"),o=e.start,i=e.end,l=Math.max(i-o,r?Math.round(a):0);return te(te({},e),{},{start:Math.floor(Math.max(o-l,0)),end:Math.ceil(i+l)})}},{key:"colorByOrientation",value:function(e,t){return ut[this.getOrientation(e,t)||"color_nostrand"]}},{key:"getOrientation",value:function(e,t){var r=n.readConfObject(t,"orientationType");return{LR:"color_pair_lr",RR:"color_pair_rr",RL:"color_pair_rl",LL:"color_pair_ll"}[lt[r][e.get("pair_orientation")]]}},{key:"colorByInsertSize",value:function(e,t){return e.get("is_paired")&&e.get("seq_id")!==e.get("next_seq_id")?"#555":"hsl(".concat(Math.abs(e.get("template_length"))/10,",50%,50%)")}},{key:"colorByStranded",value:function(e,t){var r=e.get("flags"),n=e.get("strand");if(1&r){var a=64&r?-1:1;return 2&r?n*a==1?"color_rev_strand":"color_fwd_strand":e.get("multi_segment_next_segment_unmapped")?n*a==1?"color_rev_missing_mate":"color_fwd_missing_mate":e.get("seq_id")===e.get("next_seq_id")?n*a==1?"color_rev_strand_not_proper":"color_fwd_strand_not_proper":1===n?"color_fwd_diff_chr":"color_rev_diff_chr"}return 1===n?"color_fwd_strand":"color_rev_strand"}},{key:"colorByPerBaseQuality",value:function(e,t,r,n,a){for(var o=t.feature,i=t.topPx,l=t.heightPx,s=(o.get("qual")||"").split(" ").map((function(e){return+e})),c=Se(o.get("CIGAR")),u=1/a,p=o.get("start"),f=0,d=0,g=0;g<s.length;f+=2,g++){var h=+c[f],y=c[f+1];if("S"===y||"I"===y)g+=h;else if("D"===y||"N"===y)d+=h;else if("M"===y||"X"===y||"="===y){for(var v=0;v<h;v++){var b=s[g+v];e.fillStyle="hsl(".concat(255===b?150:1.5*b,",55%,50%)");var C=le(m.bpSpanPx(p+d+v,p+d+v+1,n,a),1);e.fillRect(C[0],i,u+.5,l)}d+=h}}}},{key:"colorByModifications",value:function(e,t,r,n,a,o){var i=t.feature,l=t.topPx,s=t.heightPx,c=o.modificationTagMap,u=void 0===c?{}:c,p=it(i,"MM","Mm")||"",f=it(i,"ML","Ml")||[],d=f?("string"==typeof f?f.split(",").map((function(e){return+e})):f).map((function(e){return e/255})):it(i,"MP","Mp").split("").map((function(e){return e.charCodeAt(0)-33})).map((function(e){return Math.min(1,e/50)})),g=i.get("CIGAR"),h=i.get("start"),y=i.get("end"),v=i.get("seq"),b=Se(g),C=Pe(p,v),w=0;C.forEach((function(t){var r,o=t.positions,i=D(u[t.type]||"black"),c=ge(Ee(b,o));try{for(c.s();!(r=c.n()).done;){var p=r.value;if(p>=0&&h+p<y){var f=le(m.bpSpanPx(h+p,h+p+1,n,a),2),g=f[0],v=f[1];e.fillStyle=i.alpha(d[w]+.1).hsl().string(),e.fillRect(g,l,v-g+.5,s)}w++}}catch(e){c.e(e)}finally{c.f()}}))}},{key:"colorByMethylation",value:function(e,t,r,n,a,o){var i=o.regionSequence,l=t.feature,s=t.topPx,c=t.heightPx,u=it(l,"MM","Mm")||"";if(!i)throw new Error("region sequence required for methylation");var p=l.get("CIGAR"),f=l.get("start"),d=l.get("end"),g=l.get("seq"),h=Se(p),y=n.start,v=new Array(n.end-y).fill(0);Pe(u,g).forEach((function(e){var t=e.positions;if("m"===e.type&&t){var r,n=ge(Ee(h,t));try{for(n.s();!(r=n.n()).done;){var a=r.value+f-y;a>=0&&a<v.length&&(v[a]=1)}}catch(e){n.e(e)}finally{n.f()}}}));for(var b=f;b<d;b++){var C=b-y;if(C>=0&&C<v.length){var w=i[C+1];if("C"===i[C].toUpperCase()&&"G"===w.toUpperCase()){var S=le(m.bpSpanPx(y+C,y+C+1,n,a),2),k=S[0],x=S[1];e.fillStyle=v[C]?"red":"blue",e.fillRect(k,s,x-k+.5,c)}}}}},{key:"drawRect",value:function(e,t,r){var n=r.bpPerPx,a=t.heightPx,o=t.topPx,i=t.feature,l=le(r.regions,1)[0],s=le(m.bpSpanPx(i.get("start"),i.get("end"),l,n),2),c=s[0],u=s[1],p=l.reversed?-1:1,f=i.get("strand")*p;n<10?-1===f?(e.beginPath(),e.moveTo(c-5,o+a/2),e.lineTo(c,o+a),e.lineTo(u,o+a),e.lineTo(u,o),e.lineTo(c,o),e.closePath(),e.fill()):(e.beginPath(),e.moveTo(c,o),e.lineTo(c,o+a),e.lineTo(u,o+a),e.lineTo(u+5,o+a/2),e.lineTo(u,o),e.closePath(),e.fill()):e.fillRect(c,o,u-c,a)}},{key:"drawAlignmentRect",value:function(e,t,r){var a=r.config,o=r.bpPerPx,i=r.colorTagMap,l=void 0===i?{}:i,s=r.colorBy||{},c=s.tag,u=void 0===c?"":c,p=s.type,f=void 0===p?"":p,d=t.feature,g=r.regions[0];switch(f){case"insertSize":e.fillStyle=this.colorByInsertSize(d,a);break;case"strand":e.fillStyle=-1===d.get("strand")?"#8F8FD8":"#EC8B8B";break;case"mappingQuality":e.fillStyle="hsl(".concat(d.get("mq"),",50%,50%)");break;case"pairOrientation":e.fillStyle=this.colorByOrientation(d,a);break;case"stranded":e.fillStyle=ut[this.colorByStranded(d,a)];break;case"xs":case"tag":var h=d.get("tags"),m=h?h[u]:d.get(u);if("XS"!==u&&"TS"!==u||(e.fillStyle=ut[{"-":"color_rev_strand","+":"color_fwd_strand"}[m]||"color_nostrand"]),"ts"===u){var y={"-":-1===d.get("strand")?"color_fwd_strand":"color_rev_strand","+":-1===d.get("strand")?"color_rev_strand":"color_fwd_strand"};e.fillStyle=ut[y[m]||"color_nostrand"]}else e.fillStyle=l[m]||"color_nostrand";break;case"insertSizeAndPairOrientation":break;case"normal":default:e.fillStyle=n.readConfObject(a,"color",{feature:d})}switch(this.drawRect(e,t,r),f){case"perBaseQuality":this.colorByPerBaseQuality(e,t,a,g,o);break;case"modifications":this.colorByModifications(e,t,a,g,o,r);break;case"methylation":this.colorByMethylation(e,t,a,g,o,r)}}},{key:"drawMismatches",value:function(e,t,r,a,o,i){var l=i.mismatchAlpha,s=i.drawSNPs,c=void 0===s||s,u=i.drawIndels,p=void 0===u||u,f=r.config,d=r.bpPerPx,g=r.regions,h=t.heightPx,y=t.topPx,v=t.feature,b=this.getCharWidthHeight(e),C=b.charWidth,w=b.charHeight,S=le(g,1)[0],k=v.get("start"),x=n.readConfObject(f,"minSubfeatureWidth"),_=n.readConfObject(f,"largeInsertionIndicatorScale"),E=Math.min(1/d,2),P=Math.max(x,E),T=v.get("mismatches"),M=w-2;function R(e,t){var r=e;return l&&void 0!==t.qual&&(r=D(e).alpha(Math.min(1,t.qual/50)).hsl().string()),r}for(var N=0;N<T.length;N+=1){var B=T[N],A=le(m.bpSpanPx(k+B.start,k+B.start+B.length,S,d),2),I=A[0],L=Math.max(x,Math.abs(I-A[1]));if("mismatch"===B.type&&c){var q=o[B.base]||"#888";e.fillStyle=R(q,B),e.fillRect(I,y,L,h),L>=C&&h>=M&&(e.fillStyle=R(a.palette.getContrastText(q),B),e.fillText(B.base,I+(L-C)/2+1,y+h))}else if("deletion"===B.type&&p){var F=o.deletion;e.fillStyle=F,e.fillRect(I,y,L,h),L>=C&&h>=M&&(e.fillStyle=a.palette.getContrastText(F),e.fillText(B.base,I+(L-C)/2+1,y+h))}else if("insertion"===B.type&&p){e.fillStyle="purple";var O=I-1;(+B.base||B.length)<10&&(e.fillRect(O,y,P,h),1/d>=C&&(e.fillRect(O-P,y,3*P,1),e.fillRect(O-P,y+h-1,3*P,1)),1/d>=C&&h>=M&&e.fillText("(".concat(B.base,")"),I+2,y+h))}else if("hardclip"===B.type||"softclip"===B.type){e.fillStyle="hardclip"===B.type?"red":"blue";var j=I-1;e.fillRect(j,y+1,P,h-2),e.fillRect(j-P,y,3*P,1),e.fillRect(j-P,y+h-1,3*P,1),L>=C&&h>=M&&e.fillText("(".concat(B.base,")"),I+2,y+h)}else"skip"===B.type&&(I+L>0&&e.clearRect(I,y,L-(d>10?1.5:0),h),e.fillStyle="#333",e.fillRect(I,y+h/2,L,2))}if(p)for(var H=0;H<T.length;H+=1){var V=T[H],z=le(m.bpSpanPx(v.get("start")+V.start,v.get("start")+V.start+V.length,S,d),1)[0],G=+V.base||V.length,W="".concat(G);if("insertion"===V.type&&G>=10)if(d>_)e.fillStyle="purple",e.fillRect(z-1,y,2,h);else if(h>w){var U=e.measureText(W);e.fillStyle="purple",e.fillRect(z-U.width/2-5,y,U.width+10,h),e.fillStyle="white",e.fillText(W,z-U.width/2,y+h)}else e.fillStyle="purple",e.fillRect(z-2,y,4,h)}}},{key:"drawSoftClipping",value:function(e,t,r,a,o){var i=t.feature,l=t.topPx,s=t.heightPx,c=r.bpPerPx,u=le(r.regions,1)[0],p=n.readConfObject(a,"minSubfeatureWidth"),f=i.get("mismatches"),d=i.get("seq"),g=this.getCharWidthHeight(e),h=g.charWidth,y=g.charHeight,v={A:o.palette.bases.A.main,C:o.palette.bases.C.main,G:o.palette.bases.G.main,T:o.palette.bases.T.main,deletion:"#808080"};d&&f.filter((function(e){return"softclip"===e.type})).forEach((function(t){for(var r=t.cliplen||0,n=0===t.start?i.get("start")-r:i.get("start")+t.start,a=0;a<r;a+=1){var f=d.charAt(a+t.start);if(!f)return;var g=le(m.bpSpanPx(n+a,n+a+1,u,c),2),b=g[0],C=Math.max(p,Math.abs(b-g[1])),w=v[f]||"#000000";e.fillStyle=w,e.fillRect(b,l,C,s),C>=h&&s>=y-5&&(e.fillStyle=o.palette.getContrastText(w),e.fillText(f,b+(C-h)/2+1,l+s))}}))}},{key:"makeImageData",value:(r=Q(Ce.mark((function e(t,r,a){var o,i,l,s,c,u,p,f,d=this;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=a.layout,l=a.showSoftClip,s=a.colorBy,c=a.theme,u=n.readConfObject(i=a.config,"mismatchAlpha"),p=v.createJBrowseTheme(c),f=ct(p),o){e.next=6;break}throw new Error("layout required");case 6:if(o.addRect){e.next=8;break}throw new Error("invalid layout object");case 8:t.font="bold 10px Courier New,monospace",r.forEach((function(e){if(null!==e){var r=e.feature,o=e.topPx,c=e.heightPx;t.fillStyle=n.readConfObject(i,"color",{feature:r}),d.drawAlignmentRect(t,{feature:r,topPx:o,heightPx:c},a),d.drawMismatches(t,e,a,p,f,{mismatchAlpha:u,drawSNPs:pt(null==s?void 0:s.type),drawIndels:pt(null==s?void 0:s.type)}),l&&d.drawSoftClipping(t,e,a,i,p)}}));case 10:case"end":return e.stop()}}),e)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"layoutFeats",value:function(e){var t=this,r=e.layout,n=e.features,a=e.sortedBy,o=e.config,i=e.bpPerPx,l=e.showSoftClip,s=le(e.regions,1)[0];if(!r)throw new Error("layout required");if(!r.addRect)throw new Error("invalid layout object");var c=(a&&a.type&&s.start===a.pos?function(e,t){var r=Array.from(e.values()),n=[],a=[],o=t.pos,i=t.type;r.forEach((function(e){var t=e,r=t.get("start"),i=t.get("end");q.doesIntersect2(o-1,o,r,i)?n.push(e):a.push(e)}));var l=!!r.length&&r[0].get("tags");switch(i){case"Start location":n.sort((function(e,t){return e.get("start")-t.get("start")}));break;case"tag":var s=t.tag,c=function(e,t){return l?e.get("tags")[t]:e.get(t)},u=n[0]&&"string"==typeof c(n[0],s);n.sort(u?function(e,t){return c(t,s).localeCompare(c(e,s))}:function(e,t){return(c(t,s)||0)-(c(e,s)||0)});break;case"Base pair":var p=[];n.forEach((function(e){e.get("mismatches").forEach((function(t){var r=e.get("start")+t.start+1;o>=r&&o<r+("insertion"===t.type||"softclip"===t.type?0:t.length)&&p.push([e.id(),t])}))}));var f=new Map(p);n.sort((function(e,t){var r=f.get(e.id()),n=f.get(t.id()),a=n&&n.base.toUpperCase(),o=r&&r.base.toUpperCase();return a===o&&"*"===a?r.length-n.length:(a?a.charCodeAt(0):0)-(o?o.charCodeAt(0):0)}));break;case"Read strand":n.sort((function(e,t){return e.get("strand")<=t.get("strand")?1:-1}))}return new Map(n.concat(a).map((function(e){return[e.id(),e]})))}(n,a):null)||n;return m.iterMap(c.values(),(function(e){return t.layoutFeature(e,r,o,i,s,l)}),c.size)}},{key:"render",value:(t=Q(Ce.mark((function e(t){var r,n,a,i,l,s,c,u,p,f,d,g,h,m,y=this;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.bpPerPx,n=t.regions,e.next=3,this.getFeatures(t);case 3:if(a=e.sent,i=this.createLayoutInWorker(t),l=this.layoutFeats(te(te({},t),{},{features:a,layout:i})),!t.adapterConfig.sequenceAdapter){e.next=12;break}return e.next=9,L.getAdapter(this.pluginManager,t.sessionId,t.adapterConfig.sequenceAdapter);case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0={};case 13:if(s=e.t0.dataAdapter,c=le(n,1),u=c[0],!s){e.next=22;break}return e.next=19,s.getFeatures({start:u.start,end:u.end+1,refName:u.refName,assemblyName:u.assemblyName}).pipe(N.toArray()).toPromise();case 19:e.t1=e.sent,e.next=23;break;case 22:e.t1=[];case 23:return p=le(e.t1,1),d=null==(f=p[0])?void 0:f.get("seq"),g=(u.end-u.start)/r,h=Math.max(i.getTotalHeight(),1),e.next=31,I.renderToAbstractCanvas(g,h,t,(function(e){return y.makeImageData(e,l,te(te({},t),{},{layout:i,features:a,regionSequence:d}))}));case 31:return m=e.sent,e.next=34,ie(ne(o.prototype),"render",this).call(this,te(te(te({},t),m),{},{features:a,layout:i,height:h,width:g}));case 34:return e.abrupt("return",te(te(te({},e.sent),m),{},{features:a,layout:i,height:h,width:g,maxHeightReached:i.maxHeightReached}));case 36:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"createSession",value:function(e){return new st(e)}}]),o}(),dt=function(e){return d.types.late((function(){return n.ConfigurationSchema("SNPCoverageAdapter",{subadapter:e.pluggableConfigSchemaType("adapter")},{explicitlyTyped:!0})}))};function gt(e){return ht(e.type)?1:e.length}function ht(e){return"softclip"===e||"hardclip"===e||"insertion"===e}function mt(e,t,r,n){e[r][n]||(e[r][n]={total:0,strands:{"-1":0,0:0,1:0}}),e[r][n].total++,e[r][n].strands[t]++}function yt(e,t,r,n){e[r][n]||(e[r][n]={total:0,strands:{"-1":0,0:0,1:0}}),e[r][n].total--,e[r][n].strands[t]--}var vt=function(e){re(i,F.BaseFeatureDataAdapter);var t,r,a,o=oe(i);function i(){return Z(this,i),o.apply(this,arguments)}return $(i,[{key:"configure",value:(a=Q(Ce.mark((function e(){var t,r,a,o,i,l;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n.readConfObject(this.config,"subadapter"),o=n.readConfObject(this.config,["subadapter","sequenceAdapter"]),e.next=4,null===(t=this.getSubAdapter)||void 0===t?void 0:t.call(this,a);case 4:if(i=e.sent,!o){e.next=11;break}return e.next=8,null===(r=this.getSubAdapter)||void 0===r?void 0:r.call(this,o);case 8:e.t0=e.sent,e.next=12;break;case 11:e.t0=void 0;case 12:if(l=e.t0,i){e.next=15;break}throw new Error("Failed to get subadapter");case 15:return e.abrupt("return",{subadapter:i.dataAdapter,sequenceAdapter:null==l?void 0:l.dataAdapter});case 16:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"getFeatures",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return j.ObservableCreate(function(){var n=Q(Ce.mark((function n(a){var o,i;return Ce.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.configure();case 2:return o=n.sent.subadapter.getFeatures(e,r),r.filters&&(i=r.filters,o=o.pipe(N.filter((function(e){return i.passes(e,r)})))),n.next=8,t.generateCoverageBins(o,e,r);case 8:n.sent.forEach((function(r,n){r.total&&a.next(new O({id:"".concat(t.id,"-").concat(e.start,"-").concat(n),data:{score:r.total,snpinfo:r,start:e.start+n,end:e.start+n+1,refName:e.refName}}))})),a.complete();case 11:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),r.signal)}},{key:"getRefNames",value:(r=Q(Ce.mark((function e(){var t,r=arguments;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:{},e.next=3,this.configure();case 3:return e.abrupt("return",e.sent.subadapter.getRefNames(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"freeResources",value:function(){}},{key:"generateCoverageBins",value:(t=Q(Ce.mark((function e(t,r,n){var a,o,i,l,s,c,u,p,f,d;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n.colorBy,e.next=3,this.configure();case 3:if(o=e.sent.sequenceAdapter,i=r.refName,l=r.start,s=r.end,c=Math.ceil(r.end-r.start),u=Array.from({length:c},(function(){return{total:0,lowqual:{},cov:{},delskips:{},noncov:{},ref:{}}})),!o){e.next=15;break}return e.next=11,o.getFeatures({refName:i,start:l,end:s+1,assemblyName:"na"}).pipe(N.toArray()).toPromise();case 11:f=le(e.sent,1),p=null==(d=f[0])?void 0:d.get("seq");case 15:return e.abrupt("return",t.pipe(N.reduce((function(e,t){for(var n=t.get("CIGAR"),o=t.get("start"),i=t.get("end"),l=t.get("strand"),s=Se(n),c=o;c<i;c++){var u=c-r.start;if(u>=0&&u<e.length){var f=e[u];f.total++,mt(f,l,"ref","ref")}}if("modifications"===(null==a?void 0:a.type)){var d=t.get("seq"),g=it(t,"MM","Mm")||"",h=it(t,"ML","Ml")||[],m=h?("string"==typeof h?h.split(",").map((function(e){return+e})):h).map((function(e){return e/255})):it(t,"MP","Mp").split("").map((function(e){return e.charCodeAt(0)-33})).map((function(e){return Math.min(1,e/50)})),y=0;Pe(g,d).forEach((function(t){var n,a=t.positions,c="mod_".concat(t.type),u=ge(Ee(s,a));try{for(u.s();!(n=u.n()).done;){var p=n.value,f=p+o-r.start;f>=0&&f<e.length&&p+o<i&&mt(e[f],l,m[y]>.5?"cov":"lowqual",c),y++}}catch(e){u.e(e)}finally{u.f()}}))}else if("methylation"===(null==a?void 0:a.type)){if(!p)throw new Error("no region sequence detected, need sequenceAdapter configuration");var v=t.get("seq"),b=it(t,"MM","Mm")||"",C=new Array(r.end-r.start).fill(0);Pe(b,v).forEach((function(e){if("m"===e.type){var t,n=ge(Ee(s,e.positions));try{for(n.s();!(t=n.n()).done;){var a=t.value+o-r.start;a>=0&&a<C.length&&(C[a]=1)}}catch(e){n.e(e)}finally{n.f()}}}));for(var w=o;w<i;w++){var S=w-r.start;if(S>=0&&S<e.length){var k=p[S+1],x=e[S];"C"===p[S].toUpperCase()&&"G"===k.toUpperCase()&&(C[S]?(mt(x,l,"cov","meth"),yt(x,l,"ref","ref")):(mt(x,l,"cov","unmeth"),yt(x,l,"ref","ref")))}}}else for(var _=t.get("mismatches"),E=0;E<(null==_?void 0:_.length);E++)for(var P=_[E],T=o+P.start,M=T;M<T+gt(P);M++){var R=M-r.start;if(R>=0&&R<e.length){var N=e[R],B=P.base,A=P.type,D=ht(A);D?mt(N,l,"noncov",A):yt(N,l,"ref","ref"),"deletion"===A||"skip"===A?(mt(N,l,"delskips",A),N.total--):D||mt(N,l,"cov",B)}}return e}),u)).toPromise());case 16:case"end":return e.stop()}}),e,this)}))),function(e,r,n){return t.apply(this,arguments)})}]),i}(),bt=vt.capabilities,Ct={__proto__:null,default:vt,capabilities:bt},wt=function(e){return{getAdapterClass:function(){return Promise.resolve().then((function(){return Ct})).then((function(e){return e.default}))},configSchema:dt(e),adapterCapabilities:bt}},St=n.ConfigurationSchema("SNPCoverageRenderer",{clipColor:{type:"color",description:"the color of the clipping marker",defaultValue:"red"},indicatorThreshold:{type:"number",description:"the proportion of reads containing a insertion/clip indicator",defaultValue:.3},drawInterbaseCounts:{type:"boolean",description:'draw count "upsidedown histogram" of the interbase events that don\'t contribute to the coverage count so are not drawn in the normal histogram',defaultValue:!0},drawIndicators:{type:"boolean",description:"draw a triangular indicator where an event has been detected",defaultValue:!0}},{explicitlyTyped:!0}),kt=function(e){re(r,p.WiggleBaseRenderer);var t=oe(r);function r(){return Z(this,r),t.apply(this,arguments)}return $(r,[{key:"draw",value:function(e,t){var r=t.features,a=t.regions,o=t.bpPerPx,i=t.scaleOpts,l=t.height,s=t.config,c=t.displayCrossHatches,u=t.ticks.values,f=t.modificationTagMap,d=v.createJBrowseTheme(t.theme),g=le(a,1)[0],h=(g.end-g.start)/o,y=p.YSCALEBAR_LABEL_OFFSET,b=l-2*y,C=te(te({},i),{},{range:[0,b]}),w=p.getScale(C),S=p.getScale(te(te({},C),{},{scaleType:"linear"})),k=p.getOrigin(i.scaleType),x=p.getOrigin("linear"),_=n.readConfObject(s,"indicatorThreshold"),E=n.readConfObject(s,"drawInterbaseCounts"),P=n.readConfObject(s,"drawIndicators"),T=function(e){return b-w(e)+y},M=function(e){return b-S(e)+y},R=function(e){return M(x)-M(e)},N={A:d.palette.bases.A.main,C:d.palette.bases.C.main,G:d.palette.bases.G.main,T:d.palette.bases.T.main,total:"lightgrey",insertion:"purple",softclip:"blue",hardclip:"red",meth:"red",unmeth:"blue",ref:"lightgrey"};e.fillStyle=N.total;var B,A,D=ge(r.values());try{for(D.s();!(B=D.n()).done;){var I=B.value,L=le(m.featureSpanPx(I,g,o),2),q=L[0],F=L[1]-q+.3,O=I.get("score");e.fillRect(q,T(O),F,(A=O,T(k)-T(A)))}}catch(e){D.e(e)}finally{D.f()}e.fillStyle="grey",e.beginPath(),e.lineTo(0,0),e.moveTo(0,h),e.stroke();var j,H=ge(r.values());try{var V=function(){var t=j.value,r=le(m.featureSpanPx(t,g,o),2),n=r[0],a=r[1],i=t.get("snpinfo"),l=Math.max(a-n+.3,1),s=i.total;Object.entries(i.cov).sort((function(e,t){var r=le(e,1)[0],n=le(t,1)[0];return r<n?-1:r>n?1:0})).reduce((function(t,r){var a=le(r,2),o=a[0],i=a[1].total;return e.fillStyle=N[o]||f[o.replace("mod_","")]||"red",e.fillRect(n,M(i+t),l,R(i)),t+i}),0);var c=Object.entries(i.noncov);if(E&&c.reduce((function(t,r){var a=le(r,2),o=a[1].total;return e.fillStyle=N[a[0]],e.fillRect(n-.6,4.5+R(t),1.2,R(o)),t+o}),0),P){var u=0,p=0,d="";c.forEach((function(e){var t=le(e,2),r=t[1].total;u+=r,r>p&&(p=r,d=t[0])})),u>s*_&&s>7&&(e.fillStyle=N[d],e.beginPath(),e.moveTo(n-3,0),e.lineTo(n+3,0),e.lineTo(n,4.5),e.fill())}};for(H.s();!(j=H.n()).done;)V()}catch(e){H.e(e)}finally{H.f()}c&&(e.lineWidth=1,e.strokeStyle="rgba(140,140,140,0.8)",u.forEach((function(t){e.beginPath(),e.moveTo(0,Math.round(T(t))),e.lineTo(h,Math.round(T(t))),e.stroke()})))}}]),r}(),xt=n.ConfigurationSchema("SNPCoverageRenderer",{},{baseConfiguration:St,explicitlyTyped:!0}),_t=function(e){re(a,H);var t,r,n=oe(a);function a(){var e;return Z(this,a),(e=n.apply(this,arguments)).name="PileupGetGlobalValueForTag",e}return $(a,[{key:"serializeArguments",value:(r=Q(Ce.mark((function e(t){var r,n,a;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=null==(n=this.pluginManager.rootModel)||null===(r=n.session)||void 0===r?void 0:r.assemblyManager){e.next=4;break}throw new Error("no assembly manager available");case 4:return e.abrupt("return",m.renameRegionsIfNeeded(a,t));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"execute",value:(t=Q(Ce.mark((function e(t,r){var n,a,o,i,l,s,c,u;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deserializeArguments(t,r);case 2:return a=(n=e.sent).adapterConfig,o=n.sessionId,i=n.regions,l=n.tag,e.next=6,L.getAdapter(this.pluginManager,o,a);case 6:return s=e.sent.dataAdapter.getFeaturesInMultipleRegions(i),e.next=10,s.pipe(N.toArray()).toPromise();case 10:return c=e.sent,u=new Set,c.forEach((function(e){var t=e.get("tags"),r=t?t[l]:e.get(l);void 0!==r&&u.add("".concat(r))})),e.abrupt("return",se(u));case 14:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})}]),a}(),Et=function(e){re(a,H);var t,r,n=oe(a);function a(){var e;return Z(this,a),(e=n.apply(this,arguments)).name="PileupGetVisibleModifications",e}return $(a,[{key:"serializeArguments",value:(r=Q(Ce.mark((function e(t){var r,n,a;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=null==(n=this.pluginManager.rootModel)||null===(r=n.session)||void 0===r?void 0:r.assemblyManager){e.next=4;break}throw new Error("no assembly manager available");case 4:return e.abrupt("return",m.renameRegionsIfNeeded(a,t));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"execute",value:(t=Q(Ce.mark((function e(t,r){var n,a,o,i,l,s,c;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deserializeArguments(t,r);case 2:return a=(n=e.sent).adapterConfig,o=n.sessionId,i=n.regions,e.next=6,L.getAdapter(this.pluginManager,o,a);case 6:return l=e.sent.dataAdapter.getFeaturesInMultipleRegions(i),e.next=10,l.pipe(N.toArray()).toPromise();case 10:return s=e.sent,c=new Set,s.forEach((function(e){var t=it(e,"MM","Mm")||"";void 0!==t&&Te(t).forEach((function(e){return c.add(e)}))})),e.abrupt("return",se(c));case 14:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})}]),a}(),Pt=function(e){re(f,c);var r=oe(f);function f(){var e;return Z(this,f),(e=r.apply(this,arguments)).name="AlignmentsPlugin",e}return $(f,[{key:"install",value:function(e){e.addTrackType((function(){var t=n.ConfigurationSchema("AlignmentsTrack",{},{baseConfiguration:i.createBaseTrackConfig(e)}),r=new l({name:"AlignmentsTrack",configSchema:t,stateModel:i.createBaseTrackModel(e,"AlignmentsTrack",t)}),a=e.getDisplayType("LinearAlignmentsDisplay");return r.addDisplayType(a),r})),e.addDisplayType((function(){var t=function(e){var t=e.getRendererType("PileupRenderer").configSchema,r=e.getRendererType("SvgFeatureRenderer").configSchema;return n.ConfigurationSchema("LinearPileupDisplay",{defaultRendering:{type:"stringEnum",model:d.types.enumeration("Rendering",["pileup","svg"]),defaultValue:"pileup"},renderers:n.ConfigurationSchema("RenderersConfiguration",{PileupRenderer:t,SvgFeatureRenderer:r}),renderer:"",maxDisplayedBpPerPx:{type:"number",description:"maximum bpPerPx that is displayed in the view",defaultValue:100},colorScheme:{type:"stringEnum",model:d.types.enumeration("colorScheme",["strand","normal","insertSize","insertSizeAndOrientation","mappingQuality","tag"]),description:"color scheme to use",defaultValue:"normal"}},{baseConfiguration:u.linearBasicDisplayConfigSchemaFactory(e),explicitlyTyped:!0})}(e);return new o({name:"LinearPileupDisplay",configSchema:t,stateModel:Ze(e,t),trackType:"AlignmentsTrack",viewType:"LinearGenomeView",ReactComponent:u.BaseLinearDisplayComponent})})),e.addDisplayType((function(){var t=function(e){var t=e.getRendererType("SNPCoverageRenderer").configSchema;return n.ConfigurationSchema("LinearSNPCoverageDisplay",{autoscale:{type:"stringEnum",defaultValue:"local",model:d.types.enumeration("Autoscale type",["local"]),description:"performs local autoscaling (no other options for SNP Coverage available)"},minScore:{type:"number",defaultValue:Number.MIN_VALUE,description:"minimum value for the y-scale"},maxScore:{type:"number",description:"maximum value for the y-scale",defaultValue:Number.MAX_VALUE},scaleType:{type:"stringEnum",model:d.types.enumeration("Scale type",["linear","log"]),description:"The type of scale to use",defaultValue:"linear"},inverted:{type:"boolean",description:"draw upside down",defaultValue:!1},maxDisplayedBpPerPx:{type:"number",description:"maximum bpPerPx that is displayed in the view",defaultValue:100},headroom:{type:"number",description:"round the upper value of the domain scale to the nearest N",defaultValue:0},renderers:n.ConfigurationSchema("RenderersConfiguration",{SNPCoverageRenderer:t})},{baseConfiguration:u.baseLinearDisplayConfigSchema,explicitlyTyped:!0})}(e);return new o({name:"LinearSNPCoverageDisplay",configSchema:t,stateModel:tt(e,t),trackType:"AlignmentsTrack",viewType:"LinearGenomeView",ReactComponent:p.LinearWiggleDisplayReactComponent})})),e.addDisplayType((function(){var t=function(e){var t=e.getDisplayType("LinearPileupDisplay").configSchema,r=e.getDisplayType("LinearSNPCoverageDisplay").configSchema;return n.ConfigurationSchema("LinearAlignmentsDisplay",{pileupDisplay:t,snpCoverageDisplay:r},{baseConfiguration:u.baseLinearDisplayConfigSchema,explicitlyTyped:!0})}(e);return new o({name:"LinearAlignmentsDisplay",configSchema:t,stateModel:De(e,t),trackType:"AlignmentsTrack",viewType:"LinearGenomeView",ReactComponent:Le})})),e.addWidgetType((function(){return new s({name:"AlignmentsFeatureWidget",heading:"Feature details",configSchema:he,stateModel:me(e),ReactComponent:t.lazy((function(){return Promise.resolve().then((function(){return sr}))}))})})),e.addAdapterType((function(){return new a(te({name:"BamAdapter"},e.load(ve)))})),e.addAdapterType((function(){return new a(te({name:"SNPCoverageAdapter"},e.load(wt)))})),e.addAdapterType((function(){return new a(te({name:"CramAdapter"},e.load(Ne)))})),e.addAdapterType((function(){return new a(te({name:"HtsgetBamAdapter"},e.load(Ae)))})),e.addRendererType((function(){return new ft({name:"PileupRenderer",ReactComponent:nt,configSchema:at,pluginManager:e})})),e.addRendererType((function(){return new kt({name:"SNPCoverageRenderer",ReactComponent:p.WiggleRendering,configSchema:xt,pluginManager:e})})),e.addRpcMethod((function(){return new _t(e)})),e.addRpcMethod((function(){return new Et(e)}))}}]),f}(),Tt=function(){function e(t,r,n){Z(this,e),this.record=t,this.adapter=r,this.ref=n}return $(e,[{key:"_get_name",value:function(){return this.record.get("name")}},{key:"_get_type",value:function(){return"match"}},{key:"_get_score",value:function(){return this.record.get("mq")}},{key:"_get_flags",value:function(){return this.record.flags}},{key:"_get_strand",value:function(){return this.record.isReverseComplemented()?-1:1}},{key:"_get_read_group_id",value:function(){return this.record.readGroupId}},{key:"_get_pair_orientation",value:function(){return this.record.isPaired()?this.record.getPairOrientation():void 0}},{key:"_get_next_seq_id",value:function(){return this.record._next_refid()}},{key:"_get_seq_id",value:function(){return this.record._refID}},{key:"_get_next_refName",value:function(){return this.adapter.refIdToName(this.record._next_refid())}},{key:"_get_next_segment_position",value:function(){return this.record.isPaired()?"".concat(this.adapter.refIdToName(this.record._next_refid()),":").concat(this.record._next_pos()+1):void 0}},{key:"_get_seq",value:function(){return this.record.getReadBases()}},{key:"_get_MD",value:function(){var e=this.record.get("MD"),t=this.get("seq");return!e&&t&&this.ref?_e(this.ref,this.record.getReadBases(),this.get("CIGAR")):e}},{key:"qualRaw",value:function(){return this.record.qualRaw()}},{key:"set",value:function(){}},{key:"tags",value:function(){var t=Object.getOwnPropertyNames(e.prototype);return se(new Set(t.filter((function(e){return e.startsWith("_get_")&&"_get_mismatches"!==e&&"_get_skips_and_dels"!==e&&"_get_cram_read_features"!==e&&"_get_tags"!==e&&"_get_next_seq_id"!==e&&"_get_seq_id"!==e})).map((function(e){return e.replace("_get_","")})).concat(this.record._tags())))}},{key:"id",value:function(){return"".concat(this.adapter.id,"-").concat(this.record.id())}},{key:"get",value:function(e){var t="_get_".concat(e);return this[t]?this[t]():this.record.get(e)}},{key:"_get_refName",value:function(){return this.adapter.refIdToName(this.record.seq_id())}},{key:"parent",value:function(){}},{key:"children",value:function(){}},{key:"pairedFeature",value:function(){return!1}},{key:"toJSON",value:function(){var e=this;return te(te({},Object.fromEntries(this.tags().map((function(t){return[t,e.get(t)]})).filter((function(e){return void 0!==e[1]})))),{},{uniqueId:this.id()})}},{key:"_get_skips_and_dels",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{cigarAttributeName:"CIGAR"},t=e.cigarAttributeName,r=[],n=[],a=this.get(t);return a&&(n=Se(a),r=r.concat(ke(n,this.get("seq"),this.qualRaw()))),r}},{key:"_get_mismatches",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.cigarAttributeName,r=void 0===t?"CIGAR":t,n=e.mdAttributeName,a=void 0===n?"MD":n,o=[],i=[],l=this.get(r);l&&(i=Se(l),o=o.concat(ke(i,this.get("seq"),this.qualRaw())));var s=this.get(a);s&&(o=o.concat(xe(s,i,o,this.get("seq"),this.qualRaw())));var c={};return o.filter((function(e){var t="".concat(e.type,",").concat(e.start,",").concat(e.length),r=c[t];return c[t]=!0,!r}))}},{key:"_get_clipPos",value:function(){var e=this.get("CIGAR")||"";return-1===this.get("strand")?+(e.match(/(\d+)[SH]$/)||[])[1]||0:+(e.match(/^(\d+)([SH])/)||[])[1]||0}}]),e}(),Mt=function(e){re(s,F.BaseFeatureDataAdapter);var t,r,a,o,i,l=oe(s);function s(){return Z(this,s),l.apply(this,arguments)}return $(s,[{key:"configure",value:(i=Q(Ce.mark((function e(){var t,r,a,o,i,l,s;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.configured||(t=n.readConfObject(this.config,"bamLocation"),r=n.readConfObject(this.config,["index","location"]),a=n.readConfObject(this.config,["index","indexType"]),o=n.readConfObject(this.config,"chunkSizeLimit"),i=n.readConfObject(this.config,"fetchSizeLimit"),l=new V.BamFile({bamFilehandle:z.openLocation(t),csiFilehandle:"CSI"===a?z.openLocation(r):void 0,baiFilehandle:"CSI"!==a?z.openLocation(r):void 0,chunkSizeLimit:o,fetchSizeLimit:i}),s=n.readConfObject(this.config,"sequenceAdapter"),this.configured=s&&this.getSubAdapter?this.getSubAdapter(s).then((function(e){return{bam:l,sequenceAdapter:e.dataAdapter}})):Promise.resolve({bam:l})),e.abrupt("return",this.configured);case 2:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"getHeader",value:(o=Q(Ce.mark((function e(t){return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.configure();case 2:return e.abrupt("return",e.sent.bam.getHeaderText(t));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"setup",value:(a=Q(Ce.mark((function e(t){var r,n,a=this;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=void 0===(r=(t||{}).statusCallback)?function(){}:r,this.setupP||(this.setupP=this.configure().then(function(){var e=Q(Ce.mark((function e(r){var o,i,l;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.bam,n("Downloading index"),e.next=4,o.getHeader(t);case 4:return i=[],l={},e.sent.filter((function(e){return"SQ"===e.tag})).forEach((function(e,t){e.data.forEach((function(e){if("SN"===e.tag){var r=e.value;l[r]=t,i[t]=r}}))})),n(""),a.samHeader={idToName:i,nameToId:l},e.abrupt("return",a.samHeader);case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){throw a.setupP=void 0,e}))),e.abrupt("return",this.setupP);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"getRefNames",value:(r=Q(Ce.mark((function e(t){return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.setup(t);case 2:return e.abrupt("return",e.sent.idToName);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"seqFetch",value:(t=Q(Ce.mark((function e(t,r,n){var a,o,i,l;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.configure();case 2:if(a=e.sent.sequenceAdapter){e.next=7;break}return e.abrupt("return",void 0);case 7:if(t){e.next=9;break}return e.abrupt("return",void 0);case 9:return o=a.getFeatures({refName:t,start:r,end:n,assemblyName:""}),e.next=12,o.pipe(N.toArray()).toPromise();case 12:if(i=[],e.sent.sort((function(e,t){return e.get("start")-t.get("start")})).forEach((function(e){var t=e.get("start"),a=e.get("end"),o=Math.max(r-t,0),l=Math.min(n-t,a-t)-o,s=e.get("seq")||e.get("residues");i.push(s.substr(o,l))})),(l=i.join("")).length===n-r){e.next=18;break}throw new Error("sequence fetch failed: fetching ".concat(t,":").concat((r-1).toLocaleString(),"-").concat(n.toLocaleString()," returned ").concat(l.length.toLocaleString()," bases, but should have returned ").concat((n-r).toLocaleString()));case 18:return e.abrupt("return",l);case 19:case"end":return e.stop()}}),e,this)}))),function(e,r,n){return t.apply(this,arguments)})},{key:"getFeatures",value:function(e,t){var r=this,n=e.refName,a=e.start,o=e.end,i=e.originalRefName,l=t||{},s=l.signal,c=l.statusCallback,u=void 0===c?function(){}:c;return j.ObservableCreate(function(){var e=Q(Ce.mark((function e(l){var c,p,f,d,g,h;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.configure();case 2:return c=e.sent.bam,e.next=6,r.setup(t);case 6:return u("Downloading alignments"),e.next=9,c.getRecordsForRange(n,a,o,t);case 9:p=e.sent,m.checkAbortSignal(s),f=ge(p),e.prev=12,f.s();case 14:if((d=f.n()).done){e.next=24;break}if(h=void 0,(g=d.value).get("md")){e.next=21;break}return e.next=20,r.seqFetch(i||n,g.get("start"),g.get("end"));case 20:h=e.sent;case 21:l.next(new Tt(g,r,h));case 22:e.next=14;break;case 24:e.next=29;break;case 26:e.prev=26,e.t0=e.catch(12),f.e(e.t0);case 29:return e.prev=29,f.f(),e.finish(29);case 32:u(""),l.complete();case 34:case"end":return e.stop()}}),e,null,[[12,26,29,32]])})));return function(t){return e.apply(this,arguments)}}(),s)}},{key:"freeResources",value:function(){}},{key:"refIdToName",value:function(e){var t;return null===(t=this.samHeader)||void 0===t?void 0:t.idToName[e]}}]),s}(),Rt={__proto__:null,default:Mt},Nt=function(){function e(t,r){Z(this,e),this.record=t,this._store=r}return $(e,[{key:"_get_name",value:function(){return this.record.readName}},{key:"_get_start",value:function(){return this.record.alignmentStart-1}},{key:"_get_end",value:function(){return this.record.alignmentStart+this.record.lengthOnRef-1}},{key:"_get_cram_read_features",value:function(){return this.record.readFeatures}},{key:"_get_type",value:function(){return"match"}},{key:"_get_score",value:function(){return this.record.mappingQuality}},{key:"_get_flags",value:function(){return this.record.flags}},{key:"_get_strand",value:function(){return this.record.isReverseComplemented()?-1:1}},{key:"_read_group_id",value:function(){var e=this._store.samHeader.readGroups;return e?e[this.record.readGroupId]:void 0}},{key:"_get_qual",value:function(){return(this.record.qualityScores||[]).join(" ")}},{key:"qualRaw",value:function(){return this.record.qualityScores}},{key:"_get_seq_id",value:function(){return this._store.refIdToName(this.record.sequenceId)}},{key:"_get_refName",value:function(){return this._get_seq_id()}},{key:"_get_is_paired",value:function(){return!!this.record.mate}},{key:"_get_pair_orientation",value:function(){return this.record.isPaired()?this.record.getPairOrientation():void 0}},{key:"_get_template_length",value:function(){return this.record.templateLength||this.record.templateSize}},{key:"_get_next_seq_id",value:function(){return this.record.mate?this._store.refIdToName(this.record.mate.sequenceId):void 0}},{key:"_get_next_pos",value:function(){return this.record.mate?this.record.mate.alignmentStart:void 0}},{key:"_get_next_segment_position",value:function(){return this.record.mate?"".concat(this._store.refIdToName(this.record.mate.sequenceId),":").concat(this.record.mate.alignmentStart):void 0}},{key:"_get_tags",value:function(){var e=this._read_group_id(),t=this.record.tags;return void 0!==e?te(te({},t),{},{RG:e}):t}},{key:"_get_seq",value:function(){return this.record.getReadBases()}},{key:"_get_CIGAR",value:function(){var e="",t="",r="M",n=0,a=this.record._refRegion.seq,o=this.record._refRegion.start,i=this.record.alignmentStart,l=0;return void 0!==this.record.readFeatures?this.record.readFeatures.forEach((function(s){var c=s.code,u=s.refPos,p=s.sub,f=s.data;if(l=u-i,e+=a.substring(i-o,u-o),i=u,n&&"M"!==r&&(t+=n+r,n=0),l&&(r="M",n+=l),"b"===c){var d=f.split(","),g=String.fromCharCode.apply(String,se(d));e+=g,i+=g.length,n+=g.length}else"B"===c||"X"===c?(e+=p,i++,n++):"D"===c||"N"===c?(i+=f,n&&(t+=n+r),t+=f+c,n=0):"I"===c||"S"===c?(e+=f,n&&(t+=n+r),t+=f.length+c,n=0):"i"===c?(e+=f,n&&(t+=n+r),t+="".concat(1,"I"),n=0):"P"===c?(n&&(t+=n+r),t+="".concat(f,"P")):"H"===c&&(n&&(t+=n+r),t+="".concat(f,"H"),n=0)})):l=this.record.readLength-e.length,e.length!==this.record.readLength&&(e+=a.substring(i-o,i-o+(l=this.record.readLength-e.length)),n&&"M"!==r&&(t+=n+r,n=0),r="M",n+=l),n&&(t+=n+r),t}},{key:"tags",value:function(){return Object.getOwnPropertyNames(e.prototype).filter((function(e){return e.startsWith("_get_")&&"_get_mismatches"!==e&&"_get_skips_and_dels"!==e&&"_get_cram_read_features"!==e})).map((function(e){return e.replace("_get_","")}))}},{key:"id",value:function(){return"".concat(this._store.id,"-").concat(this.record.uniqueId)}},{key:"get",value:function(e){var t="_get_".concat(e);if(this[t])return this[t]()}},{key:"parent",value:function(){}},{key:"children",value:function(){}},{key:"set",value:function(){}},{key:"pairedFeature",value:function(){return!1}},{key:"_get_clipPos",value:function(){var e=this.get("mismatches");if(e.length){var t=-1===this.get("strand")?e[e.length-1]:e[0],r=t.type;if("softclip"===r||"hardclip"===r)return t.cliplen}return 0}},{key:"toJSON",value:function(){var e=this,t={};return this.tags().forEach((function(r){var n=e.get(r);void 0!==n&&(t[r]=n)})),te(te({},t),{},{name:this.get("name"),type:this.get("type"),uniqueId:this.id()})}},{key:"_get_mismatches",value:function(){var e=this.get("cram_read_features"),t=this.qualRaw();if(!e)return[];var r=this.get("start"),n=[];return e.forEach((function(e){var a=e.code,o=e.data,i=e.refPos-1-r;if("X"===a)n.push({start:i,length:1,base:e.sub,qual:null==t?void 0:t[e.pos],altbase:e.ref,type:"mismatch"});else if("I"===a)n.push({start:i,type:"insertion",base:"".concat(o.length),length:0});else if("N"===a)n.push({type:"skip",length:o,start:i,base:"N"});else if("S"===a){var l=o.length;n.push({start:i,type:"softclip",base:"S".concat(l),cliplen:l,length:1})}else if("P"===a);else if("H"===a){var s=o;n.push({start:i,type:"hardclip",base:"H".concat(s),cliplen:s,length:1})}else"D"===a?n.push({type:"deletion",length:o,start:i,base:"*"}):"b"===a||"q"===a||"B"===a||"i"===a&&n.push({start:i,type:"insertion",base:o,length:1})})),n}},{key:"_get_skips_and_dels",value:function(){return this._get_mismatches()}}]),e}(),Bt={__proto__:null,default:function(e){re(s,F.BaseFeatureDataAdapter);var t,r,a,o,i,l=oe(s);function s(){var e;return Z(this,s),(e=l.apply(this,arguments)).samHeader={},e.seqIdToOriginalRefName=[],e}return $(s,[{key:"configure",value:(i=Q(Ce.mark((function e(){var t,r,a,o;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=n.readConfObject(this.config,"cramLocation"),r=n.readConfObject(this.config,"craiLocation"),t){e.next=4;break}throw new Error("missing cramLocation argument");case 4:if(r){e.next=6;break}throw new Error("missing craiLocation argument");case 6:if(this.cram=new G.IndexedCramFile({cramFilehandle:z.openLocation(t),index:new G.CraiIndex({filehandle:z.openLocation(r)}),seqFetch:this.seqFetch.bind(this),checkSequenceMD5:!1,fetchSizeLimit:this.config.fetchSizeLimit||6e8}),a=n.readConfObject(this.config,["sequenceAdapter","type"]),this.getSubAdapter){e.next=10;break}throw new Error("Error getting subadapter");case 10:return e.next=12,this.getSubAdapter(n.readConfObject(this.config,"sequenceAdapter"));case 12:if(!((o=e.sent.dataAdapter)instanceof F.BaseFeatureDataAdapter)){e.next=18;break}this.sequenceAdapter=o,e.next=19;break;case 18:throw new Error("CRAM feature adapters cannot use sequence adapters of type '".concat(a,"'"));case 19:return e.abrupt("return",{sequenceAdapter:this.sequenceAdapter});case 20:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"getHeader",value:(o=Q(Ce.mark((function e(t){return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.configure();case 2:return e.abrupt("return",this.cram.cram.getHeaderText(t));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"seqFetch",value:(a=Q(Ce.mark((function e(t,r,n){var a,o,i,l,s;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r-=1,a=this.sequenceAdapter){e.next=4;break}return e.abrupt("return",void 0);case 4:if(o=this.refIdToOriginalName(t)||this.refIdToName(t)){e.next=7;break}return e.abrupt("return",void 0);case 7:return i=a.getFeatures({refName:o,start:r,end:n,assemblyName:""},{}),e.next=10,i.pipe(N.toArray()).toPromise();case 10:if(l=[],e.sent.sort((function(e,t){return e.get("start")-t.get("start")})).forEach((function(e){var t=e.get("start"),a=e.get("end"),o=Math.max(r-t,0),i=Math.min(n-t,a-t)-o,s=e.get("seq")||e.get("residues");l.push(s.substr(o,i))})),(s=l.join("")).length===n-r){e.next=16;break}throw new Error("sequence fetch failed: fetching ".concat(o,":").concat((r-1).toLocaleString(),"-").concat(n.toLocaleString()," returned ").concat(s.length.toLocaleString()," bases, but should have returned ").concat((n-r).toLocaleString()));case 16:return e.abrupt("return",s);case 17:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return a.apply(this,arguments)})},{key:"setup",value:(r=Q(Ce.mark((function e(t){var r,n,a=this;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=void 0===(r=(t||{}).statusCallback)?function(){}:r,this.setupP||(this.setupP=this.configure().then(Q(Ce.mark((function e(){var r,o,i,l;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n("Downloading index"),e.next=3,a.cram.cram.getSamHeader(null==t?void 0:t.signal);case 3:return o=[],i={},(r=e.sent).filter((function(e){return"SQ"===e.tag})).forEach((function(e,t){e.data.forEach((function(e){if("SN"===e.tag){var r=e.value;i[r]=t,o[t]=r}}))})),l=r.filter((function(e){return"RG"===e.tag})).map((function(e){var t;return null===(t=e.data.find((function(e){return"ID"===e.tag})))||void 0===t?void 0:t.value})),o.length&&(a.samHeader={idToName:o,nameToId:i,readGroups:l}),n(""),e.abrupt("return",a.samHeader);case 11:case"end":return e.stop()}}),e)})))).catch((function(e){throw a.setupP=void 0,e}))),e.abrupt("return",this.setupP);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"getRefNames",value:(t=Q(Ce.mark((function e(t){return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.setup(t);case 2:if(!this.samHeader.idToName){e.next=4;break}return e.abrupt("return",this.samHeader.idToName);case 4:if(!this.sequenceAdapter){e.next=6;break}return e.abrupt("return",this.sequenceAdapter.getRefNames());case 6:throw new Error("unable to get refnames");case 7:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"refNameToId",value:function(e){return this.samHeader.nameToId?this.samHeader.nameToId[e]:this.seqIdToRefName?this.seqIdToRefName.indexOf(e):void 0}},{key:"refIdToName",value:function(e){return this.samHeader.idToName?this.samHeader.idToName[e]:this.seqIdToRefName?this.seqIdToRefName[e]:void 0}},{key:"refIdToOriginalName",value:function(e){return this.seqIdToOriginalRefName[e]}},{key:"getFeatures",value:function(e,t){var r=this,n=t||{},a=n.signal,o=n.statusCallback,i=void 0===o?function(){}:o,l=e.refName,s=e.start,c=e.end,u=e.originalRefName;return j.ObservableCreate(function(){var e=Q(Ce.mark((function e(n){var o,p;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.setup(t);case 2:if(!r.sequenceAdapter||r.seqIdToRefName){e.next=6;break}return e.next=5,r.sequenceAdapter.getRefNames(t);case 5:r.seqIdToRefName=e.sent;case 6:if(void 0===(o=r.refNameToId(l))){e.next=15;break}return u&&(r.seqIdToOriginalRefName[o]=u),i("Downloading alignments"),e.next=12,r.cram.getRecordsForRange(o,s,c,t);case 12:p=e.sent,m.checkAbortSignal(a),p.forEach((function(e){n.next(r.cramRecordToFeature(e))}));case 15:i(""),n.complete();case 17:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),a)}},{key:"freeResources",value:function(){}},{key:"cramRecordToFeature",value:function(e){return new Nt(e,this)}}]),s}()},At={__proto__:null,default:function(e){re(a,Mt);var t,r=oe(a);function a(){return Z(this,a),r.apply(this,arguments)}return $(a,[{key:"configure",value:(t=Q(Ce.mark((function e(){var t,r,a,o;return Ce.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.configured||(t=n.readConfObject(this.config,"htsgetBase"),r=n.readConfObject(this.config,"htsgetTrackId"),a=new V.HtsgetFile({baseUrl:t,trackId:r}),(o=n.readConfObject(this.config,"sequenceAdapter"))&&this.getSubAdapter&&(this.configured=this.getSubAdapter(o).then((function(e){return{bam:a,sequenceAdapter:e.dataAdapter}}))),this.configured=Promise.resolve({bam:a})),e.abrupt("return",this.configured);case 2:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),a}()},Dt=W.makeStyles((function(e){return{root:{width:300},closeButton:{position:"absolute",right:e.spacing(1),top:e.spacing(1),color:e.palette.grey[500]}}}));function It(e){var n=Dt(),a=e.model,o=e.handleClose,i=le(t.useState(""),2),l=i[0],s=i[1],c=l.match(/^[A-Za-z][A-Za-z0-9]$/);return r.createElement(W.Dialog,{open:!0,onClose:o},r.createElement(W.DialogTitle,null,"Color by tag",r.createElement(W.IconButton,{"aria-label":"close",className:n.closeButton,onClick:o},r.createElement(U,null))),r.createElement(W.DialogContent,{style:{overflowX:"hidden"}},r.createElement("div",{className:n.root},r.createElement(W.Typography,null,"Enter tag to color by: "),r.createElement(W.Typography,{color:"textSecondary"},"Examples: XS or TS for RNA-seq inferred read strand, ts (lower-case) for minimap2 read strand, HP for haplotype, RG for read group, etc."),r.createElement(W.TextField,{value:l,onChange:function(e){s(e.target.value)},placeholder:"Enter tag name",inputProps:{maxLength:2,"data-testid":"color-tag-name-input"},error:2===l.length&&!c,helperText:2!==l.length||c?"":"Not a valid tag",autoComplete:"off","data-testid":"color-tag-name"}),r.createElement(W.Button,{variant:"contained",color:"primary",style:{marginLeft:20},onClick:function(){a.setColorScheme({type:"tag",tag:l}),o()},disabled:!c},"Submit"))))}var Lt={__proto__:null,default:y.observer(It)},qt=W.makeStyles((function(e){return{root:{width:500},paper:{padding:e.spacing(2),margin:e.spacing(2)},closeButton:{position:"absolute",right:e.spacing(1),top:e.spacing(1),color:e.palette.grey[500]},field:{margin:e.spacing(2)}}})),Ft=["read paired","read mapped in proper pair","read unmapped","mate unmapped","read reverse strand","mate reverse strand","first in pair","second in pair","not primary alignment","read fails platform/vendor quality checks","read is PCR or optical duplicate","supplementary alignment"];function Ot(e){var t=e.flag,n=void 0===t?0:t,a=e.setFlag;return r.createElement(r.Fragment,null,r.createElement(W.TextField,{type:"number",value:n,onChange:function(e){return a(+e.target.value)}}),Ft.map((function(e,t){var o=n&1<<t,i="".concat(e,"_").concat(o);return r.createElement("div",{key:i},r.createElement("input",{type:"checkbox",checked:Boolean(o),onChange:function(e){a(e.target.checked?n|1<<t:n&~(1<<t))}}),r.createElement("label",{htmlFor:i},e))})))}function jt(e){var n,a,o=e.model,i=e.handleClose,l=qt(),s=o.filterBy,c=le(t.useState(null==s?void 0:s.flagInclude),2),u=c[0],p=c[1],f=le(t.useState(null==s?void 0:s.flagExclude),2),d=f[0],g=f[1],h=le(t.useState((null==s||null===(n=s.tagFilter)||void 0===n?void 0:n.tag)||""),2),m=h[0],y=h[1],v=le(t.useState((null==s||null===(a=s.tagFilter)||void 0===a?void 0:a.value)||""),2),b=v[0],C=v[1],w=le(t.useState((null==s?void 0:s.readName)||""),2),S=w[0],k=w[1],x=m.match(/^[A-Za-z][A-Za-z0-9]$/),_="https://broadinstitute.github.io/picard/explain-flags.html";return r.createElement(W.Dialog,{open:!0,onClose:i},r.createElement(W.DialogTitle,null,"Filter options",r.createElement(W.IconButton,{"aria-label":"close",className:l.closeButton,onClick:i},r.createElement(U,null))),r.createElement(W.DialogContent,null,r.createElement(W.Typography,null,"Set filter bitmask options. Refer to ",r.createElement(W.Link,{href:_},_)," ","for details"),r.createElement("div",{className:l.root},r.createElement(W.Paper,{className:l.paper,variant:"outlined"},r.createElement("div",{style:{display:"flex"}},r.createElement("div",null,r.createElement(W.Typography,null,"Read must have ALL these flags"),r.createElement(Ot,{flag:u,setFlag:p})),r.createElement("div",null,r.createElement(W.Typography,null,"Read must have NONE of these flags"),r.createElement(Ot,{flag:d,setFlag:g})))),r.createElement(W.Paper,{className:l.paper,variant:"outlined"},r.createElement(W.Typography,null,"Filter by tag name and value. Use * in the value field to get all reads containing any value for that tag. Example: filter tag name SA with value * to get all split/supplementary reads. Other examples include HP for haplotype, or RG for read group"),r.createElement(W.TextField,{className:l.field,value:m,onChange:function(e){y(e.target.value)},placeholder:"Enter tag name",inputProps:{maxLength:2,"data-testid":"color-tag-name-input"},error:2===m.length&&!x,helperText:2!==m.length||x?"":"Not a valid tag","data-testid":"color-tag-name"}),r.createElement(W.TextField,{className:l.field,value:b,onChange:function(e){C(e.target.value)},placeholder:"Enter tag value",inputProps:{"data-testid":"color-tag-name-input"},"data-testid":"color-tag-value"})),r.createElement(W.Paper,{className:l.paper,variant:"outlined"},r.createElement(W.Typography,null,"Filter by read name"),r.createElement(W.TextField,{className:l.field,value:S,onChange:function(e){k(e.target.value)},placeholder:"Enter read name",inputProps:{"data-testid":"color-tag-readname-input"},"data-testid":"color-tag-readname"})),r.createElement(W.Button,{variant:"contained",color:"primary",onClick:function(){o.setFilterBy({flagInclude:u,flagExclude:d,readName:S,tagFilter:""!==m?{tag:m,value:b}:void 0}),i()}},"Submit"))))}var Ht={__proto__:null,default:y.observer(jt)},Vt=W.makeStyles((function(e){return{root:{margin:0,padding:e.spacing(2)},closeButton:{position:"absolute",right:e.spacing(1),top:e.spacing(1),color:e.palette.grey[500]}}}));function zt(e){var n=Vt(),a=e.model,o=e.handleClose,i=le(t.useState(""),2),l=i[0],s=i[1],c=l.match(/^[A-Za-z][A-Za-z0-9]$/);return r.createElement(W.Dialog,{open:!0,onClose:o},r.createElement(W.DialogTitle,null,"Sort by tag",r.createElement(W.IconButton,{"aria-label":"close",className:n.closeButton,onClick:o},r.createElement(U,null))),r.createElement(W.DialogContent,null,r.createElement("div",null,r.createElement(W.Typography,null,"Set the tag to sort by"),r.createElement(W.Typography,{color:"textSecondary"},"Examples: HP for haplotype, RG for read group, etc."),r.createElement(W.TextField,{value:l,onChange:function(e){s(e.target.value)},placeholder:"Enter tag name",inputProps:{maxLength:2,"data-testid":"sort-tag-name-input"},error:2===l.length&&!c,helperText:2!==l.length||c?"":"Not a valid tag",autoComplete:"off","data-testid":"sort-tag-name"}),r.createElement(W.Button,{variant:"contained",color:"primary",onClick:function(){a.setSortedBy("tag",l),o()}},"Submit"))))}var Gt={__proto__:null,default:y.observer(zt)},Wt=W.makeStyles((function(e){return{root:{margin:e.spacing(4)},closeButton:{position:"absolute",right:e.spacing(1),top:e.spacing(1),color:e.palette.grey[500]}}}));function Ut(e){var n=Wt(),a=e.model,o=e.handleClose,i=a.noSpacing,l=le(t.useState("".concat(a.featureHeightSetting)),2),s=l[0],c=l[1],u=le(t.useState(i),2),p=u[0],f=u[1],d=""!==s&&!Number.isNaN(+s);return r.createElement(W.Dialog,{open:!0,onClose:o},r.createElement(W.DialogTitle,null,"Set feature height",r.createElement(W.IconButton,{className:n.closeButton,onClick:o},r.createElement(U,null))),r.createElement(W.DialogContent,null,r.createElement(W.Typography,null,"Adjust the feature height and whether there is any spacing between features. Setting feature height to 1 and removing spacing makes the display very compact"),r.createElement("div",{className:n.root},r.createElement(W.Typography,null,"Enter feature height: "),r.createElement(W.TextField,{value:s,onChange:function(e){c(e.target.value)}}),r.createElement(W.FormControlLabel,{control:r.createElement(W.Checkbox,{checked:!!p,onChange:function(){return f((function(e){return!e}))}}),label:"Remove spacing between features in y-direction?"}),r.createElement(W.Button,{variant:"contained",color:"primary",type:"submit",style:{marginLeft:20},disabled:!d,onClick:function(){a.setFeatureHeight(""===s||Number.isNaN(+s)?void 0:+s),a.setNoSpacing(p),o()}},"Submit"))))}var Jt={__proto__:null,default:y.observer(Ut)},Xt=W.makeStyles((function(e){return{root:{width:500},closeButton:{position:"absolute",right:e.spacing(1),top:e.spacing(1),color:e.palette.grey[500]},field:{margin:e.spacing(2)}}}));function Qt(e){var n=e.model,a=e.handleClose,o=Xt(),i=n.maxHeight,l=le(t.useState("".concat(void 0===i?"":i)),2),s=l[0],c=l[1];return r.createElement(W.Dialog,{open:!0,onClose:a},r.createElement(W.DialogTitle,{id:"alert-dialog-title"},"Filter options",r.createElement(W.IconButton,{"aria-label":"close",className:o.closeButton,onClick:a},r.createElement(U,null))),r.createElement(W.DialogContent,null,r.createElement("div",{className:o.root},r.createElement(W.Typography,null,"Set max height for the track"),r.createElement(W.TextField,{value:s,onChange:function(e){c(e.target.value)},placeholder:"Enter max height for layout"}),r.createElement(W.Button,{variant:"contained",color:"primary",type:"submit",style:{marginLeft:20},onClick:function(){n.setMaxHeight(""===s||Number.isNaN(+s)?void 0:+s),a()}},"Submit"))))}var Zt={__proto__:null,default:y.observer(Qt)},Yt=W.makeStyles((function(e){return{root:{},closeButton:{position:"absolute",right:e.spacing(1),top:e.spacing(1),color:e.palette.grey[500]},table:{border:"1px solid #888",margin:e.spacing(4),"& td":{padding:e.spacing(1)}}}}));function $t(e){var t=e.modifications,n=Yt();return r.createElement("table",{className:n.table},r.createElement("tbody",null,t.map((function(e){var t=le(e,2),n=t[0],a=t[1];return r.createElement("tr",{key:n},r.createElement("td",null,n),r.createElement("td",null,a),r.createElement("td",{style:{width:"1em",background:a}}))}))))}function Kt(e){var t=Yt(),n=e.model,a=e.handleClose,o=n.colorBy,i=n.modificationTagMap,l=se(i.entries());return r.createElement(W.Dialog,{open:!0,onClose:a},r.createElement(W.DialogTitle,null,"Color by modifications",r.createElement(W.IconButton,{"aria-label":"close",className:t.closeButton,onClick:a},r.createElement(U,null))),r.createElement(W.DialogContent,null,r.createElement("div",{className:t.root},r.createElement(W.Typography,null,"You can choose to color the modifications in the BAM/CRAM MM/ML specification using this dialog. Choosing modifications colors the modified positions and can color multiple modification types. Choosing the methylation setting colors methylated and unmethylated CpG."),r.createElement(W.Typography,null,"Note: you can revisit this dialog to see the current mapping of colors to modification type for the modification coloring mode"),r.createElement("div",{style:{margin:20}},"modifications"===(null==o?void 0:o.type)?r.createElement("div",null,l.length?r.createElement(r.Fragment,null,"Current modification-type-to-color mapping",r.createElement($t,{modifications:se(i.entries())})):r.createElement("div",null,r.createElement(W.Typography,null,"Note: color by modifications is already enabled. Loading current modifications..."),r.createElement(W.CircularProgress,{size:15}))):null,"methylation"===(null==o?void 0:o.type)?r.createElement($t,{modifications:[["methylated","red"],["unmethylated","blue"]]}):null),r.createElement("div",{style:{display:"flex"}},r.createElement(W.Button,{variant:"contained",color:"primary",style:{margin:5},onClick:function(){n.setColorScheme({type:"modifications"}),a()}},"Modifications"),r.createElement(W.Button,{variant:"contained",color:"primary",style:{margin:5},onClick:function(){n.setColorScheme({type:"methylation"}),a()}},"Methylation"),r.createElement(W.Button,{variant:"contained",color:"secondary",style:{margin:5},onClick:function(){return a()}},"Cancel")))))}var er={__proto__:null,default:y.observer(Kt)},tr=W.makeStyles((function(){return{compact:{paddingRight:0,paddingTop:0,paddingBottom:0}}})),rr=["clipPos","flags"];function nr(e){var t=tr(),n=e.feature.flags;return r.createElement(J.BaseCard,Object.assign({},e,{title:"Flags"}),r.createElement(J.SimpleValue,{name:"Flag",value:n}),r.createElement(W.FormGroup,null,["read paired","read mapped in proper pair","read unmapped","mate unmapped","read reverse strand","mate reverse strand","first in pair","second in pair","not primary alignment","read fails platform/vendor quality checks","read is PCR or optical duplicate","supplementary alignment"].map((function(e,a){var o=n&1<<a,i="".concat(e,"_").concat(o);return r.createElement(W.FormControlLabel,{key:i,control:r.createElement(W.Checkbox,{className:t.compact,checked:Boolean(o),name:e,readOnly:!0}),label:e})}))))}function ar(e){var n=e.value,a=le(t.useState(!1),2),o=a[0],i=a[1],l=String(n);return l.length>100?r.createElement(r.Fragment,null,r.createElement("button",{type:"button",onClick:function(){return S(l)}},"Copy"),r.createElement("button",{type:"button",onClick:function(){return i((function(e){return!e}))}},o?"Show less":"Show more"),r.createElement("div",null,o?l:"".concat(l.slice(0,100),"..."))):r.createElement("div",null,l)}function or(e){var t=e.tag,n=e.model,a=m.getSession(n);return r.createElement(J.BaseCard,Object.assign({},e,{title:"Supplementary alignments"}),r.createElement(W.Typography,null,"List of supplementary alignment locations"),r.createElement("ul",null,t.split(";").filter((function(e){return!!e})).map((function(e,t){var o=le(e.split(","),4),i=o[0],l=o[1],s=o[2],c=function(e){for(var t=Se(e),r=0,n=0;n<t.length;n+=2){var a=t[n+1];"H"!==a&&"S"!==a&&"I"!==a&&(r+=+t[n])}return r}(o[3]),u=Math.floor(c/5),p=+l,f=+l+c,d="".concat(i,":").concat(Math.max(1,p-u),"-").concat(f+u),g="".concat(i,":").concat(p,"-").concat(f," (").concat(s,")");return r.createElement("li",{key:"".concat(d,"-").concat(t)},r.createElement(W.Link,{onClick:function(){var e=n.view;e?e.navToLocString(d):a.notify("No view associated with this feature detail panel anymore","warning")},href:"#"},g))}))))}function ir(e){var t=e.locString,n=e.model,a=m.getSession(n);return r.createElement(W.Link,{onClick:function(){var e=n.view;e?e.navToLocString(t):a.notify("No view associated with this feature detail panel anymore","warning")},href:"#"},t)}function lr(e){var t=e.model,n=JSON.parse(JSON.stringify(t.featureData)),a=n.tags&&n.tags.SA||n.SA;return r.createElement(W.Paper,{"data-testid":"alignment-side-drawer"},r.createElement(J.FeatureDetails,Object.assign({},e,{omit:rr,feature:n,formatter:function(e,n){return"next_segment_position"===n?r.createElement(ir,{model:t,locString:e}):r.createElement(ar,{value:e})}})),a?r.createElement(or,{model:t,tag:a}):null,r.createElement(nr,Object.assign({feature:n},e)))}var sr={__proto__:null,default:y.observer(lr)};exports.MismatchParser=Me,exports.default=Pt;
//# sourceMappingURL=plugin-alignments.cjs.production.min.js.map
