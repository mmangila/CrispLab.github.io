"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=require("react"),r=e(t),n=require("@jbrowse/core/configuration"),i=e(require("@jbrowse/core/pluggableElementTypes/AdapterType")),a=e(require("@jbrowse/core/pluggableElementTypes/DisplayType")),o=require("@jbrowse/core/pluggableElementTypes/models"),c=e(require("@jbrowse/core/pluggableElementTypes/TrackType")),u=e(require("@jbrowse/core/pluggableElementTypes/WidgetType")),s=e(require("@jbrowse/core/Plugin")),l=require("@jbrowse/plugin-linear-genome-view"),f=require("@jbrowse/plugin-circular-view"),p=require("@jbrowse/core/util/tracks"),d=require("@jbrowse/core/util"),h=require("mobx-state-tree"),y=require("@jbrowse/core/util/types/mst"),g=require("@jbrowse/core/data_adapters/BaseAdapter"),v=require("@jbrowse/core/util/io"),m=require("@jbrowse/core/util/rxjs"),b=require("@gmod/tabix"),w=e(require("@gmod/vcf")),k=require("@gmod/bgzf-filehandle"),S=require("@material-ui/core"),x=e(require("@jbrowse/core/util/simpleFeature")),C=require("@material-ui/data-grid"),O=require("mobx-react"),E=require("@jbrowse/core/BaseFeatureWidget/BaseFeatureDetail"),j=require("@material-ui/core/styles"),T=e(require("@material-ui/icons/Close"));function D(e){return(D="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function F(e,t,r,n,i,a,o){try{var c=e[a](o),u=c.value}catch(e){return void r(e)}c.done?t(u):Promise.resolve(u).then(n,i)}function L(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var a=e.apply(t,r);function o(e){F(a,n,i,o,c,"next",e)}function c(e){F(a,n,i,o,c,"throw",e)}o(void 0)}))}}function R(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function P(e,t,r){return t&&_(e.prototype,t),r&&_(e,r),e}function N(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function V(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function A(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?V(Object(r),!0).forEach((function(t){N(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):V(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function M(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function q(e){return(q=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function I(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function B(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=q(e);if(t){var i=q(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return I(this,r)}}function z(e,t,r){return(z="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=q(e)););return e}(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(r):i.value}})(e,t,r||e)}function G(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=e&&("undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"]);if(null!=r){var n,i,a=[],o=!0,c=!1;try{for(r=r.call(e);!(o=(n=r.next()).done)&&(a.push(n.value),!t||a.length!==t);o=!0);}catch(e){c=!0,i=e}finally{try{o||null==r.return||r.return()}finally{if(c)throw i}}return a}}(e,t)||H(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function W(e){return function(e){if(Array.isArray(e))return J(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||H(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function H(e,t){if(e){if("string"==typeof e)return J(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?J(e,t):void 0}}function J(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var U=function(e){var t=e.jbrequire,r=t("mobx-state-tree").types,n=t("@jbrowse/core/configuration"),i=n.ConfigurationSchema,a=n.ConfigurationReference,o=t("@jbrowse/core/util").getContainingView,c=t("@jbrowse/core/util/tracks").getParentRenderProps,u=i("ChordVariantDisplay",{renderer:r.optional(e.pluggableConfigSchemaType("renderer"),{type:"StructuralVariantChordRenderer"})},{baseConfiguration:f.baseChordDisplayConfig,explicitlyTyped:!0});return{stateModel:r.compose("ChordVariantDisplay",f.BaseChordDisplayModel,r.model({type:r.literal("ChordVariantDisplay"),configuration:a(u)})).views((function(e){return{get rendererTypeName(){return e.configuration.renderer.type},get renderProps(){var t=o(e);return A(A({},c(e)),{},{rpcDriverName:e.rpcDriverName,displayModel:e,bezierRadius:t.radiusPx*e.bezierRadiusRatio,radius:t.radiusPx,blockDefinitions:this.blockDefinitions,config:e.configuration.renderer,onChordClick:e.onChordClick})}}})),configSchema:u}},Y=function(e){var t=e.lib["@jbrowse/core/pluggableElementTypes/DisplayType"],r=(0,e.load)(U);return new t({name:"ChordVariantDisplay",configSchema:r.configSchema,stateModel:r.stateModel,trackType:"VariantTrack",viewType:"CircularView",ReactComponent:f.BaseChordDisplayComponentFactory(e)})};function Q(e,t){return e(t={exports:{}},t.exports),t.exports}var K=Q((function(e){var t=function(e){var t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",a=n.asyncIterator||"@@asyncIterator",o=n.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var i=Object.create((t&&t.prototype instanceof f?t:f).prototype),a=new x(n||[]);return i._invoke=function(e,t,r){var n="suspendedStart";return function(i,a){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw a;return{value:void 0,done:!0}}for(r.method=i,r.arg=a;;){var o=r.delegate;if(o){var c=w(o,r);if(c){if(c===l)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var u=s(e,t,r);if("normal"===u.type){if(n=r.done?"completed":"suspendedYield",u.arg===l)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n="completed",r.method="throw",r.arg=u.arg)}}}(e,r,a),i}function s(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var l={};function f(){}function p(){}function d(){}var h={};h[i]=function(){return this};var y=Object.getPrototypeOf,g=y&&y(y(C([])));g&&g!==t&&r.call(g,i)&&(h=g);var v=d.prototype=f.prototype=Object.create(h);function m(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){var n;this._invoke=function(i,a){function o(){return new t((function(n,o){!function n(i,a,o,c){var u=s(e[i],e,a);if("throw"!==u.type){var l=u.arg,f=l.value;return f&&"object"==typeof f&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,o,c)}),(function(e){n("throw",e,o,c)})):t.resolve(f).then((function(e){l.value=e,o(l)}),(function(e){return n("throw",e,o,c)}))}c(u.arg)}(i,a,n,o)}))}return n=n?n.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=s(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var i=n.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function S(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function x(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function C(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:O}}function O(){return{value:void 0,done:!0}}return p.prototype=v.constructor=d,d.constructor=p,p.displayName=c(d,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,c(e,o,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},m(b.prototype),b.prototype[a]=function(){return this},e.AsyncIterator=b,e.async=function(t,r,n,i,a){void 0===a&&(a=Promise);var o=new b(u(t,r,n,i),a);return e.isGeneratorFunction(r)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},m(v),c(v,o,"Generator"),v[i]=function(){return this},v.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=C,x.prototype={constructor:x,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(S),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return o.type="throw",o.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],o=a.completion;if("root"===a.tryLoc)return n("end");if(a.tryLoc<=this.prev){var c=r.call(a,"catchLoc"),u=r.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return n(a.catchLoc,!0);if(this.prev<a.finallyLoc)return n(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return n(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return n(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var a=i;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=e,o.arg=t,a?(this.method="next",this.next=a.finallyLoc,l):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),S(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;S(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:C(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}}));function $(e){return h.types.compose("LinearVariantDisplay",l.linearBasicDisplayModelFactory(e),h.types.model({type:h.types.literal("LinearVariantDisplay"),configuration:n.ConfigurationReference(e)})).actions((function(e){return{selectFeature:function(t){return L(K.mark((function r(){var i,a,o,c,u,s,l;return K.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(i=d.getSession(e),!d.isSessionModelWithWidgets(i)){r.next=11;break}return a=i.rpcManager,o=p.getRpcSessionId(e),c=d.getContainingTrack(e),u=n.getConf(c,"adapter"),r.next=8,a.call(o,"CoreGetMetadata",{adapterConfig:u});case 8:s=r.sent,l=i.addWidget("VariantFeatureWidget","variantFeature",{featureData:t.toJSON(),view:d.getContainingView(e),descriptions:s}),i.showWidget(l);case 11:i.setSelection(t);case 12:case"end":return r.stop()}}),r)})))()}}}))}var X=function(e){var t=e.jbrequire,r=t("react"),n=t("react").useMemo,i=t("mobx-react"),a=i.observer,o=i.PropTypes,c=t("@jbrowse/core/util").polarToCartesian,u=t("@jbrowse/core/configuration").readConfObject,s=t("@jbrowse/core/util/types/mst").PropTypes,l=t("prop-types");function f(e,t){return(e.flipped?(e.region.elided?0:e.region.end)-t:t-(e.region.elided?0:e.region.start))/e.bpPerRadian+e.startRadians}var p=a((function(e){var t,n,i,a=e.feature,o=e.blocksForRefs,s=e.radius,l=e.config,p=e.bezierRadius,d=e.selected,h=e.onClick,y=o[a.get("refName")];if(!y)return null;if(a.get("INFO")?t=G(a.get("INFO").SVTYPE||[],1)[0]:a.get("mate")&&(t="mate"),"BND"===t){var g=(a.get("ALT")||[])[0].MatePosition.split(":");n=parseInt(g[1],10),i=o[g[0]]}else if("TRA"===t){var v=((a.get("INFO")||{}).CHR2||[])[0],m=((a.get("INFO")||{}).END||[])[0];n=parseInt(m,10),i=o[v]}else if("mate"===t){var b=a.get("mate");n=b.start,i=o[b.refName]}if(i){var w,k=a.get("start"),S=f(y,k),x=f(i,n),C=c(s,S),O=c(s,x),E=c(p,(x+S)/2);w=u(l,d?"strokeColorSelected":"strokeColor",{feature:a});var j=u(l,"strokeColorHover",{feature:a});return r.createElement("path",{"data-testid":"chord-".concat(a.id()),d:["M"].concat(W(C),["Q"],W(E),W(O)).join(" "),style:{stroke:w},onClick:function(e){return h(a,y.region,i.region,e)},onMouseOver:function(e){d||(e.target.style.stroke=j)},onMouseOut:function(e){d||(e.target.style.stroke=w)}})}return null}));function d(e){var t,i=e.features,a=e.config,o=e.displayModel,c=e.blockDefinitions,u=e.radius,s=e.bezierRadius,l=e.displayModel.selectedFeatureId,f=e.onChordClick,d=n((function(){var e={};return c.forEach((function(t){(t.region.elided?t.region.regions:[t.region]).forEach((function(r){e[r.refName]=t}))})),e}),[c]),h=[],y=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=H(e))){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return o=e.done,e},e:function(e){c=!0,a=e},f:function(){try{o||null==r.return||r.return()}finally{if(c)throw a}}}}(i);try{for(y.s();!(t=y.n()).done;){var g=G(t.value,2),v=g[0],m=g[1],b=String(l)===String(m.id());h.push(r.createElement(p,{key:v,feature:m,config:a,displayModel:o,radius:u,bezierRadius:s,blocksForRefs:d,selected:b,onClick:f}))}}catch(e){y.e(e)}finally{y.f()}var w="chords-".concat(o.id);return r.createElement("g",{id:w,"data-testid":"structuralVariantChordRenderer"},r.createElement("style",{dangerouslySetInnerHTML:{__html:"\n          #".concat(w," > path {\n            cursor: crosshair;\n            fill: none;\n          }\n")}}),h)}return d.propTypes={features:l.instanceOf(Map).isRequired,config:s.ConfigSchema.isRequired,displayModel:o.objectOrObservableObject,blockDefinitions:l.arrayOf(o.objectOrObservableObject).isRequired,radius:l.number.isRequired,bezierRadius:l.number.isRequired,selectedFeatureId:l.string,onChordClick:l.oneOfType([l.func,l.string])},d.defaultProps={displayModel:void 0,selectedFeatureId:"",onChordClick:void 0},a(d)},Z=function(e){var t=e.jbrequire,r=t("@jbrowse/core/pluggableElementTypes/renderers/CircularChordRendererType"),n=t("@jbrowse/core/configuration").ConfigurationSchema;return new r({name:"StructuralVariantChordRenderer",ReactComponent:t(X),configSchema:n("StructuralVariantChordRenderer",{strokeColor:{type:"color",description:"the line color of each arc",defaultValue:"rgba(255,133,0,0.32)",contextVariable:["feature"]},strokeColorSelected:{type:"color",description:"the line color of an arc that has been selected",defaultValue:"black",contextVariable:["feature"]},strokeColorHover:{type:"color",description:"the line color of an arc that is being hovered over with the mouse",defaultValue:"#555",contextVariable:["feature"]}},{explicitlyTyped:!0}),pluginManager:e})},ee=n.ConfigurationSchema("VariantFeatureWidget",{});function te(e){return h.types.model("VariantFeatureWidget",{id:y.ElementId,type:h.types.literal("VariantFeatureWidget"),view:h.types.safeReference(e.pluggableMstType("view","stateModel")),featureData:h.types.frozen(),descriptions:h.types.frozen()}).actions((function(e){return{setFeatureData:function(t){e.featureData=t},clearFeatureData:function(){e.featureData=void 0}}}))}var re=n.ConfigurationSchema("VcfTabixAdapter",{vcfGzLocation:{type:"fileLocation",defaultValue:{uri:"/path/to/my.vcf.gz"}},index:n.ConfigurationSchema("VcfIndex",{indexType:{model:h.types.enumeration("IndexType",["TBI","CSI"]),type:"stringEnum",defaultValue:"TBI"},location:{type:"fileLocation",defaultValue:{uri:"/path/to/my.vcf.gz.tbi"}}})},{explicitlyTyped:!0}),ne=n.ConfigurationSchema("VcfAdapter",{vcfLocation:{type:"fileLocation",defaultValue:{uri:"/path/to/my.vcf"}}},{explicitlyTyped:!0}),ie=function(){function e(t){R(this,e),this.variant=t.variant,this.parser=t.parser,this.data=this.dataFromVariant(this.variant),this._id=t.id}return P(e,[{key:"get",value:function(e){return"samples"===e?this.variant.SAMPLES:this.data[e]||this.variant[e]}},{key:"set",value:function(){}},{key:"parent",value:function(){}},{key:"children",value:function(){}},{key:"tags",value:function(){return[].concat(W(Object.keys(this.data)),W(Object.keys(this.variant)),["samples"])}},{key:"id",value:function(){return this._id}},{key:"dataFromVariant",value:function(e){var t=e.REF,r=e.ALT,n=e.CHROM,i=e.INFO,a=e.ID,o=e.POS-1,c=G(this._getSOTermAndDescription(t,r),2),u=c[0],s=c[1],l=null==r?void 0:r.some((function(e){return"<TRA>"===e}));return{refName:n,start:o,end:(null==r?void 0:r.some((function(e){return"string"==typeof e&&-1!==e.indexOf("<")})))&&i.END&&!l?+i.END[0]:o+t.length,description:s,type:u,name:a?a[0]:void 0,aliases:a&&a.length>1?e.ID.slice(1):void 0}}},{key:"_getSOTermAndDescription",value:function(e,t){var r=this;if(!t||t===[])return["remark","no alternative alleles"];var n=new Set,i=new Set;if(t.forEach((function(t){var a=G(r._getSOAndDescFromAltDefs(e,t),2),o=a[0],c=a[1];if(!o){var u=G(r._getSOAndDescByExamination(e,t),2);o=u[0],c=u[1]}o&&c&&(n.add(o),i.add(c))})),i.size>1){var a=new Set(W(i).map((function(e){var t=e.split("->");return t[1]?t[0]:e}))),o=W(a).map((function(e){var t=W(i).map((function(t){var r=t.split("-> ");return r[1]&&r[0]===e?r[1]:""})).filter((function(e){return!!e}));return t.length?e+"-> "+t.join(","):W(i).join(",")}));i=new Set(o)}return n.size?[W(n).join(","),W(i).join(",")]:[void 0,void 0]}},{key:"_getSOAndDescFromAltDefs",value:function(t,r){if("object"===D(r))return["breakend",r.toString()];if("string"==typeof r&&!r.startsWith("<"))return[void 0,void 0];var n=e._altTypeToSO[r];if(!n&&this.parser.getMetadata("ALT",r)&&(n="sequence_variant"),n)return[n,r];var i=r.split(":");return i.length>1?this._getSOAndDescFromAltDefs(t,"<".concat(i.slice(0,i.length-1).join(":"),">")):[void 0,void 0]}},{key:"_getSOAndDescByExamination",value:function(e,t){return"object"===D(t)?["breakend",this._makeDescriptionString("breakend",e,t)]:1===e.length&&1===t.length?["SNV",this._makeDescriptionString("SNV",e,t)]:t.includes("<")?["sv",t]:e.length===t.length?e.split("").reverse().join("")===t?["inversion",this._makeDescriptionString("inversion",e,t)]:["substitution",this._makeDescriptionString("substitution",e,t)]:e.length<=t.length?["insertion",this._makeDescriptionString("insertion",e,t)]:e.length>t.length?["deletion",this._makeDescriptionString("deletion",e,t)]:["indel",this._makeDescriptionString("indel",e,t)]}},{key:"_makeDescriptionString",value:function(e,t,r){return"".concat(e," ").concat(t," -> ").concat(r)}},{key:"toJSON",value:function(){return A(A(A({uniqueId:this._id},this.variant),this.data),{},{samples:this.variant.SAMPLES})}}]),e}();ie._altTypeToSO={DEL:"deletion",INS:"insertion",DUP:"duplication",INV:"inversion",INVDUP:"inverted duplication",CNV:"copy_number_variation",TRA:"translocation","DUP:TANDEM":"tandem_duplication",NON_REF:"sequence_variant","*":"sequence_variant"};var ae=function(e){M(f,s);var r=B(f);function f(){var e;return R(this,f),(e=r.apply(this,arguments)).name="VariantsPlugin",e}return P(f,[{key:"install",value:function(e){e.addAdapterType((function(){return new i({name:"VcfTabixAdapter",configSchema:re,getAdapterClass:function(){return Promise.resolve().then((function(){return oe})).then((function(e){return e.default}))}})})),e.addAdapterType((function(){return new i({name:"VcfAdapter",configSchema:ne,getAdapterClass:function(){return Promise.resolve().then((function(){return se})).then((function(e){return e.default}))}})})),e.addRendererType((function(){return e.jbrequire(Z)})),e.addTrackType((function(){var t=n.ConfigurationSchema("VariantTrack",{},{baseConfiguration:o.createBaseTrackConfig(e)});return new c({name:"VariantTrack",configSchema:t,stateModel:o.createBaseTrackModel(e,"VariantTrack",t)})})),e.addDisplayType((function(){return e.jbrequire(Y)})),e.addDisplayType((function(){var t=function(e){var t=l.linearBasicDisplayConfigSchemaFactory(e);return n.ConfigurationSchema("LinearVariantDisplay",{},{baseConfiguration:t,explicitlyTyped:!0})}(e);return new a({name:"LinearVariantDisplay",configSchema:t,stateModel:$(t),trackType:"VariantTrack",viewType:"LinearGenomeView",ReactComponent:l.BaseLinearDisplayComponent})})),e.addWidgetType((function(){return new u({name:"VariantFeatureWidget",heading:"Feature details",configSchema:ee,stateModel:te(e),ReactComponent:t.lazy((function(){return Promise.resolve().then((function(){return ge}))}))})}))}}]),f}(),oe={__proto__:null,default:function(e){M(u,g.BaseFeatureDataAdapter);var t,r,i,a,o,c=B(u);function u(){return R(this,u),c.apply(this,arguments)}return P(u,[{key:"configure",value:(o=L(K.mark((function e(){var t,r,i,a,o,c,u=this;return K.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.configured||(t=n.readConfObject(this.config,"vcfGzLocation"),r=n.readConfObject(this.config,["index","location"]),i=n.readConfObject(this.config,["index","indexType"]),a=v.openLocation(t),c=new b.TabixIndexedFile({filehandle:a,csiFilehandle:(o="CSI"===i)?v.openLocation(r):void 0,tbiFilehandle:o?void 0:v.openLocation(r),chunkCacheSize:50*Math.pow(2,20),chunkSizeLimit:1e9}),this.configured=c.getHeader().then((function(e){return{filehandle:a,vcf:c,parser:new w({header:e})}})).catch((function(e){throw u.configured=void 0,e}))),e.abrupt("return",this.configured);case 2:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"getRefNames",value:(a=L(K.mark((function e(){var t,r=arguments;return K.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:{},e.next=3,this.configure();case 3:return e.abrupt("return",e.sent.vcf.getReferenceSequenceNames(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"getHeader",value:(i=L(K.mark((function e(){return K.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.configure();case 2:return e.abrupt("return",e.sent.vcf.getHeader());case 5:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"getMetadata",value:(r=L(K.mark((function e(){return K.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.configure();case 2:return e.abrupt("return",e.sent.parser.getMetadata());case 5:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"getFeatures",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return m.ObservableCreate(function(){var n=L(K.mark((function n(i){var a,o,c,u,s,l;return K.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return a=e.refName,o=e.start,c=e.end,n.next=3,t.configure();case 3:return s=(u=n.sent).vcf,l=u.parser,n.next=8,s.getLines(a,o,c,A({lineCallback:function(e,r){i.next(new ie({variant:l.parseLine(e),parser:l,id:"".concat(t.id,"-vcf-").concat(r)}))}},r));case 8:i.complete();case 9:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),r.signal)}},{key:"getFeaturesInMultipleRegions",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=z(q(u.prototype),"getFeaturesInMultipleRegions",this);return m.ObservableCreate(function(){var i=L(K.mark((function i(a){var o,c,u;return K.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,t.bytesForRegions(e);case 2:return o=i.sent,i.next=5,t.configure();case 5:return c=i.sent.filehandle,i.next=9,c.stat();case 9:(u=Math.round(o/i.sent.size*100))>100&&(u=100),u>60&&console.warn("getFeaturesInMultipleRegions fetching ".concat(u,"% of VCF file, but whole-file streaming not yet implemented")),n.call(t,e,r).subscribe(a);case 14:case"end":return i.stop()}}),i)})));return function(e){return i.apply(this,arguments)}}())}},{key:"bytesForRegions",value:(t=L(K.mark((function e(t){var r,n;return K.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.configure();case 2:return r=e.sent.vcf,e.next=6,Promise.all(t.map((function(e){return r.index.blocksForRange(e.refName,e.start,e.end)})));case 6:return n=[],e.sent.forEach((function(e){e.forEach((function(e){var t=e.minv.blockPosition,r=e.maxv.blockPosition+64e3;n.find((function(e){return e.start<=r&&e.end>=t&&(e.start=Math.min(e.start,t),e.end=Math.max(e.end,r),!0)}))||n.push({start:t,end:r})}))})),e.abrupt("return",n.reduce((function(e,t){return e+t.end-t.start+1}),0));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"freeResources",value:function(){}}]),u}()},ce=function(e){var t=e.split("\n"),r=[],n=[],i=[];return t.forEach((function(e){e.startsWith("##contig")?n.push(e.split("##contig=<ID=")[1].split(",")[0]):e.startsWith("#")?r.push(e):e&&i.push(e)})),{header:r.join("\n"),lines:i,refNames:n}},ue=function(e){M(c,g.BaseFeatureDataAdapter);var t,r,i,a,o=B(c);function c(e){return R(this,c),o.call(this,e)}return P(c,[{key:"decodeFileContents",value:(a=L(K.mark((function e(){var t,r;return K.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.readConfObject(this.config,"vcfLocation"),e.next=3,v.openLocation(t).readFile();case 3:if("number"!=typeof(r=e.sent)[0]||31!==r[0]||"number"!=typeof r[1]||139!==r[1]||"number"!=typeof r[2]||8!==r[2]){e.next=12;break}return e.t0=new TextDecoder,e.next=8,k.unzip(r);case 8:e.t1=e.sent,r=e.t0.decode.call(e.t0,e.t1),e.next=13;break;case 12:r=r.toString();case 13:return e.abrupt("return",ce(r));case 14:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"getLines",value:(i=L(K.mark((function e(){var t,r,n,i=this;return K.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.decodeFileContents();case 2:return r=(t=e.sent).lines,n=new w({header:t.header}),e.abrupt("return",r.map((function(e,t){return new ie({variant:n.parseLine(e),parser:n,id:"".concat(i.id,"-vcf-").concat(t)})})));case 7:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"setup",value:(r=L(K.mark((function e(){return K.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setupP||(this.setupP=this.getLines()),e.abrupt("return",this.setupP);case 2:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"getRefNames",value:(t=L(K.mark((function e(){return K.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=3,this.decodeFileContents();case 3:return e.abrupt("return",e.sent.refNames);case 6:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"getFeatures",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return m.ObservableCreate(function(){var r=L(K.mark((function r(n){return K.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t.setup();case 2:r.sent.forEach((function(t){t.get("refName")===e.refName&&t.get("end")>e.start&&t.get("start")<e.end&&n.next(t)})),n.complete();case 5:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}(),r.signal)}},{key:"freeResources",value:function(){}}]),c}();ue.capabilities=["getFeatures","getRefNames"];var se={__proto__:null,default:ue},le=j.makeStyles((function(e){return{closeButton:{position:"absolute",right:e.spacing(1),top:e.spacing(1),color:e.palette.grey[500]},block:{display:"block"}}}));function fe(e){var n=e.model,i=e.handleClose,a=e.feature,o=e.viewType,c=le(),u=G(t.useState(!0),2),s=u[0],l=u[1],f=G(t.useState(!0),2),p=f[0],y=f[1];return r.createElement(S.Dialog,{open:!0,onClose:i},r.createElement(S.DialogTitle,null,"Breakpoint split view options",i?r.createElement(S.IconButton,{className:c.closeButton,onClick:function(){i()}},r.createElement(T,null)):null),r.createElement(S.Divider,null),r.createElement(S.DialogContent,null,r.createElement(S.FormControlLabel,{className:c.block,control:r.createElement(S.Checkbox,{checked:s,onChange:function(){return l((function(e){return!e}))}}),label:"Copy tracks into the new view"}),r.createElement(S.FormControlLabel,{className:c.block,control:r.createElement(S.Checkbox,{checked:p,onChange:function(){return y((function(e){return!e}))}}),label:"Mirror tracks vertically in vertically stacked view"})),r.createElement(S.DialogActions,null,r.createElement(S.Button,{onClick:function(){var e=n.view,t=d.getSession(n),r=o.snapshotFromBreakendFeature(a,e);r.views[0].offsetPx-=e.width/2+100,r.views[1].offsetPx-=e.width/2+100,r.featureData=a;var c=h.getSnapshot(e.tracks);r.views[0].tracks=c,r.views[1].tracks=p?c.slice().reverse():c,t.addView("BreakpointSplitView",r),i()},variant:"contained",color:"primary",autoFocus:!0},"OK"),r.createElement(S.Button,{onClick:function(){i()},color:"secondary",variant:"contained",autoFocus:!0},"Cancel")))}var pe=O.observer(fe);function de(e){var n=G(t.useState({}),2),i=n[0],a=n[1],o=G(t.useState(!1),2),c=o[0],u=o[1],s=e.feature.samples,l=Object.entries(void 0===s?{}:s);if(!l.length)return null;var f,p=["sample"].concat(W(Object.keys(l[0][1]))).map((function(e){return{field:e}})),d=[],h=Object.keys(i);try{d=l.map((function(e){return A(A({},Object.fromEntries(Object.entries(e[1]).map((function(e){return[e[0],String(e[1])]})))),{},{sample:e[0],id:e[0]})})).filter((function(e){return!h.length||h.every((function(t){var r=i[t];return!r||e[t].match(new RegExp(r,"i"))}))}))}catch(e){f=e}return r.createElement(E.BaseCard,Object.assign({},e,{title:"Samples"}),f?r.createElement(S.Typography,{color:"error"},"".concat(f)):null,r.createElement(S.FormControlLabel,{control:r.createElement(S.Checkbox,{checked:c,onChange:function(){return u((function(e){return!e}))}}),label:"Show sample filters"}),c?r.createElement(r.Fragment,null,r.createElement(S.Typography,null,"These filters can use a plain text search or regex style query, e.g. in the genotype field, entering 1 will query for all genotypes that include the first alternate allele e.g. 0|1 or 1|1, entering [1-9]\\d* will find any non-zero allele e.g. 0|2 or 2/33"),p.map((function(e){var t=e.field;return r.createElement(S.TextField,{key:"filter-".concat(t),placeholder:"Filter ".concat(t),value:i[t]||"",onChange:function(e){return a(A(A({},i),{},N({},t,e.target.value)))}})}))):null,r.createElement("div",{style:{height:600,width:"100%",overflow:"auto"}},r.createElement(C.DataGrid,{rows:d,columns:p,rowHeight:20,headerHeight:25,disableSelectionOnClick:!0,disableColumnMenu:!0})))}function he(e){var n,i=e.model,a=e.locStrings,o=e.feature,c=d.getSession(i),u=h.getEnv(c).pluginManager,s=G(t.useState(!1),2),l=s[0],f=s[1];try{n=u.getViewType("BreakpointSplitView")}catch(e){}var p=new x(o);return r.createElement(E.BaseCard,Object.assign({},e,{title:"Breakends"}),r.createElement(S.Typography,null,"Link to linear view of breakend endpoints"),r.createElement("ul",null,a.map((function(e,t){return r.createElement("li",{key:"".concat(JSON.stringify(e),"-").concat(t)},r.createElement(S.Link,{href:"#",onClick:function(){var t,r=i.view;r?null===(t=r.navToLocString)||void 0===t||t.call(r,e):c.notify("No view associated with this feature detail panel anymore","warning")}},"LGV - ".concat(e)))}))),n?r.createElement(r.Fragment,null,r.createElement(S.Typography,null,"Launch split views with breakend source and target"),r.createElement("ul",null,a.map((function(e,t){return r.createElement("li",{key:"".concat(JSON.stringify(e),"-").concat(t)},r.createElement(S.Link,{href:"#",onClick:function(){f(!0)}},"".concat(o.refName,":").concat(o.start," // ").concat(e," (split view)")))}))),l?r.createElement(pe,{model:i,feature:p,viewType:n,handleClose:function(){f(!1)}}):null):null)}function ye(e){var t,n=e.model,i=n.descriptions,a=JSON.parse(JSON.stringify(n.featureData)),o=function(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r,n,i={},a=Object.keys(e);for(n=0;n<a.length;n++)t.indexOf(r=a[n])>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)t.indexOf(r=a[n])>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}(a,["samples"]);return r.createElement(S.Paper,{"data-testid":"variant-side-drawer"},r.createElement(E.FeatureDetails,Object.assign({feature:A(A({},o),{},{ALT:null===(t=o.ALT)||void 0===t?void 0:t.map((function(e){return function(e){if("string"==typeof e)return e;var t="left"===e.MateDirection?"]":"[";return"left"===e.Join?"".concat(t).concat(e.MatePosition).concat(t).concat(e.Replacement):"".concat(e.Replacement).concat(t).concat(e.MatePosition).concat(t)}(e)}))}),descriptions:A(A({},{CHROM:"chromosome: An identifier from the reference genome",POS:"position: The reference position, with the 1st base having position 1",ID:"identifier: Semi-colon separated list of unique identifiers where available",REF:"reference base(s): Each base must be one of A,C,G,T,N (case insensitive).",ALT:" alternate base(s): Comma-separated list of alternate non-reference alleles",QUAL:"quality: Phred-scaled quality score for the assertion made in ALT",FILTER:"filter status: PASS if this position has passed all filters, otherwise a semicolon-separated list of codes for filters that fail"}),i)},e)),r.createElement(S.Divider,null),"breakend"===a.type?r.createElement(he,{feature:a,locStrings:a.ALT.map((function(e){return e.MatePosition})),model:n}):null,"translocation"===a.type?r.createElement(he,{feature:a,model:n,locStrings:["".concat(a.INFO.CHR2[0],":").concat(a.INFO.END)]}):null,r.createElement(de,Object.assign({feature:a},e)))}var ge={__proto__:null,default:O.observer(ye)};exports.VcfFeature=ie,exports.default=ae;
//# sourceMappingURL=plugin-variants.cjs.production.min.js.map
