"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("@jbrowse/core/pluggableElementTypes/AdapterType")),r=e(require("@jbrowse/core/Plugin")),n=require("@jbrowse/core/configuration"),o=require("mobx-state-tree"),a=require("@gmod/bbi"),i=e(require("@gmod/bed")),u=require("@jbrowse/core/data_adapters/BaseAdapter"),c=require("@jbrowse/core/util/io"),s=require("@jbrowse/core/util/rxjs"),l=e(require("@jbrowse/core/util/simpleFeature")),f=require("rxjs/operators"),p=require("@gmod/tabix");function d(e,t,r,n,o,a,i){try{var u=e[a](i),c=u.value}catch(e){return void r(e)}u.done?t(c):Promise.resolve(c).then(n,o)}function h(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){d(a,n,o,i,u,"next",e)}function u(e){d(a,n,o,i,u,"throw",e)}i(void 0)}))}}function v(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function y(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function g(e,t,r){return t&&y(e.prototype,t),r&&y(e,r),e}function m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function b(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function w(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?b(Object(r),!0).forEach((function(t){m(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):b(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function x(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function O(e){return(O=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function k(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)t.indexOf(r=a[n])>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)t.indexOf(r=a[n])>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}function j(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function S(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var o=O(this).constructor;r=Reflect.construct(n,arguments,o)}else r=n.apply(this,arguments);return j(this,r)}}var _=n.ConfigurationSchema("BigBedAdapter",{bigBedLocation:{type:"fileLocation",defaultValue:{uri:"/path/to/my.bb"}}},{explicitlyTyped:!0}),L=n.ConfigurationSchema("BedTabixAdapter",{bedGzLocation:{type:"fileLocation",defaultValue:{uri:"/path/to/my.bed.gz"}},index:n.ConfigurationSchema("TabixIndex",{indexType:{model:o.types.enumeration("IndexType",["TBI","CSI"]),type:"stringEnum",defaultValue:"TBI"},location:{type:"fileLocation",defaultValue:{uri:"/path/to/my.bed.gz.tbi"}}}),columnNames:{type:"stringArray",description:"List of column names",defaultValue:[]},scoreColumn:{type:"string",description:'The column to use as a "score" attribute',defaultValue:""},autoSql:{type:"string",description:"The autoSql definition for the data fields in the file",defaultValue:""}},{explicitlyTyped:!0}),E=function(e){x(o,r);var n=S(o);function o(){var e;return v(this,o),(e=n.apply(this,arguments)).name="BedPlugin",e}return g(o,[{key:"install",value:function(e){e.addAdapterType((function(){return new t({name:"BigBedAdapter",configSchema:_,getAdapterClass:function(){return Promise.resolve().then((function(){return q})).then((function(e){return e.default}))}})})),e.addAdapterType((function(){return new t({name:"BedTabixAdapter",configSchema:L,getAdapterClass:function(){return Promise.resolve().then((function(){return I})).then((function(e){return e.default}))}})}))}}]),o}();function P(e,t){return e(t={exports:{}},t.exports),t.exports}var T=P((function(e){var t=function(e){var t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",a=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var o=Object.create((t&&t.prototype instanceof f?t:f).prototype),a=new k(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(o,a){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===o)throw a;return{value:void 0,done:!0}}for(r.method=o,r.arg=a;;){var i=r.delegate;if(i){var u=w(i,r);if(u){if(u===l)continue;return u}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=s(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,a),o}function s(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function d(){}var h={};h[o]=function(){return this};var v=Object.getPrototypeOf,y=v&&v(v(j([])));y&&y!==t&&r.call(y,o)&&(h=y);var g=d.prototype=f.prototype=Object.create(h);function m(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){var n;this._invoke=function(o,a){function i(){return new t((function(n,i){!function n(o,a,i,u){var c=s(e[o],e,a);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==typeof f&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,i,u)}),(function(e){n("throw",e,i,u)})):t.resolve(f).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,u)}))}u(c.arg)}(o,a,n,i)}))}return n=n?n.then(i,i):i()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=s(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var o=n.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function x(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function k(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(x,this),this.reset(!0)}function j(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:S}}function S(){return{value:void 0,done:!0}}return p.prototype=g.constructor=d,d.constructor=p,p.displayName=u(d,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,u(e,i,"GeneratorFunction")),e.prototype=Object.create(g),e},e.awrap=function(e){return{__await:e}},m(b.prototype),b.prototype[a]=function(){return this},e.AsyncIterator=b,e.async=function(t,r,n,o,a){void 0===a&&(a=Promise);var i=new b(c(t,r,n,o),a);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},m(g),u(g,i,"Generator"),g[o]=function(){return this},g.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=j,k.prototype={constructor:k,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],i=a.completion;if("root"===a.tryLoc)return n("end");if(a.tryLoc<=this.prev){var u=r.call(a,"catchLoc"),c=r.call(a,"finallyLoc");if(u&&c){if(this.prev<a.catchLoc)return n(a.catchLoc,!0);if(this.prev<a.finallyLoc)return n(a.finallyLoc)}else if(u){if(this.prev<a.catchLoc)return n(a.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return n(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;O(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:j(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}}));function C(e){var t=e.children(),r=e.get("thickStart"),n=e.get("thickEnd");if(!r&&!n)return e;var o=t?t.filter((function(e){return"block"===e.get("type")})).sort((function(e,t){return e.get("start")-t.get("start")})):[],a=[];o.forEach((function(t){var o=t.get("start"),i=t.get("end");if(r>=i){var u=e.get("strand")>0?"five":"three";a.push({type:"".concat(u,"_prime_UTR"),start:o,end:i})}else if(r>o&&r<i&&n>=i){var c=e.get("strand")>0?"five":"three";a.push({type:"".concat(c,"_prime_UTR"),start:o,end:r},{type:"CDS",start:r,end:i})}else if(r<=o&&n>=i)a.push({type:"CDS",start:o,end:i});else if(r>o&&r<i&&n<i){var s=e.get("strand")>0?"five":"three",l=e.get("strand")>0?"three":"five";a.push({type:"".concat(s,"_prime_UTR"),start:o,end:r},{type:"CDS",start:r,end:n},{type:"".concat(l,"_prime_UTR"),start:n,end:i})}else if(r<=o&&n>o&&n<i){var f=e.get("strand")>0?"three":"five";a.push({type:"CDS",start:o,end:n},{type:"".concat(f,"_prime_UTR"),start:n,end:i})}else if(n<=o){var p=e.get("strand")>0?"three":"five";a.push({type:"".concat(p,"_prime_UTR"),start:o,end:i})}}));var i={};return e.tags().forEach((function(t){i[t]=e.get(t)})),i.subfeatures=a,i.type="mRNA",i.uniqueId=e.id(),delete i.chromStarts,delete i.chromStart,delete i.chromEnd,delete i.chrom,delete i.blockStarts,delete i.blockSizes,delete i.blockCount,delete i.thickStart,delete i.thickEnd,new l({data:i,id:e.id()})}var q={__proto__:null,default:function(e){x(d,u.BaseFeatureDataAdapter);var t,r,o,p=S(d);function d(e){var t;v(this,d),t=p.call(this,e);var r=n.readConfObject(e,"bigBedLocation");return t.bigbed=new a.BigBed({filehandle:c.openLocation(r)}),t.parser=t.bigbed.getHeader().then((function(e){return new i({autoSql:e.autoSql})})),t}return g(d,[{key:"getRefNames",value:(o=h(T.mark((function e(){return T.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=Object,e.next=3,this.bigbed.getHeader();case 3:return e.t1=e.sent.refsByName,e.abrupt("return",e.t0.keys.call(e.t0,e.t1));case 5:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"getHeader",value:(r=h(T.mark((function e(t){var r,n,o,a,i,u,c;return T.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.bigbed.getHeader(t);case 2:return n=(r=e.sent).version,o=r.fileType,e.next=7,this.parser;case 7:return i=(a=e.sent.autoSql).fields,u=k(a,["fields"]),c=Object.fromEntries(i.map((function(e){return[e.name,e.comment]}))),e.abrupt("return",{version:n,fileType:o,autoSql:w({},u),fields:c});case 12:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"refIdToName",value:(t=h(T.mark((function e(t){return T.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.bigbed.getHeader();case 2:if(e.t1=t,e.t0=e.sent.refsByNumber[e.t1],e.t0){e.next=6;break}e.t0={};case 6:return e.abrupt("return",e.t0.name);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"getFeatures",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e.refName,o=e.start,a=e.end,i=r.signal;return s.ObservableCreate(function(){var e=h(T.mark((function e(r){var u;return T.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.parser;case 3:return u=e.sent,e.next=6,t.bigbed.getFeatureStream(n,o,a,{signal:i,basesPerSpan:a-o});case 6:e.sent.pipe(f.mergeAll(),f.map((function(e){var r=u.parseLine("".concat(n,"\t").concat(e.start,"\t").concat(e.end,"\t").concat(e.rest),{uniqueId:e.uniqueId}),o=r.blockCount;if(o){var a=r.chromStarts||r.blockStarts||[],i=r.blockSizes,c=e.start;r.subfeatures=[];for(var s=0;s<o;s+=1){var f=(a[s]||0)+c,p=f+(i[s]||0);r.subfeatures.push({uniqueId:"".concat(e.uniqueId,"-").concat(s),start:f,end:p,type:"block"})}}if(void 0===e.uniqueId)throw new Error("invalid bbi feature");delete r.chromStart,delete r.chromEnd,delete r.chrom;var d=new l({id:"".concat(t.id,"-").concat(e.uniqueId),data:w(w({},r),{},{start:e.start,end:e.end,refName:n})});return d.get("thickStart")&&d.get("blockCount")&&0!==d.get("strand")?C(d):d}))).subscribe(r),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),r.error(e.t0);case 13:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t){return e.apply(this,arguments)}}(),r.signal)}},{key:"freeResources",value:function(){}}]),d}()},N=function(e){x(f,u.BaseFeatureDataAdapter);var t,r,o,a=S(f);function f(e){var t;v(this,f),t=a.call(this,e);var r=n.readConfObject(e,"bedGzLocation"),o=n.readConfObject(e,"index"),u=n.readConfObject(e,"autoSql"),s=o.location,l=o.indexType;return t.bed=new p.TabixIndexedFile({filehandle:c.openLocation(r),csiFilehandle:"CSI"===l?c.openLocation(s):void 0,tbiFilehandle:"CSI"!==l?c.openLocation(s):void 0,chunkCacheSize:50*Math.pow(2,20)}),t.columnNames=n.readConfObject(e,"columnNames"),t.scoreColumn=n.readConfObject(e,"scoreColumn"),t.parser=new i({autoSql:u}),t}return g(f,[{key:"getRefNames",value:(o=h(T.mark((function e(){var t=arguments;return T.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.bed.getReferenceSequenceNames(t.length>0&&void 0!==t[0]?t[0]:{}));case 2:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"getHeader",value:(r=h(T.mark((function e(){return T.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.bed.getHeader());case 1:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"defaultParser",value:function(e,t){return Object.fromEntries(t.split("\t").map((function(t,r){return[e[r],t]})))}},{key:"getNames",value:(t=h(T.mark((function e(){var t,r;return T.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.columnNames.length){e.next=2;break}return e.abrupt("return",this.columnNames);case 2:return e.next=4,this.bed.getHeader();case 4:return t=e.sent.split("\n").filter((function(e){return!!e})),e.abrupt("return",(r=t[t.length-1])&&r.includes("\t")?r.slice(1).split("\t").map((function(e){return e.trim()})):null);case 8:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"getFeatures",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return s.ObservableCreate(function(){var n=h(T.mark((function n(o){var a,i,u,c,s,f;return T.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.bed.getMetadata();case 2:return i=(a=n.sent.columnNumbers).ref-1,s=(u=a.start-1)==(c=a.end-1)?1:0,n.next=10,t.getNames();case 10:return f=n.sent,n.next=13,t.bed.getLines(e.refName,e.start,e.end,{lineCallback:function(e,r){var n=e.split("\t"),a=n[i],p=+n[u],d=+n[c]+s,h="".concat(t.id,"-").concat(r),v=f?t.defaultParser(f,e):t.parser.parseLine(e,{uniqueId:h}),y=v.blockCount;if(y){var g=v.chromStarts||v.blockStarts||[],m=v.blockSizes,b=p;v.subfeatures=[];for(var x=0;x<y;x+=1){var O=(g[x]||0)+b,k=O+(m[x]||0);v.subfeatures.push({uniqueId:"".concat(h,"-").concat(x),start:O,end:k,type:"block"})}}t.scoreColumn&&(v.score=v[t.scoreColumn]),delete v.chrom,delete v.chromStart,delete v.chromEnd;var j=new l(w(w({},v),{},{start:p,end:d,refName:a,uniqueId:h})),S=j.get("thickStart")?C(j):j;o.next(S)},signal:r.signal});case 13:o.complete();case 14:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),r.signal)}},{key:"freeResources",value:function(){}}]),f}();N.capabilities=["getFeatures","getRefNames"];var I={__proto__:null,default:N};exports.default=E;
//# sourceMappingURL=plugin-bed.cjs.production.min.js.map
