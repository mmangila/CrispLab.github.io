"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _get2 = _interopRequireDefault(require("@babel/runtime/helpers/get"));var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _wrapNativeSuper2 = _interopRequireDefault(require("@babel/runtime/helpers/wrapNativeSuper"));function _createSuper(Derived) {return function () {var Super = (0, _getPrototypeOf2.default)(Derived),result;if (_isNativeReflectConstruct()) {var NewTarget = (0, _getPrototypeOf2.default)(this).constructor;result = Reflect.construct(Super, arguments, NewTarget);} else {result = Super.apply(this, arguments);}return (0, _possibleConstructorReturn2.default)(this, result);};}function _isNativeReflectConstruct() {if (typeof Reflect === "undefined" || !Reflect.construct) return false;if (Reflect.construct.sham) return false;if (typeof Proxy === "function") return true;try {Date.prototype.toString.call(Reflect.construct(Date, [], function () {}));return true;} catch (e) {return false;}}require('./trimStartEndPolyfills');

/**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Class representing an ra file stanza. Each stanza line is split into its key
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * and value and stored as a Map, so the usual Map methods can be used on the
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * stanza. An additional method `add()` is available to take a raw line of text
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * and break it up into a key and value and add them to the class. This should
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * be favored over `set()` when possible, as it performs more validity checks
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * than using `set()`.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * @extends Map
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * @property {undefined|string} nameKey - The key of the first line of the
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * stanza (`undefined` if the stanza has no lines yet).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * @property {undefined|string} name - The value of the first line of the
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * stanza, by which it is identified in an ra file  (`undefined` if the stanza
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * has no lines yet).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * @property {undefined|string} indent - The leading indent of the stanza,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * which is the same for every line (`undefined` if the stanza has no lines
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * yet, `''` if there is no indent).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * @throws {Error} Throws if the stanza has blank lines, if the first line
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * doesn't have both a key and a value, if a key in the stanza is
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * duplicated, or if lines in the stanza have inconsistent indentation.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * @param {(string|string[])} [stanza=[]] - An ra file stanza, either as a
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * string or a array of strings with one line per entry. Supports both LF and
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * CRLF line terminators.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * @param {object} options
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * @param {boolean} options.checkIndent [true] - Check if a stanza is indented
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * consistently and keep track of the indentation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       */var
RaStanza = /*#__PURE__*/function (_Map) {(0, _inherits2.default)(RaStanza, _Map);var _super = _createSuper(RaStanza);
  function RaStanza(stanza) {var _this;var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : { checkIndent: true };(0, _classCallCheck2.default)(this, RaStanza);
    _this = _super.call(this);var
    checkIndent = options.checkIndent;
    _this._checkIndent = checkIndent;
    var stanzaLines;
    if (typeof stanza === 'string') {
      stanzaLines = stanza.trimEnd().split(/\r?\n/);
    } else if (!stanza) {
      stanzaLines = [];
    } else {
      stanzaLines = stanza;
    }
    _this._keyAndCommentOrder = [];
    stanzaLines.forEach(function (line) {
      _this.add(line);
    });return _this;
  }

  /**
     * Add a single line to the stanza. If the exact line already exists, does
     * nothing.
     * @param {string} line A stanza line
     * @returns {RaStanza} The RaStanza object
     */(0, _createClass2.default)(RaStanza, [{ key: "add", value: function add(
    line) {
      if (line === '') throw new Error('Invalid stanza, contained blank lines');
      if (line.trim().startsWith('#')) {
        this._keyAndCommentOrder.push(line.trim());
        return this;
      }
      if (line.trimEnd().endsWith('\\')) {
        var _trimmedLine = line.trimEnd().slice(0, -1);
        if (this._continuedLine) this._continuedLine += _trimmedLine.trimStart();else
        this._continuedLine = _trimmedLine;
        return this;
      }
      var combinedLine = line;
      if (this._continuedLine) {
        combinedLine = this._continuedLine + combinedLine.trimStart();
        this._continuedLine = undefined;
      }
      if (this.indent || this._checkIndent) {
        var indent = combinedLine.match(/^([ \t]+)/);
        if (this.indent === undefined) {
          if (indent) {var _indent = (0, _slicedToArray2.default)(indent, 2);this.indent = _indent[1];} else
          this.indent = '';
        } else if (
        this.indent === '' && indent !== null ||
        this.indent && this.indent !== indent[1])
        {
          throw new Error('Inconsistent indentation of stanza');
        }
      } else {
        this.indent = '';
      }
      var trimmedLine = combinedLine.trim();
      var sep = trimmedLine.indexOf(' ');
      if (sep === -1) {
        if (!this.nameKey)
        throw new Error(
        'First line in a stanza must have both a key and a value');

        // Adding a key that already exists and has no value is a no-op
        if (this.has(trimmedLine)) return this;
        this._keyAndCommentOrder.push(trimmedLine);
        return (0, _get2.default)((0, _getPrototypeOf2.default)(RaStanza.prototype), "set", this).call(this, trimmedLine, '');
      }
      var key = trimmedLine.slice(0, sep);
      var value = trimmedLine.slice(sep + 1);
      if (this.has(key) && value !== this.get(key))
      throw new Error(
      'Got duplicate key with a different value in stanza: ' + "\"".concat(
      key, "\" key has both ").concat(this.get(key), " and ").concat(value));

      this._keyAndCommentOrder.push(key);
      if (!this.nameKey) {
        this.nameKey = key;
        this.name = trimmedLine.slice(sep + 1);
      }
      return (0, _get2.default)((0, _getPrototypeOf2.default)(RaStanza.prototype), "set", this).call(this, key, value);
    }

    /**
       * Use `add()` if possible instead of this method. If using this, be aware
       * that no checks are made for comments, indentation, duplicate keys, etc.
       * @param {string} key The key of the stanza line
       * @param {string} value The value of the stanza line
       * @returns {RaStanza} The RaStanza object
       */ }, { key: "set", value: function set(
    key, value) {
      if (!(typeof value === 'string'))
      throw new Error("Value of ".concat(key, " must be a string, got ").concat((0, _typeof2.default)(value)));
      return (0, _get2.default)((0, _getPrototypeOf2.default)(RaStanza.prototype), "set", this).call(this, key, value);
    }

    /**
       * Delete a line
       * @param {string} key The key of the line to delete
       * @returns {boolean} true if the deleted line existed, false if it did not
       */ }, { key: "delete", value: function _delete(
    key) {
      if (key === this.nameKey)
      throw new Error(
      'Cannot delete the first line in a stanza (you can still overwrite it with set()).');

      if (this._keyAndCommentOrder.includes(key))
      this._keyAndCommentOrder = this._keyAndCommentOrder.filter(
      function (value) {return value !== key;});

      return (0, _get2.default)((0, _getPrototypeOf2.default)(RaStanza.prototype), "delete", this).call(this, key);
    }

    /**
       * Clear all lines and comments
       */ }, { key: "clear", value: function clear()
    {
      this._keyAndCommentOrder.length = 0;
      this._continuedLine = undefined;
      this.indent = undefined;
      this.name = undefined;
      this.nameKey = undefined;
      (0, _get2.default)((0, _getPrototypeOf2.default)(RaStanza.prototype), "clear", this).call(this);
    }

    /**
       * @returns {string} Returns the stanza as a string fit for writing to a ra
       * file. Original leading indent is preserved. It may not be the same as the
       * input stanza as lines that were joined with `\` in the input will be output
       * as a single line and all comments will have the same indentations as the
       * rest of the stanza. Comments between joined lines will move before that
       * line.
       */ }, { key: "toString", value: function toString()
    {var _this2 = this;
      if (this.size === 0) return '';
      var lines = [];
      this._keyAndCommentOrder.forEach(function (entry) {
        if (entry.startsWith('#')) lines.push("".concat(_this2.indent).concat(entry));else
        lines.push("".concat(_this2.indent).concat(entry, " ").concat(_this2.get(entry)).trimEnd());
      });
      return "".concat(lines.join('\n'), "\n");
    } }]);return RaStanza;}( /*#__PURE__*/(0, _wrapNativeSuper2.default)(Map));


module.exports = RaStanza;