"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _get2 = _interopRequireDefault(require("@babel/runtime/helpers/get"));var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _wrapNativeSuper2 = _interopRequireDefault(require("@babel/runtime/helpers/wrapNativeSuper"));function _createSuper(Derived) {return function () {var Super = (0, _getPrototypeOf2.default)(Derived),result;if (_isNativeReflectConstruct()) {var NewTarget = (0, _getPrototypeOf2.default)(this).constructor;result = Reflect.construct(Super, arguments, NewTarget);} else {result = Super.apply(this, arguments);}return (0, _possibleConstructorReturn2.default)(this, result);};}function _isNativeReflectConstruct() {if (typeof Reflect === "undefined" || !Reflect.construct) return false;if (Reflect.construct.sham) return false;if (typeof Proxy === "function") return true;try {Date.prototype.toString.call(Reflect.construct(Date, [], function () {}));return true;} catch (e) {return false;}}var RaStanza = require('./raStanza');

/**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * Class representing an ra file. Each file is composed of multiple stanzas, and
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * each stanza is separated by one or more blank lines. Each stanza is stored in
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * a Map with the key being the value of the first key-value pair in the stanza.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * The usual Map methods can be used on the file. An additional method `add()`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * is available to take a raw line of text and break it up into a key and value
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * and add them to the class. This should be favored over `set()` when possible,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * as it performs more validity checks than using `set()`.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * @extends Map
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * @property {undefined|string} nameKey - The key of the first line of all the
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * stanzas (`undefined` if the stanza has no lines yet).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * @throws {Error} Throws if an empty stanza is added, if the key in the first
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * key-value pair of each stanze isn't the same, or if two stanzas have the same
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * value for the key-value pair in their first lines.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * @param {(string|string[])} [raFile=[]] - An ra file, either as a single
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * string or an array of strings with one stanza per entry. Supports both LF
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * and CRLF line terminators.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * @param {object} options
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * @param {boolean} options.checkIndent [true] - Check if a the stanzas within
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * the file are indented consistently and keep track of the indentation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           */var
RaFile = /*#__PURE__*/function (_Map) {(0, _inherits2.default)(RaFile, _Map);var _super = _createSuper(RaFile);
  function RaFile(raFile) {var _this;var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : { checkIndent: true };(0, _classCallCheck2.default)(this, RaFile);
    _this = _super.call(this);var
    checkIndent = options.checkIndent;
    _this._checkIndent = checkIndent;
    var stanzas;
    if (typeof raFile === 'string') {
      stanzas = raFile.trimEnd().split(/(?:[\t ]*\r?\n){2,}/);
    } else if (!raFile) {
      stanzas = [];
    } else {
      stanzas = raFile;
    }
    _this._stanzaAndCommentOrder = [];
    stanzas.forEach(function (stanza) {
      _this.add(stanza);
    });return _this;
  }

  /**
     * Add a single stanza to the file
     * @param {string} stanza A single stanza
     * @returns {RaFile} The RaFile object
     */(0, _createClass2.default)(RaFile, [{ key: "add", value: function add(
    stanza) {
      if (stanza === '') throw new Error('Invalid stanza, was empty');
      if (stanza.trim().startsWith('#')) {
        var stanzaLines = stanza.
        trimEnd().
        split(/\r?\n/).
        map(function (line) {return line.trim();});
        if (stanzaLines.every(function (line) {return line.startsWith('#');})) {
          this._stanzaAndCommentOrder.push(stanzaLines.join('\n'));
          return this;
        }
      }
      var raStanza = new RaStanza(stanza, { checkIndent: this._checkIndent });
      if (!this.nameKey) this.nameKey = raStanza.nameKey;else
      if (raStanza.nameKey !== this.nameKey)
      throw new Error(
      'The first line in each stanza must have the same key. ' + "Saw both ".concat(
      this.nameKey, " and ").concat(raStanza.nameKey));

      if (this.has(raStanza.name))
      throw new Error("Got duplicate stanza name: ".concat(raStanza.name));
      this._stanzaAndCommentOrder.push(raStanza.name);
      return (0, _get2.default)((0, _getPrototypeOf2.default)(RaFile.prototype), "set", this).call(this, raStanza.name, raStanza);
    }

    /**
       * Use `add()` if possible instead of this method. If using this, be aware
       * that no checks are made for comments, empty stanzas, duplicate keys, etc.
       * @param {string} key The key of the RaFile stanza
       * @param {RaStanza} value The RaFile stanza used to replace the prior one
       */ }, { key: "update", value: function update(
    key, value) {
      if (!(value instanceof RaStanza))
      throw new Error("Value of ".concat(key, " is not an RaStanza"));
      (0, _get2.default)((0, _getPrototypeOf2.default)(RaFile.prototype), "set", this).call(this, key, value);
    }

    /**
       * Delete a stanza
       * @param {string} stanza The name of the stanza to delete (the value in its
       * first key-value pair)
       * @returns {boolean} true if the deleted stanza existed, false if it did not
       */ }, { key: "delete", value: function _delete(
    stanza) {
      if (this._stanzaAndCommentOrder.includes(stanza))
      this._stanzaAndCommentOrder = this._stanzaAndCommentOrder.filter(
      function (value) {return value !== stanza;});

      return (0, _get2.default)((0, _getPrototypeOf2.default)(RaFile.prototype), "delete", this).call(this, stanza);
    }

    /**
       * Clear all stanzas and comments
       */ }, { key: "clear", value: function clear()
    {
      this._stanzaAndCommentOrder.length = 0;
      this.nameKey = undefined;
      (0, _get2.default)((0, _getPrototypeOf2.default)(RaFile.prototype), "clear", this).call(this);
    }

    /**
       * @returns {string} Returns the stanza as a string fit for writing to a ra
       * file. Original leading indent is preserved. It may not be the same as the
       * input stanza as lines that were joined with `\` in the input will be output
       *  as a single line and all comments will have the same indentations as the
       * rest of the stanza. Comments between joined lines will move before that
       * line.
       */ }, { key: "toString", value: function toString()
    {var _this2 = this;
      if (this.size === 0) return '';
      var stanzas = [];
      this._stanzaAndCommentOrder.forEach(function (entry) {
        if (entry.startsWith('#')) stanzas.push("".concat(entry, "\n"));else
        stanzas.push(_this2.get(entry).toString());
      });
      return stanzas.join('\n');
    } }]);return RaFile;}( /*#__PURE__*/(0, _wrapNativeSuper2.default)(Map));


module.exports = RaFile;