"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.BlockView = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _binaryParser = require("@gmod/binary-parser");

var _abortablePromiseCache = _interopRequireDefault(require("abortable-promise-cache"));

var _zlib = _interopRequireDefault(require("zlib"));

var _quickLru = _interopRequireDefault(require("quick-lru"));

var _range = _interopRequireDefault(require("./range"));

var _util = require("./util");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var BIG_WIG_TYPE_GRAPH = 1;
var BIG_WIG_TYPE_VSTEP = 2;
var BIG_WIG_TYPE_FSTEP = 3;

function getParsers(isBigEndian) {
  var _choices;

  var le = isBigEndian ? 'big' : 'little';
  var summaryParser = new _binaryParser.Parser().endianess(le).uint32('chromId').uint32('start').uint32('end').uint32('validCnt').float('minScore').float('maxScore').float('sumData').float('sumSqData');
  var leafParser = new _binaryParser.Parser().endianess(le).uint8('isLeaf').skip(1).uint16('cnt').choice({
    tag: 'isLeaf',
    choices: {
      1: new _binaryParser.Parser().array('blocksToFetch', {
        length: 'cnt',
        type: new _binaryParser.Parser().uint32('startChrom').uint32('startBase').uint32('endChrom').uint32('endBase').uint64('blockOffset').uint64('blockSize')
      }),
      0: new _binaryParser.Parser().array('recurOffsets', {
        length: 'cnt',
        type: new _binaryParser.Parser().uint32('startChrom').uint32('startBase').uint32('endChrom').uint32('endBase').uint64('blockOffset')
      })
    }
  });
  var bigBedParser = new _binaryParser.Parser().endianess(le).uint32('chromId').int32('start').int32('end').string('rest', {
    zeroTerminated: true
  });
  var bigWigParser = new _binaryParser.Parser().endianess(le).skip(4).int32('blockStart').skip(4).uint32('itemStep').uint32('itemSpan').uint8('blockType').skip(1).uint16('itemCount').choice({
    tag: 'blockType',
    choices: (_choices = {}, (0, _defineProperty2.default)(_choices, BIG_WIG_TYPE_FSTEP, new _binaryParser.Parser().array('items', {
      length: 'itemCount',
      type: new _binaryParser.Parser().float('score')
    })), (0, _defineProperty2.default)(_choices, BIG_WIG_TYPE_VSTEP, new _binaryParser.Parser().array('items', {
      length: 'itemCount',
      type: new _binaryParser.Parser().int32('start').float('score')
    })), (0, _defineProperty2.default)(_choices, BIG_WIG_TYPE_GRAPH, new _binaryParser.Parser().array('items', {
      length: 'itemCount',
      type: new _binaryParser.Parser().int32('start').int32('end').float('score')
    })), _choices)
  });
  return {
    bigWigParser: bigWigParser,
    bigBedParser: bigBedParser,
    summaryParser: summaryParser,
    leafParser: leafParser
  };
}
/**
 * View into a subset of the data in a BigWig file.
 *
 * Adapted by Robert Buels and Colin Diesh from bigwig.js in the Dalliance Genome
 * Explorer by Thomas Down.
 * @constructs
 */


var BlockView = /*#__PURE__*/function () {
  function BlockView(bbi, refsByName, cirTreeOffset, cirTreeLength, isBigEndian, isCompressed, blockType) {
    var _this = this;

    (0, _classCallCheck2.default)(this, BlockView);
    (0, _defineProperty2.default)(this, "cirTreeOffset", void 0);
    (0, _defineProperty2.default)(this, "cirTreeLength", void 0);
    (0, _defineProperty2.default)(this, "bbi", void 0);
    (0, _defineProperty2.default)(this, "isCompressed", void 0);
    (0, _defineProperty2.default)(this, "isBigEndian", void 0);
    (0, _defineProperty2.default)(this, "refsByName", void 0);
    (0, _defineProperty2.default)(this, "blockType", void 0);
    (0, _defineProperty2.default)(this, "cirTreePromise", void 0);
    (0, _defineProperty2.default)(this, "featureCache", new _abortablePromiseCache.default({
      cache: new _quickLru.default({
        maxSize: 1000
      }),
      fill: function () {
        var _fill = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee(requestData, signal) {
          var length, offset, _yield$_this$bbi$read, buffer;

          return _regenerator.default.wrap(function _callee$(_context) {
            while (1) {
              switch (_context.prev = _context.next) {
                case 0:
                  length = requestData.length, offset = requestData.offset;
                  _context.next = 3;
                  return _this.bbi.read(Buffer.alloc(length), 0, length, offset, {
                    signal: signal
                  });

                case 3:
                  _yield$_this$bbi$read = _context.sent;
                  buffer = _yield$_this$bbi$read.buffer;
                  return _context.abrupt("return", buffer);

                case 6:
                case "end":
                  return _context.stop();
              }
            }
          }, _callee);
        }));

        function fill(_x, _x2) {
          return _fill.apply(this, arguments);
        }

        return fill;
      }()
    }));
    (0, _defineProperty2.default)(this, "leafParser", void 0);
    (0, _defineProperty2.default)(this, "bigWigParser", void 0);
    (0, _defineProperty2.default)(this, "bigBedParser", void 0);
    (0, _defineProperty2.default)(this, "summaryParser", void 0);
    if (!(cirTreeOffset >= 0)) throw new Error('invalid cirTreeOffset!');
    if (!(cirTreeLength > 0)) throw new Error('invalid cirTreeLength!');
    this.cirTreeOffset = cirTreeOffset;
    this.cirTreeLength = cirTreeLength;
    this.isCompressed = isCompressed;
    this.refsByName = refsByName;
    this.isBigEndian = isBigEndian;
    this.bbi = bbi;
    this.blockType = blockType;
    Object.assign(this, getParsers(isBigEndian));
  }

  (0, _createClass2.default)(BlockView, [{
    key: "readWigData",
    value: function () {
      var _readWigData = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee3(chrName, start, end, observer, opts) {
        var _this2 = this;

        var refsByName, bbi, cirTreeOffset, isBigEndian, signal, chrId, request, _yield$this$cirTreePr, buffer, cirBlockSize, blocksToFetch, outstanding, cirFobRecur2, filterFeats, cirFobStartFetch, cirFobRecur;

        return _regenerator.default.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                _context3.prev = 0;
                refsByName = this.refsByName, bbi = this.bbi, cirTreeOffset = this.cirTreeOffset, isBigEndian = this.isBigEndian;
                signal = opts.signal;
                chrId = refsByName[chrName];

                if (chrId === undefined) {
                  observer.complete();
                }

                request = {
                  chrId: chrId,
                  start: start,
                  end: end
                };

                if (!this.cirTreePromise) {
                  this.cirTreePromise = bbi.read(Buffer.alloc(48), 0, 48, cirTreeOffset, {
                    signal: signal
                  });
                }

                _context3.next = 9;
                return this.cirTreePromise;

              case 9:
                _yield$this$cirTreePr = _context3.sent;
                buffer = _yield$this$cirTreePr.buffer;
                cirBlockSize = isBigEndian ? buffer.readUInt32BE(4) : buffer.readUInt32LE(4);
                blocksToFetch = [];
                outstanding = 0; //eslint-disable-next-line prefer-const

                filterFeats = function filterFeats(b) {
                  return (b.startChrom < chrId || b.startChrom === chrId && b.startBase <= end) && (b.endChrom > chrId || b.endChrom === chrId && b.endBase >= start);
                };

                cirFobStartFetch = /*#__PURE__*/function () {
                  var _ref = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee2(off, fr, level) {
                    var length, offset, resultBuffer, i;
                    return _regenerator.default.wrap(function _callee2$(_context2) {
                      while (1) {
                        switch (_context2.prev = _context2.next) {
                          case 0:
                            _context2.prev = 0;
                            length = fr.max() - fr.min();
                            offset = fr.min();
                            _context2.next = 5;
                            return _this2.featureCache.get("".concat(length, "_").concat(offset), {
                              length: length,
                              offset: offset
                            }, signal);

                          case 5:
                            resultBuffer = _context2.sent;

                            for (i = 0; i < off.length; i += 1) {
                              if (fr.contains(off[i])) {
                                cirFobRecur2(resultBuffer, off[i] - offset, level, observer, opts);
                                outstanding -= 1;

                                if (outstanding === 0) {
                                  _this2.readFeatures(observer, blocksToFetch, _objectSpread(_objectSpread({}, opts), {}, {
                                    request: request
                                  }));
                                }
                              }
                            }

                            _context2.next = 12;
                            break;

                          case 9:
                            _context2.prev = 9;
                            _context2.t0 = _context2["catch"](0);
                            observer.error(_context2.t0);

                          case 12:
                          case "end":
                            return _context2.stop();
                        }
                      }
                    }, _callee2, null, [[0, 9]]);
                  }));

                  return function cirFobStartFetch(_x8, _x9, _x10) {
                    return _ref.apply(this, arguments);
                  };
                }();

                cirFobRecur = function cirFobRecur(offset, level) {
                  try {
                    outstanding += offset.length;
                    var maxCirBlockSpan = 4 + cirBlockSize * 32; // Upper bound on size, based on a completely full leaf node.

                    var spans = new _range.default(offset[0], offset[0] + maxCirBlockSpan);

                    for (var i = 1; i < offset.length; i += 1) {
                      var blockSpan = new _range.default(offset[i], offset[i] + maxCirBlockSpan);
                      spans = spans.union(blockSpan);
                    }

                    spans.getRanges().map(function (fr) {
                      return cirFobStartFetch(offset, fr, level);
                    });
                  } catch (e) {
                    observer.error(e);
                  }
                };

                cirFobRecur2 = function cirFobRecur2(cirBlockData, offset, level) {
                  try {
                    var data = cirBlockData.slice(offset);

                    var p = _this2.leafParser.parse(data).result;

                    if (p.blocksToFetch) {
                      blocksToFetch = blocksToFetch.concat(p.blocksToFetch.filter(filterFeats).map(function (l) {
                        return {
                          offset: l.blockOffset,
                          length: l.blockSize
                        };
                      }));
                    }

                    if (p.recurOffsets) {
                      var recurOffsets = p.recurOffsets.filter(filterFeats).map(function (l) {
                        return l.blockOffset;
                      });

                      if (recurOffsets.length > 0) {
                        cirFobRecur(recurOffsets, level + 1);
                      }
                    }
                  } catch (e) {
                    observer.error(e);
                  }
                };

                return _context3.abrupt("return", cirFobRecur([cirTreeOffset + 48], 1));

              case 21:
                _context3.prev = 21;
                _context3.t0 = _context3["catch"](0);
                observer.error(_context3.t0);

              case 24:
              case "end":
                return _context3.stop();
            }
          }
        }, _callee3, this, [[0, 21]]);
      }));

      function readWigData(_x3, _x4, _x5, _x6, _x7) {
        return _readWigData.apply(this, arguments);
      }

      return readWigData;
    }()
  }, {
    key: "parseSummaryBlock",
    value: function parseSummaryBlock(data, startOffset, request) {
      var features = [];
      var currOffset = startOffset;

      while (currOffset < data.byteLength) {
        var res = this.summaryParser.parse(data.slice(currOffset));
        features.push(res.result);
        currOffset += res.offset;
      }

      var items = features;
      if (request) items = items.filter(function (elt) {
        return elt.chromId === request.chrId;
      });
      items = items.map(function (elt) {
        return {
          start: elt.start,
          end: elt.end,
          maxScore: elt.maxScore,
          minScore: elt.minScore,
          score: elt.sumData / (elt.validCnt || 1),
          summary: true
        };
      });
      return request ? items.filter(function (f) {
        return BlockView.coordFilter(f, request);
      }) : items;
    }
  }, {
    key: "parseBigBedBlock",
    value: function parseBigBedBlock(data, startOffset, offset, request) {
      var items = [];
      var currOffset = startOffset;

      while (currOffset < data.byteLength) {
        var res = this.bigBedParser.parse(data.slice(currOffset));
        res.result.uniqueId = "bb-".concat(offset + currOffset);
        items.push(res.result);
        currOffset += res.offset;
      }

      return request ? items.filter(function (f) {
        return BlockView.coordFilter(f, request);
      }) : items;
    }
  }, {
    key: "parseBigWigBlock",
    value: function parseBigWigBlock(bytes, startOffset, request) {
      var data = bytes.slice(startOffset);
      var results = this.bigWigParser.parse(data).result;
      var items = results.items,
          itemSpan = results.itemSpan,
          itemStep = results.itemStep,
          blockStart = results.blockStart,
          blockType = results.blockType;

      if (blockType === BIG_WIG_TYPE_FSTEP) {
        for (var i = 0; i < items.length; i++) {
          items[i].start = blockStart + i * itemStep;
          items[i].end = blockStart + i * itemStep + itemSpan;
        }
      } else if (blockType === BIG_WIG_TYPE_VSTEP) {
        for (var _i = 0; _i < items.length; _i++) {
          items[_i].end = items[_i].start + itemSpan;
        }
      }

      return request ? items.filter(function (f) {
        return BlockView.coordFilter(f, request);
      }) : items;
    }
  }, {
    key: "readFeatures",
    value: function () {
      var _readFeatures = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee5(observer, blocks) {
        var _this3 = this;

        var opts,
            blockType,
            isCompressed,
            signal,
            request,
            blockGroupsToFetch,
            _args5 = arguments;
        return _regenerator.default.wrap(function _callee5$(_context5) {
          while (1) {
            switch (_context5.prev = _context5.next) {
              case 0:
                opts = _args5.length > 2 && _args5[2] !== undefined ? _args5[2] : {};
                _context5.prev = 1;
                blockType = this.blockType, isCompressed = this.isCompressed;
                signal = opts.signal, request = opts.request;
                blockGroupsToFetch = (0, _util.groupBlocks)(blocks);
                (0, _util.checkAbortSignal)(signal);
                _context5.next = 8;
                return Promise.all(blockGroupsToFetch.map( /*#__PURE__*/function () {
                  var _ref2 = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee4(blockGroup) {
                    var length, offset, data;
                    return _regenerator.default.wrap(function _callee4$(_context4) {
                      while (1) {
                        switch (_context4.prev = _context4.next) {
                          case 0:
                            (0, _util.checkAbortSignal)(signal);
                            length = blockGroup.length, offset = blockGroup.offset;
                            _context4.next = 4;
                            return _this3.featureCache.get("".concat(length, "_").concat(offset), blockGroup, signal);

                          case 4:
                            data = _context4.sent;
                            blockGroup.blocks.forEach(function (block) {
                              (0, _util.checkAbortSignal)(signal);
                              var blockOffset = block.offset - blockGroup.offset;
                              var resultData = data;

                              if (isCompressed) {
                                resultData = _zlib.default.inflateSync(data.slice(blockOffset));
                                blockOffset = 0;
                              }

                              (0, _util.checkAbortSignal)(signal);

                              switch (blockType) {
                                case 'summary':
                                  observer.next(_this3.parseSummaryBlock(resultData, blockOffset, request));
                                  break;

                                case 'bigwig':
                                  observer.next(_this3.parseBigWigBlock(resultData, blockOffset, request));
                                  break;

                                case 'bigbed':
                                  observer.next( // eslint-disable-next-line no-bitwise
                                  _this3.parseBigBedBlock(resultData, blockOffset, block.offset * (1 << 8), request));
                                  break;

                                default:
                                  console.warn("Don't know what to do with ".concat(blockType));
                              }
                            });

                          case 6:
                          case "end":
                            return _context4.stop();
                        }
                      }
                    }, _callee4);
                  }));

                  return function (_x13) {
                    return _ref2.apply(this, arguments);
                  };
                }()));

              case 8:
                observer.complete();
                _context5.next = 14;
                break;

              case 11:
                _context5.prev = 11;
                _context5.t0 = _context5["catch"](1);
                observer.error(_context5.t0);

              case 14:
              case "end":
                return _context5.stop();
            }
          }
        }, _callee5, this, [[1, 11]]);
      }));

      function readFeatures(_x11, _x12) {
        return _readFeatures.apply(this, arguments);
      }

      return readFeatures;
    }()
  }], [{
    key: "coordFilter",
    value: function coordFilter(f, range) {
      return f.start < range.end && f.end >= range.start;
    }
  }]);
  return BlockView;
}();

exports.BlockView = BlockView;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9ibG9ja1ZpZXcudHMiXSwibmFtZXMiOlsiQklHX1dJR19UWVBFX0dSQVBIIiwiQklHX1dJR19UWVBFX1ZTVEVQIiwiQklHX1dJR19UWVBFX0ZTVEVQIiwiZ2V0UGFyc2VycyIsImlzQmlnRW5kaWFuIiwibGUiLCJzdW1tYXJ5UGFyc2VyIiwiUGFyc2VyIiwiZW5kaWFuZXNzIiwidWludDMyIiwiZmxvYXQiLCJsZWFmUGFyc2VyIiwidWludDgiLCJza2lwIiwidWludDE2IiwiY2hvaWNlIiwidGFnIiwiY2hvaWNlcyIsImFycmF5IiwibGVuZ3RoIiwidHlwZSIsInVpbnQ2NCIsImJpZ0JlZFBhcnNlciIsImludDMyIiwic3RyaW5nIiwiemVyb1Rlcm1pbmF0ZWQiLCJiaWdXaWdQYXJzZXIiLCJCbG9ja1ZpZXciLCJiYmkiLCJyZWZzQnlOYW1lIiwiY2lyVHJlZU9mZnNldCIsImNpclRyZWVMZW5ndGgiLCJpc0NvbXByZXNzZWQiLCJibG9ja1R5cGUiLCJBYm9ydGFibGVQcm9taXNlQ2FjaGUiLCJjYWNoZSIsIlF1aWNrTFJVIiwibWF4U2l6ZSIsImZpbGwiLCJyZXF1ZXN0RGF0YSIsInNpZ25hbCIsIm9mZnNldCIsInJlYWQiLCJCdWZmZXIiLCJhbGxvYyIsImJ1ZmZlciIsIkVycm9yIiwiT2JqZWN0IiwiYXNzaWduIiwiY2hyTmFtZSIsInN0YXJ0IiwiZW5kIiwib2JzZXJ2ZXIiLCJvcHRzIiwiY2hySWQiLCJ1bmRlZmluZWQiLCJjb21wbGV0ZSIsInJlcXVlc3QiLCJjaXJUcmVlUHJvbWlzZSIsImNpckJsb2NrU2l6ZSIsInJlYWRVSW50MzJCRSIsInJlYWRVSW50MzJMRSIsImJsb2Nrc1RvRmV0Y2giLCJvdXRzdGFuZGluZyIsImZpbHRlckZlYXRzIiwiYiIsInN0YXJ0Q2hyb20iLCJzdGFydEJhc2UiLCJlbmRDaHJvbSIsImVuZEJhc2UiLCJjaXJGb2JTdGFydEZldGNoIiwib2ZmIiwiZnIiLCJsZXZlbCIsIm1heCIsIm1pbiIsImZlYXR1cmVDYWNoZSIsImdldCIsInJlc3VsdEJ1ZmZlciIsImkiLCJjb250YWlucyIsImNpckZvYlJlY3VyMiIsInJlYWRGZWF0dXJlcyIsImVycm9yIiwiY2lyRm9iUmVjdXIiLCJtYXhDaXJCbG9ja1NwYW4iLCJzcGFucyIsIlJhbmdlIiwiYmxvY2tTcGFuIiwidW5pb24iLCJnZXRSYW5nZXMiLCJtYXAiLCJlIiwiY2lyQmxvY2tEYXRhIiwiZGF0YSIsInNsaWNlIiwicCIsInBhcnNlIiwicmVzdWx0IiwiY29uY2F0IiwiZmlsdGVyIiwibCIsImJsb2NrT2Zmc2V0IiwiYmxvY2tTaXplIiwicmVjdXJPZmZzZXRzIiwic3RhcnRPZmZzZXQiLCJmZWF0dXJlcyIsImN1cnJPZmZzZXQiLCJieXRlTGVuZ3RoIiwicmVzIiwicHVzaCIsIml0ZW1zIiwiZWx0IiwiY2hyb21JZCIsIm1heFNjb3JlIiwibWluU2NvcmUiLCJzY29yZSIsInN1bURhdGEiLCJ2YWxpZENudCIsInN1bW1hcnkiLCJmIiwiY29vcmRGaWx0ZXIiLCJ1bmlxdWVJZCIsImJ5dGVzIiwicmVzdWx0cyIsIml0ZW1TcGFuIiwiaXRlbVN0ZXAiLCJibG9ja1N0YXJ0IiwiYmxvY2tzIiwiYmxvY2tHcm91cHNUb0ZldGNoIiwiUHJvbWlzZSIsImFsbCIsImJsb2NrR3JvdXAiLCJmb3JFYWNoIiwiYmxvY2siLCJyZXN1bHREYXRhIiwiemxpYiIsImluZmxhdGVTeW5jIiwibmV4dCIsInBhcnNlU3VtbWFyeUJsb2NrIiwicGFyc2VCaWdXaWdCbG9jayIsInBhcnNlQmlnQmVkQmxvY2siLCJjb25zb2xlIiwid2FybiIsInJhbmdlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7Ozs7OztBQXNDQSxJQUFNQSxrQkFBa0IsR0FBRyxDQUEzQjtBQUNBLElBQU1DLGtCQUFrQixHQUFHLENBQTNCO0FBQ0EsSUFBTUMsa0JBQWtCLEdBQUcsQ0FBM0I7O0FBRUEsU0FBU0MsVUFBVCxDQUFv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InNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCBuby1iaXR3aXNlOiBbXCJlcnJvclwiLCB7IFwiYWxsb3dcIjogW1wifFwiXSB9XSAqL1xuaW1wb3J0IHsgT2JzZXJ2ZXIgfSBmcm9tICdyeGpzJ1xuaW1wb3J0IHsgUGFyc2VyIH0gZnJvbSAnQGdtb2QvYmluYXJ5LXBhcnNlcidcbmltcG9ydCBBYm9ydGFibGVQcm9taXNlQ2FjaGUgZnJvbSAnYWJvcnRhYmxlLXByb21pc2UtY2FjaGUnXG5pbXBvcnQgeyBHZW5lcmljRmlsZWhhbmRsZSB9IGZyb20gJ2dlbmVyaWMtZmlsZWhhbmRsZSdcbmltcG9ydCB6bGliIGZyb20gJ3psaWInXG5pbXBvcnQgUXVpY2tMUlUgZnJvbSAncXVpY2stbHJ1J1xuaW1wb3J0IHsgRmVhdHVyZSB9IGZyb20gJy4vYmJpJ1xuaW1wb3J0IFJhbmdlIGZyb20gJy4vcmFuZ2UnXG5pbXBvcnQgeyBncm91cEJsb2NrcywgY2hlY2tBYm9ydFNpZ25hbCB9IGZyb20gJy4vdXRpbCdcblxuaW50ZXJmYWNlIENvb3JkUmVxdWVzdCB7XG4gIGNocklkOiBudW1iZXJcbiAgc3RhcnQ6IG51bWJlclxuICBlbmQ6IG51bWJlclxufVxuaW50ZXJmYWNlIERhdGFCbG9jayB7XG4gIHN0YXJ0Q2hyb206IG51bWJlclxuICBlbmRDaHJvbTogbnVtYmVyXG4gIHN0YXJ0QmFzZTogbnVtYmVyXG4gIGVuZEJhc2U6IG51bWJlclxuICB2YWxpZENudDogbnVtYmVyXG4gIG1pblZhbDogbnVtYmVyXG4gIG1heFZhbDogbnVtYmVyXG4gIHN1bURhdGE6IG51bWJlclxuICBzdW1TcURhdGE6IG51bWJlclxufVxuaW50ZXJmYWNlIFJlYWREYXRhIHtcbiAgb2Zmc2V0OiBudW1iZXJcbiAgbGVuZ3RoOiBudW1iZXJcbn1cblxuaW50ZXJmYWNlIFN1bW1hcnlCbG9jayB7XG4gIGNocm9tSWQ6IG51bWJlclxuICBzdGFydDogbnVtYmVyXG4gIGVuZDogbnVtYmVyXG4gIHZhbGlkQ250OiBudW1iZXJcbiAgbWluU2NvcmU6IG51bWJlclxuICBtYXhTY29yZTogbnVtYmVyXG4gIHN1bURhdGE6IG51bWJlclxuICBzdW1TcURhdGE6IG51bWJlclxufVxuaW50ZXJmYWNlIE9wdGlvbnMge1xuICBzaWduYWw/OiBBYm9ydFNpZ25hbFxuICByZXF1ZXN0PzogQ29vcmRSZXF1ZXN0XG59XG5cbmNvbnN0IEJJR19XSUdfVFlQRV9HUkFQSCA9IDFcbmNvbnN0IEJJR19XSUdfVFlQRV9WU1RFUCA9IDJcbmNvbnN0IEJJR19XSUdfVFlQRV9GU1RFUCA9IDNcblxuZnVuY3Rpb24gZ2V0UGFyc2Vycyhpc0JpZ0VuZGlhbjogYm9vbGVhbik6IGFueSB7XG4gIGNvbnN0IGxlID0gaXNCaWdFbmRpYW4gPyAnYmlnJyA6ICdsaXR0bGUnXG4gIGNvbnN0IHN1bW1hcnlQYXJzZXIgPSBuZXcgUGFyc2VyKClcbiAgICAuZW5kaWFuZXNzKGxlKVxuICAgIC51aW50MzIoJ2Nocm9tSWQnKVxuICAgIC51aW50MzIoJ3N0YXJ0JylcbiAgICAudWludDMyKCdlbmQnKVxuICAgIC51aW50MzIoJ3ZhbGlkQ250JylcbiAgICAuZmxvYXQoJ21pblNjb3JlJylcbiAgICAuZmxvYXQoJ21heFNjb3JlJylcbiAgICAuZmxvYXQoJ3N1bURhdGEnKVxuICAgIC5mbG9hdCgnc3VtU3FEYXRhJylcblxuICBjb25zdCBsZWFmUGFyc2VyID0gbmV3IFBhcnNlcigpXG4gICAgLmVuZGlhbmVzcyhsZSlcbiAgICAudWludDgoJ2lzTGVhZicpXG4gICAgLnNraXAoMSlcbiAgICAudWludDE2KCdjbnQnKVxuICAgIC5jaG9pY2Uoe1xuICAgICAgdGFnOiAnaXNMZWFmJyxcbiAgICAgIGNob2ljZXM6IHtcbiAgICAgICAgMTogbmV3IFBhcnNlcigpLmFycmF5KCdibG9ja3NUb0ZldGNoJywge1xuICAgICAgICAgIGxlbmd0aDogJ2NudCcsXG4gICAgICAgICAgdHlwZTogbmV3IFBhcnNlcigpXG4gICAgICAgICAgICAudWludDMyKCdzdGFydENocm9tJylcbiAgICAgICAgICAgIC51aW50MzIoJ3N0YXJ0QmFzZScpXG4gICAgICAgICAgICAudWludDMyKCdlbmRDaHJvbScpXG4gICAgICAgICAgICAudWludDMyKCdlbmRCYXNlJylcbiAgICAgICAgICAgIC51aW50NjQoJ2Jsb2NrT2Zmc2V0JylcbiAgICAgICAgICAgIC51aW50NjQoJ2Jsb2NrU2l6ZScpLFxuICAgICAgICB9KSxcbiAgICAgICAgMDogbmV3IFBhcnNlcigpLmFycmF5KCdyZWN1ck9mZnNldHMnLCB7XG4gICAgICAgICAgbGVuZ3RoOiAnY250JyxcbiAgICAgICAgICB0eXBlOiBuZXcgUGFyc2VyKClcbiAgICAgICAgICAgIC51aW50MzIoJ3N0YXJ0Q2hyb20nKVxuICAgICAgICAgICAgLnVpbnQzMignc3RhcnRCYXNlJylcbiAgICAgICAgICAgIC51aW50MzIoJ2VuZENocm9tJylcbiAgICAgICAgICAgIC51aW50MzIoJ2VuZEJhc2UnKVxuICAgICAgICAgICAgLnVpbnQ2NCgnYmxvY2tPZmZzZXQnKSxcbiAgICAgICAgfSksXG4gICAgICB9LFxuICAgIH0pXG4gIGNvbnN0IGJpZ0JlZFBhcnNlciA9IG5ldyBQYXJzZXIoKVxuICAgIC5lbmRpYW5lc3MobGUpXG4gICAgLnVpbnQzMignY2hyb21JZCcpXG4gICAgLmludDMyKCdzdGFydCcpXG4gICAgLmludDMyKCdlbmQnKVxuICAgIC5zdHJpbmcoJ3Jlc3QnLCB7XG4gICAgICB6ZXJvVGVybWluYXRlZDogdHJ1ZSxcbiAgICB9KVxuXG4gIGNvbnN0IGJpZ1dpZ1BhcnNlciA9IG5ldyBQYXJzZXIoKVxuICAgIC5lbmRpYW5lc3MobGUpXG4gICAgLnNraXAoNClcbiAgICAuaW50MzIoJ2Jsb2NrU3RhcnQnKVxuICAgIC5za2lwKDQpXG4gICAgLnVpbnQzMignaXRlbVN0ZXAnKVxuICAgIC51aW50MzIoJ2l0ZW1TcGFuJylcbiAgICAudWludDgoJ2Jsb2NrVHlwZScpXG4gICAgLnNraXAoMSlcbiAgICAudWludDE2KCdpdGVtQ291bnQnKVxuICAgIC5jaG9pY2Uoe1xuICAgICAgdGFnOiAnYmxvY2tUeXBlJyxcbiAgICAgIGNob2ljZXM6IHtcbiAgICAgICAgW0JJR19XSUdfVFlQRV9GU1RFUF06IG5ldyBQYXJzZXIoKS5hcnJheSgnaXRlbXMnLCB7XG4gICAgICAgICAgbGVuZ3RoOiAnaXRlbUNvdW50JyxcbiAgICAgICAgICB0eXBlOiBuZXcgUGFyc2VyKCkuZmxvYXQoJ3Njb3JlJyksXG4gICAgICAgIH0pLFxuICAgICAgICBbQklHX1dJR19UWVBFX1ZTVEVQXTogbmV3IFBhcnNlcigpLmFycmF5KCdpdGVtcycsIHtcbiAgICAgICAgICBsZW5ndGg6ICdpdGVtQ291bnQnLFxuICAgICAgICAgIHR5cGU6IG5ldyBQYXJzZXIoKS5pbnQzMignc3RhcnQnKS5mbG9hdCgnc2NvcmUnKSxcbiAgICAgICAgfSksXG4gICAgICAgIFtCSUdfV0lHX1RZUEVfR1JBUEhdOiBuZXcgUGFyc2VyKCkuYXJyYXkoJ2l0ZW1zJywge1xuICAgICAgICAgIGxlbmd0aDogJ2l0ZW1Db3VudCcsXG4gICAgICAgICAgdHlwZTogbmV3IFBhcnNlcigpXG4gICAgICAgICAgICAuaW50MzIoJ3N0YXJ0JylcbiAgICAgICAgICAgIC5pbnQzMignZW5kJylcbiAgICAgICAgICAgIC5mbG9hdCgnc2NvcmUnKSxcbiAgICAgICAgfSksXG4gICAgICB9LFxuICAgIH0pXG4gIHJldHVybiB7XG4gICAgYmlnV2lnUGFyc2VyLFxuICAgIGJpZ0JlZFBhcnNlcixcbiAgICBzdW1tYXJ5UGFyc2VyLFxuICAgIGxlYWZQYXJzZXIsXG4gIH1cbn1cblxuLyoqXG4gKiBWaWV3IGludG8gYSBzdWJzZXQgb2YgdGhlIGRhdGEgaW4gYSBCaWdXaWcgZmlsZS5cbiAqXG4gKiBBZGFwdGVkIGJ5IFJvYmVydCBCdWVscyBhbmQgQ29saW4gRGllc2ggZnJvbSBiaWd3aWcuanMgaW4gdGhlIERhbGxpYW5jZSBHZW5vbWVcbiAqIEV4cGxvcmVyIGJ5IFRob21hcyBEb3duLlxuICogQGNvbnN0cnVjdHNcbiAqL1xuXG5leHBvcnQgY2xhc3MgQmxvY2tWaWV3IHtcbiAgcHJpdmF0ZSBjaXJUcmVlT2Zmc2V0OiBudW1iZXJcblxuICBwcml2YXRlIGNpclRyZWVMZW5ndGg6IG51bWJlclxuXG4gIHByaXZhdGUgYmJpOiBHZW5lcmljRmlsZWhhbmRsZVxuXG4gIHByaXZhdGUgaXNDb21wcmVzc2VkOiBib29sZWFuXG5cbiAgcHJpdmF0ZSBpc0JpZ0VuZGlhbjogYm9vbGVhblxuXG4gIHByaXZhdGUgcmVmc0J5TmFtZTogYW55XG5cbiAgcHJpdmF0ZSBibG9ja1R5cGU6IHN0cmluZ1xuXG4gIHByaXZhdGUgY2lyVHJlZVByb21pc2U/OiBQcm9taXNlPHsgYnl0ZXNSZWFkOiBudW1iZXI7IGJ1ZmZlcjogQnVmZmVyIH0+XG5cbiAgcHJpdmF0ZSBmZWF0dXJlQ2FjaGUgPSBuZXcgQWJvcnRhYmxlUHJvbWlzZUNhY2hlKHtcbiAgICBjYWNoZTogbmV3IFF1aWNrTFJVKHsgbWF4U2l6ZTogMTAwMCB9KSxcblxuICAgIGZpbGw6IGFzeW5jIChyZXF1ZXN0RGF0YTogUmVhZERhdGEsIHNpZ25hbDogQWJvcnRTaWduYWwpID0+IHtcbiAgICAgIGNvbnN0IHsgbGVuZ3RoLCBvZmZzZXQgfSA9IHJlcXVlc3REYXRhXG4gICAgICBjb25zdCB7IGJ1ZmZlciB9ID0gYXdhaXQgdGhpcy5iYmkucmVhZChCdWZmZXIuYWxsb2MobGVuZ3RoKSwgMCwgbGVuZ3RoLCBvZmZzZXQsIHsgc2lnbmFsIH0pXG4gICAgICByZXR1cm4gYnVmZmVyXG4gICAgfSxcbiAgfSlcblxuICBwcml2YXRlIGxlYWZQYXJzZXI6IGFueVxuXG4gIHByaXZhdGUgYmlnV2lnUGFyc2VyOiBhbnlcblxuICBwcml2YXRlIGJpZ0JlZFBhcnNlcjogYW55XG5cbiAgcHJpdmF0ZSBzdW1tYXJ5UGFyc2VyOiBhbnlcblxuICBwdWJsaWMgY29uc3RydWN0b3IoXG4gICAgYmJpOiBHZW5lcmljRmlsZWhhbmRsZSxcbiAgICByZWZzQnlOYW1lOiBhbnksXG4gICAgY2lyVHJlZU9mZnNldDogbnVtYmVyLFxuICAgIGNpclRyZWVMZW5ndGg6IG51bWJlcixcbiAgICBpc0JpZ0VuZGlhbjogYm9vbGVhbixcbiAgICBpc0NvbXByZXNzZWQ6IGJvb2xlYW4sXG4gICAgYmxvY2tUeXBlOiBzdHJpbmcsXG4gICkge1xuICAgIGlmICghKGNpclRyZWVPZmZzZXQgPj0gMCkpIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBjaXJUcmVlT2Zmc2V0IScpXG4gICAgaWYgKCEoY2lyVHJlZUxlbmd0aCA+IDApKSB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgY2lyVHJlZUxlbmd0aCEnKVxuXG4gICAgdGhpcy5jaXJUcmVlT2Zmc2V0ID0gY2lyVHJlZU9mZnNldFxuICAgIHRoaXMuY2lyVHJlZUxlbmd0aCA9IGNpclRyZWVMZW5ndGhcbiAgICB0aGlzLmlzQ29tcHJlc3NlZCA9IGlzQ29tcHJlc3NlZFxuICAgIHRoaXMucmVmc0J5TmFtZSA9IHJlZnNCeU5hbWVcbiAgICB0aGlzLmlzQmlnRW5kaWFuID0gaXNCaWdFbmRpYW5cbiAgICB0aGlzLmJiaSA9IGJiaVxuICAgIHRoaXMuYmxvY2tUeXBlID0gYmxvY2tUeXBlXG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLCBnZXRQYXJzZXJzKGlzQmlnRW5kaWFuKSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFkV2lnRGF0YShcbiAgICBjaHJOYW1lOiBzdHJpbmcsXG4gICAgc3RhcnQ6IG51bWJlcixcbiAgICBlbmQ6IG51bWJlcixcbiAgICBvYnNlcnZlcjogT2JzZXJ2ZXI8RmVhdHVyZVtdPixcbiAgICBvcHRzOiBPcHRpb25zLFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyByZWZzQnlOYW1lLCBiYmksIGNpclRyZWVPZmZzZXQsIGlzQmlnRW5kaWFuIH0gPSB0aGlzXG4gICAgICBjb25zdCB7IHNpZ25hbCB9ID0gb3B0c1xuICAgICAgY29uc3QgY2hySWQgPSByZWZzQnlOYW1lW2Nock5hbWVdXG4gICAgICBpZiAoY2hySWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpXG4gICAgICB9XG4gICAgICBjb25zdCByZXF1ZXN0ID0geyBjaHJJZCwgc3RhcnQsIGVuZCB9XG4gICAgICBpZiAoIXRoaXMuY2lyVHJlZVByb21pc2UpIHtcbiAgICAgICAgdGhpcy5jaXJUcmVlUHJvbWlzZSA9IGJiaS5yZWFkKEJ1ZmZlci5hbGxvYyg0OCksIDAsIDQ4LCBjaXJUcmVlT2Zmc2V0LCB7IHNpZ25hbCB9KVxuICAgICAgfVxuICAgICAgY29uc3QgeyBidWZmZXIgfSA9IGF3YWl0IHRoaXMuY2lyVHJlZVByb21pc2VcbiAgICAgIGNvbnN0IGNpckJsb2NrU2l6ZSA9IGlzQmlnRW5kaWFuID8gYnVmZmVyLnJlYWRVSW50MzJCRSg0KSA6IGJ1ZmZlci5yZWFkVUludDMyTEUoNClcbiAgICAgIGxldCBibG9ja3NUb0ZldGNoOiBhbnlbXSA9IFtdXG4gICAgICBsZXQgb3V0c3RhbmRpbmcgPSAwXG5cbiAgICAgIC8vZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci1jb25zdFxuICAgICAgbGV0IGNpckZvYlJlY3VyMjogRnVuY3Rpb25cblxuICAgICAgY29uc3QgZmlsdGVyRmVhdHMgPSAoYjogRGF0YUJsb2NrKTogYm9vbGVhbiA9PlxuICAgICAgICAoYi5zdGFydENocm9tIDwgY2hySWQgfHwgKGIuc3RhcnRDaHJvbSA9PT0gY2hySWQgJiYgYi5zdGFydEJhc2UgPD0gZW5kKSkgJiZcbiAgICAgICAgKGIuZW5kQ2hyb20gPiBjaHJJZCB8fCAoYi5lbmRDaHJvbSA9PT0gY2hySWQgJiYgYi5lbmRCYXNlID49IHN0YXJ0KSlcblxuICAgICAgY29uc3QgY2lyRm9iU3RhcnRGZXRjaCA9IGFzeW5jIChvZmY6IGFueSwgZnI6IGFueSwgbGV2ZWw6IG51bWJlcik6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGZyLm1heCgpIC0gZnIubWluKClcbiAgICAgICAgICBjb25zdCBvZmZzZXQgPSBmci5taW4oKVxuICAgICAgICAgIGNvbnN0IHJlc3VsdEJ1ZmZlciA9IGF3YWl0IHRoaXMuZmVhdHVyZUNhY2hlLmdldChcbiAgICAgICAgICAgIGAke2xlbmd0aH1fJHtvZmZzZXR9YCxcbiAgICAgICAgICAgIHsgbGVuZ3RoLCBvZmZzZXQgfSxcbiAgICAgICAgICAgIHNpZ25hbCxcbiAgICAgICAgICApXG4gICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvZmYubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGlmIChmci5jb250YWlucyhvZmZbaV0pKSB7XG4gICAgICAgICAgICAgIGNpckZvYlJlY3VyMihyZXN1bHRCdWZmZXIsIG9mZltpXSAtIG9mZnNldCwgbGV2ZWwsIG9ic2VydmVyLCBvcHRzKVxuICAgICAgICAgICAgICBvdXRzdGFuZGluZyAtPSAxXG4gICAgICAgICAgICAgIGlmIChvdXRzdGFuZGluZyA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHRoaXMucmVhZEZlYXR1cmVzKG9ic2VydmVyLCBibG9ja3NUb0ZldGNoLCB7IC4uLm9wdHMsIHJlcXVlc3QgfSlcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIG9ic2VydmVyLmVycm9yKGUpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNvbnN0IGNpckZvYlJlY3VyID0gKG9mZnNldDogYW55LCBsZXZlbDogbnVtYmVyKTogdm9pZCA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgb3V0c3RhbmRpbmcgKz0gb2Zmc2V0Lmxlbmd0aFxuXG4gICAgICAgICAgY29uc3QgbWF4Q2lyQmxvY2tTcGFuID0gNCArIGNpckJsb2NrU2l6ZSAqIDMyIC8vIFVwcGVyIGJvdW5kIG9uIHNpemUsIGJhc2VkIG9uIGEgY29tcGxldGVseSBmdWxsIGxlYWYgbm9kZS5cbiAgICAgICAgICBsZXQgc3BhbnMgPSBuZXcgUmFuZ2Uob2Zmc2V0WzBdLCBvZmZzZXRbMF0gKyBtYXhDaXJCbG9ja1NwYW4pXG4gICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBvZmZzZXQubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGNvbnN0IGJsb2NrU3BhbiA9IG5ldyBSYW5nZShvZmZzZXRbaV0sIG9mZnNldFtpXSArIG1heENpckJsb2NrU3BhbilcbiAgICAgICAgICAgIHNwYW5zID0gc3BhbnMudW5pb24oYmxvY2tTcGFuKVxuICAgICAgICAgIH1cbiAgICAgICAgICBzcGFucy5nZXRSYW5nZXMoKS5tYXAoKGZyOiBSYW5nZSkgPT4gY2lyRm9iU3RhcnRGZXRjaChvZmZzZXQsIGZyLCBsZXZlbCkpXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBvYnNlcnZlci5lcnJvcihlKVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNpckZvYlJlY3VyMiA9IChjaXJCbG9ja0RhdGE6IEJ1ZmZlciwgb2Zmc2V0OiBudW1iZXIsIGxldmVsOiBudW1iZXIpOiB2b2lkID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCBkYXRhID0gY2lyQmxvY2tEYXRhLnNsaWNlKG9mZnNldClcblxuICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLmxlYWZQYXJzZXIucGFyc2UoZGF0YSkucmVzdWx0XG4gICAgICAgICAgaWYgKHAuYmxvY2tzVG9GZXRjaCkge1xuICAgICAgICAgICAgYmxvY2tzVG9GZXRjaCA9IGJsb2Nrc1RvRmV0Y2guY29uY2F0KFxuICAgICAgICAgICAgICBwLmJsb2Nrc1RvRmV0Y2hcbiAgICAgICAgICAgICAgICAuZmlsdGVyKGZpbHRlckZlYXRzKVxuICAgICAgICAgICAgICAgIC5tYXAoKGw6IGFueSk6IGFueSA9PiAoeyBvZmZzZXQ6IGwuYmxvY2tPZmZzZXQsIGxlbmd0aDogbC5ibG9ja1NpemUgfSkpLFxuICAgICAgICAgICAgKVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocC5yZWN1ck9mZnNldHMpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlY3VyT2Zmc2V0cyA9IHAucmVjdXJPZmZzZXRzXG4gICAgICAgICAgICAgIC5maWx0ZXIoZmlsdGVyRmVhdHMpXG4gICAgICAgICAgICAgIC5tYXAoKGw6IGFueSk6IGFueSA9PiBsLmJsb2NrT2Zmc2V0KVxuICAgICAgICAgICAgaWYgKHJlY3VyT2Zmc2V0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgIGNpckZvYlJlY3VyKHJlY3VyT2Zmc2V0cywgbGV2ZWwgKyAxKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIG9ic2VydmVyLmVycm9yKGUpXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGNpckZvYlJlY3VyKFtjaXJUcmVlT2Zmc2V0ICsgNDhdLCAxKVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIG9ic2VydmVyLmVycm9yKGUpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZVN1bW1hcnlCbG9jayhkYXRhOiBCdWZmZXIsIHN0YXJ0T2Zmc2V0OiBudW1iZXIsIHJlcXVlc3Q/OiBDb29yZFJlcXVlc3QpOiBGZWF0dXJlW10ge1xuICAgIGNvbnN0IGZlYXR1cmVzID0gW11cbiAgICBsZXQgY3Vyck9mZnNldCA9IHN0YXJ0T2Zmc2V0XG4gICAgd2hpbGUgKGN1cnJPZmZzZXQgPCBkYXRhLmJ5dGVMZW5ndGgpIHtcbiAgICAgIGNvbnN0IHJlcyA9IHRoaXMuc3VtbWFyeVBhcnNlci5wYXJzZShkYXRhLnNsaWNlKGN1cnJPZmZzZXQpKVxuICAgICAgZmVhdHVyZXMucHVzaChyZXMucmVzdWx0KVxuICAgICAgY3Vyck9mZnNldCArPSByZXMub2Zmc2V0XG4gICAgfVxuICAgIGxldCBpdGVtcyA9IGZlYXR1cmVzXG4gICAgaWYgKHJlcXVlc3QpIGl0ZW1zID0gaXRlbXMuZmlsdGVyKChlbHQ6IFN1bW1hcnlCbG9jayk6IGJvb2xlYW4gPT4gZWx0LmNocm9tSWQgPT09IHJlcXVlc3QuY2hySWQpXG4gICAgaXRlbXMgPSBpdGVtcy5tYXAoXG4gICAgICAoZWx0OiBTdW1tYXJ5QmxvY2spOiBGZWF0dXJlID0+ICh7XG4gICAgICAgIHN0YXJ0OiBlbHQuc3RhcnQsXG4gICAgICAgIGVuZDogZWx0LmVuZCxcbiAgICAgICAgbWF4U2NvcmU6IGVsdC5tYXhTY29yZSxcbiAgICAgICAgbWluU2NvcmU6IGVsdC5taW5TY29yZSxcbiAgICAgICAgc2NvcmU6IGVsdC5zdW1EYXRhIC8gKGVsdC52YWxpZENudCB8fCAxKSxcbiAgICAgICAgc3VtbWFyeTogdHJ1ZSxcbiAgICAgIH0pLFxuICAgIClcbiAgICByZXR1cm4gcmVxdWVzdCA/IGl0ZW1zLmZpbHRlcihmID0+IEJsb2NrVmlldy5jb29yZEZpbHRlcihmLCByZXF1ZXN0KSkgOiBpdGVtc1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZUJpZ0JlZEJsb2NrKFxuICAgIGRhdGE6IEJ1ZmZlcixcbiAgICBzdGFydE9mZnNldDogbnVtYmVyLFxuICAgIG9mZnNldDogbnVtYmVyLFxuICAgIHJlcXVlc3Q/OiBDb29yZFJlcXVlc3QsXG4gICk6IEZlYXR1cmVbXSB7XG4gICAgY29uc3QgaXRlbXMgPSBbXVxuICAgIGxldCBjdXJyT2Zmc2V0ID0gc3RhcnRPZmZzZXRcbiAgICB3aGlsZSAoY3Vyck9mZnNldCA8IGRhdGEuYnl0ZUxlbmd0aCkge1xuICAgICAgY29uc3QgcmVzID0gdGhpcy5iaWdCZWRQYXJzZXIucGFyc2UoZGF0YS5zbGljZShjdXJyT2Zmc2V0KSlcbiAgICAgIHJlcy5yZXN1bHQudW5pcXVlSWQgPSBgYmItJHtvZmZzZXQgKyBjdXJyT2Zmc2V0fWBcbiAgICAgIGl0ZW1zLnB1c2gocmVzLnJlc3VsdClcbiAgICAgIGN1cnJPZmZzZXQgKz0gcmVzLm9mZnNldFxuICAgIH1cblxuICAgIHJldHVybiByZXF1ZXN0ID8gaXRlbXMuZmlsdGVyKChmOiBhbnkpID0+IEJsb2NrVmlldy5jb29yZEZpbHRlcihmLCByZXF1ZXN0KSkgOiBpdGVtc1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZUJpZ1dpZ0Jsb2NrKGJ5dGVzOiBCdWZmZXIsIHN0YXJ0T2Zmc2V0OiBudW1iZXIsIHJlcXVlc3Q/OiBDb29yZFJlcXVlc3QpOiBGZWF0dXJlW10ge1xuICAgIGNvbnN0IGRhdGEgPSBieXRlcy5zbGljZShzdGFydE9mZnNldClcbiAgICBjb25zdCByZXN1bHRzID0gdGhpcy5iaWdXaWdQYXJzZXIucGFyc2UoZGF0YSkucmVzdWx0XG4gICAgY29uc3QgeyBpdGVtcywgaXRlbVNwYW4sIGl0ZW1TdGVwLCBibG9ja1N0YXJ0LCBibG9ja1R5cGUgfSA9IHJlc3VsdHNcbiAgICBpZiAoYmxvY2tUeXBlID09PSBCSUdfV0lHX1RZUEVfRlNURVApIHtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaXRlbXNbaV0uc3RhcnQgPSBibG9ja1N0YXJ0ICsgaSAqIGl0ZW1TdGVwXG4gICAgICAgIGl0ZW1zW2ldLmVuZCA9IGJsb2NrU3RhcnQgKyBpICogaXRlbVN0ZXAgKyBpdGVtU3BhblxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoYmxvY2tUeXBlID09PSBCSUdfV0lHX1RZUEVfVlNURVApIHtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaXRlbXNbaV0uZW5kID0gaXRlbXNbaV0uc3RhcnQgKyBpdGVtU3BhblxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVxdWVzdCA/IGl0ZW1zLmZpbHRlcigoZjogYW55KSA9PiBCbG9ja1ZpZXcuY29vcmRGaWx0ZXIoZiwgcmVxdWVzdCkpIDogaXRlbXNcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGNvb3JkRmlsdGVyKGY6IEZlYXR1cmUsIHJhbmdlOiBDb29yZFJlcXVlc3QpOiBib29sZWFuIHtcbiAgICByZXR1cm4gZi5zdGFydCA8IHJhbmdlLmVuZCAmJiBmLmVuZCA+PSByYW5nZS5zdGFydFxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlYWRGZWF0dXJlcyhcbiAgICBvYnNlcnZlcjogT2JzZXJ2ZXI8RmVhdHVyZVtdPixcbiAgICBibG9ja3M6IGFueSxcbiAgICBvcHRzOiBPcHRpb25zID0ge30sXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGJsb2NrVHlwZSwgaXNDb21wcmVzc2VkIH0gPSB0aGlzXG4gICAgICBjb25zdCB7IHNpZ25hbCwgcmVxdWVzdCB9ID0gb3B0c1xuICAgICAgY29uc3QgYmxvY2tHcm91cHNUb0ZldGNoID0gZ3JvdXBCbG9ja3MoYmxvY2tzKVxuICAgICAgY2hlY2tBYm9ydFNpZ25hbChzaWduYWwpXG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgYmxvY2tHcm91cHNUb0ZldGNoLm1hcChhc3luYyAoYmxvY2tHcm91cDogYW55KSA9PiB7XG4gICAgICAgICAgY2hlY2tBYm9ydFNpZ25hbChzaWduYWwpXG4gICAgICAgICAgY29uc3QgeyBsZW5ndGgsIG9mZnNldCB9ID0gYmxvY2tHcm91cFxuICAgICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLmZlYXR1cmVDYWNoZS5nZXQoYCR7bGVuZ3RofV8ke29mZnNldH1gLCBibG9ja0dyb3VwLCBzaWduYWwpXG4gICAgICAgICAgYmxvY2tHcm91cC5ibG9ja3MuZm9yRWFjaCgoYmxvY2s6IGFueSkgPT4ge1xuICAgICAgICAgICAgY2hlY2tBYm9ydFNpZ25hbChzaWduYWwpXG4gICAgICAgICAgICBsZXQgYmxvY2tPZmZzZXQgPSBibG9jay5vZmZzZXQgLSBibG9ja0dyb3VwLm9mZnNldFxuICAgICAgICAgICAgbGV0IHJlc3VsdERhdGEgPSBkYXRhXG4gICAgICAgICAgICBpZiAoaXNDb21wcmVzc2VkKSB7XG4gICAgICAgICAgICAgIHJlc3VsdERhdGEgPSB6bGliLmluZmxhdGVTeW5jKGRhdGEuc2xpY2UoYmxvY2tPZmZzZXQpKVxuICAgICAgICAgICAgICBibG9ja09mZnNldCA9IDBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNoZWNrQWJvcnRTaWduYWwoc2lnbmFsKVxuXG4gICAgICAgICAgICBzd2l0Y2ggKGJsb2NrVHlwZSkge1xuICAgICAgICAgICAgICBjYXNlICdzdW1tYXJ5JzpcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHRoaXMucGFyc2VTdW1tYXJ5QmxvY2socmVzdWx0RGF0YSwgYmxvY2tPZmZzZXQsIHJlcXVlc3QpKVxuICAgICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICAgIGNhc2UgJ2JpZ3dpZyc6XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh0aGlzLnBhcnNlQmlnV2lnQmxvY2socmVzdWx0RGF0YSwgYmxvY2tPZmZzZXQsIHJlcXVlc3QpKVxuICAgICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICAgIGNhc2UgJ2JpZ2JlZCc6XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChcbiAgICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1iaXR3aXNlXG4gICAgICAgICAgICAgICAgICB0aGlzLnBhcnNlQmlnQmVkQmxvY2socmVzdWx0RGF0YSwgYmxvY2tPZmZzZXQsIGJsb2NrLm9mZnNldCAqICgxIDw8IDgpLCByZXF1ZXN0KSxcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYERvbid0IGtub3cgd2hhdCB0byBkbyB3aXRoICR7YmxvY2tUeXBlfWApXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfSksXG4gICAgICApXG4gICAgICBvYnNlcnZlci5jb21wbGV0ZSgpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgb2JzZXJ2ZXIuZXJyb3IoZSlcbiAgICB9XG4gIH1cbn1cbiJdfQ==